@using Microsoft.AspNetCore.Http
@model WebENG.Models.UserModel;
@{
    ViewData["Title"] = "Jobs";
}
<style>
    #table_job_file {
        cursor: pointer;
    }

    .multiselect {
        width: 300px;
    }

    .selectBox {
        position: relative;
    }

        .selectBox select {
            width: 100%;
            font-weight: bold;
        }

    .overSelect {
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
    }

    #checkboxes {
        display: none;
        border: 1px #dadada solid;
    }

        #checkboxes label {
            display: block;
        }

            #checkboxes label:hover {
                background-color: #1e90ff;
            }

    #checkcolumnboxes {
        display: none;
        border: 1px #dadada solid;
    }

        #checkcolumnboxes label {
            display: block;
        }

            #checkcolumnboxes label:hover {
                background-color: #1e90ff;
            }

    #table_payment {
        width: 100%;
        height: 400px;
    }

    .delete-icon {
        cursor: pointer;
        color: #d32f2f;
        font-size: 20px;
    }

        .delete-icon:hover {
            color: #b71c1c;
        }
            
</style>
<div class="row p-3">
    @if (Model.role == "Admin")
    {
        <div class="col-xl-1 pb-3">
            <button id="btn_create" type="button" class="btn btn-primary form-control elevation-1">
                <i class="fas fa-plus"></i> Create Job
            </button>
        </div>
        <div class="col-xl-2">
            <div class="multiselect">
                <div class="selectBox" onclick="showColumnCheckboxes()">
                    <select class="form-control">
                        <option>Select Department</option>
                    </select>
                    <div class="overSelect"></div>
                </div>
                <div id="checkcolumnboxes">
                </div>
            </div>
        </div>
    }
    <div class="col-xl-1 pb-3">
        @*<button id="btn_import" type="button" class="btn btn-primary form-control elevation-1" hidden>
                <i class="fas fa-upload"></i> Import
            </button>*@
    </div>
    <div class="col-xl-1 pb-3">
        @*<button id="btn_export" type="button" class="btn btn-warning form-control elevation-1" hidden>
                <i class="fas fa-download"></i> Export
            </button>*@
    </div>
    <div class="col-xl-12">
        <div class="card card-dark">
            <div class="card-header">
                <span class="card-title">Jobs</span>
                <div class="card-tools ml-auto">
                    <button id="btn_export" type="button" class="btn btn-warning form-control">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
            <div class="card-body" style="overflow-x:auto">
                <table id="table_job" class="table table-sm table-bordered table-hover text-center table-striped nowrap w-100">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Quotation</th>
                            <th>Customer</th>
                            <th>Status</th>
                            <th>End User</th>
                            <th>Sale Name</th>
                            <th>Department</th>
                            <th>Process</th>
                            <th>System</th>
                            <th>ENG Cost</th>
                            <th>CIS Cost</th>
                            <th>AIS Cost</th>
                            <th>MD</th>
                            <th>PD</th>
                            <th>FT</th>
                            <th>MP</th>
                            <th>Cost/MP</th>
                            <th>OT MP</th>
                            <th>C SAT.</th>
                            <th>GP</th>
                            <th>EST Cost</th>
                            <th>Total Cost</th>
                            <th>Remaining Cost</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                    <tfoot class="text-center">
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Quotation</th>
                            <th>Customer</th>
                            <th>Status</th>
                            <th>End User</th>
                            <th>Sale Name</th>
                            <th>Department</th>
                            <th>Process</th>
                            <th>System</th>
                            <th>Cost</th>
                            <th>MD</th>
                            <th>PD</th>
                            <th>FT</th>
                            <th>MP</th>
                            <th>Cost/MP</th>
                            <th>OT MP</th>
                            <th>C SAT.</th>
                            <th>GP</th>
                            <th>EST Cost</th>
                            <th>Total Cost</th>
                            <th>Remaining Cost</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal_job" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" style="overflow-y:auto">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="modal_title" class="modal-title"><b>Create Job</b></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="card" style="overflow-x:auto">
                        <div class="card-header" style="background-color:#42D5D8">
                            <span style="font-weight:bold">Job</span>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus" style="color:black"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="col-sm-6 col-md-4 col-xl-4 ">
                                    <label for="job_id">Job Number</label>
                                    <input id="job_id" type="text" class="form-control" placeholder="JYYXXXX" />
                                </div>
                                <div class="col-sm-6 col-md-8 col-xl-8">
                                    <label for="job_name">Job Name</label>
                                    <input id="job_name" type="text" class="form-control" placeholder="Job Name" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="col-sm-6 col-md-3 col-xl-3">
                                    <label for="job_date">Job Date</label>
                                    <input id="job_date" type="date" class="form-control" />
                                </div>
                                <div class="col-sm-6 col-md-2 col-xl-2">
                                    <label for="quotation_no">Quotation</label>
                                    <input id="quotation_no" type="text" class="form-control" placeholder="Quotation Number" list="quotations" />
                                    <datalist id="quotations"></datalist>
                                </div>
                                <div class="col-sm-6 col-md-2 col-xl-2">
                                    <label for="job_type">Job Type</label>
                                    <input id="job_type" type="text" class="form-control" placeholder="" />
                                </div>
                                <div class="col-sm-6 col-md-5 col-xl-5">
                                    <label for="job_customer">Customer</label>
                                    <input id="job_customer" type="text" class="form-control" placeholder="" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="col-sm-6 col-md-5 col-xl-5">
                                    <label for="select_sale">Sale</label>
                                    <select id="select_sale" class="form-control">
                                    </select>
                                </div>
                                <div class="col-sm-6 col-md-2 col-xl-2">
                                    <label for="sale_department">Sale Dep.</label>
                                    <input id="sale_department" type="text" class="form-control" placeholder="" />
                                </div>
                                <div class="col-sm-6  col-md-5 col-xl-5">
                                    <label for="end_user">End User</label>
                                    <input id="end_user" type="text" class="form-control" placeholder="" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="col-sm-6 col-md-3 col-xl-3">
                                    <label for="md_rate">Market Develop</label>
                                    <div class="input-group">
                                        <input id="md_rate" type="number" class="form-control" placeholder="#.#" value="1.0" step="0.1" min="0" max="10" />
                                        <div class="input-group-append">
                                            <span class="input-group-text">X</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6 col-md-3 col-xl-3">
                                    <div class="form-group ">
                                        <label for="pd_rate">Product Develop</label>
                                        <div class="input-group">
                                            <input id="pd_rate" type="number" class="form-control" placeholder="#.#" value="1.0" step="0.1" min="0" max="10" />
                                            <div class="input-group-append">
                                                <span class="input-group-text">X</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6 col-md-6 col-xl-6">
                                    <label for="select_responsible">Project Status Update by</label>
                                    <select id="select_responsible" class="form-control">
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="overflow-x:auto">
                        <div class="card-header" style="background-color:#42D5D8">
                            <span style="font-weight:bold">Job Owner</span>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus" style="color:black"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="col-sm-12 col-md-4 col-xl-4">
                                    <div class="input-group">
                                        <input id="chk_eng" type="checkbox" style="transform:scale(1.5)" />
                                        <div class="input-group-append">
                                            <span class="pl-3">ENG</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-4 col-xl-4">
                                    <div class="input-group">
                                        <input id="chk_cis" type="checkbox" style="transform:scale(1.5)" />
                                        <div class="input-group-append">
                                            <span class="pl-3">CIS</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-4 col-xl-4">
                                    <div class="input-group">
                                        <input id="chk_ais" type="checkbox" style="transform:scale(1.5)" />
                                        <div class="input-group-append">
                                            <span class="pl-3">AIS</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="overflow-x:auto">
                        <div class="card-header" style="background-color:#42D5D8">
                            <span style="font-weight:bold">Job In Hand</span>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus" style="color:black"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="col-sm-6 col-md-6 col-xl-6">
                                    <label for="cost">Total Job In Hand</label>
                                    <div class="input-group">
                                        <input id="job_in_hand" type="number" class="form-control" placeholder="0" value="0" />
                                        <div class="input-group-append">
                                            <span class="input-group-text">THB</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6 col-md-6 col-xl-6">
                                    <label for="due_date">Due Date</label>
                                    <input id="due_date" type="date" class="form-control" value="1900-01-01" />
                                </div>
                                <div class="col-sm-6 col-md-4 col-xl-4">
                                    <label for="cost">ENG Job In Hand</label>
                                    <div class="input-group">
                                        <input id="job_eng_in_hand" type="number" class="form-control" placeholder="0" value="0" />
                                        <div class="input-group-append">
                                            <span class="input-group-text">THB</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6 col-md-4 col-xl-4">
                                    <label for="cost">CIS Job In Hand</label>
                                    <div class="input-group">
                                        <input id="job_cis_in_hand" type="number" class="form-control" placeholder="0" value="0" />
                                        <div class="input-group-append">
                                            <span class="input-group-text">THB</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6 col-md-4 col-xl-4">
                                    <label for="cost">AIS Job In Hand</label>
                                    <div class="input-group">
                                        <input id="job_ais_in_hand" type="number" class="form-control" placeholder="0" value="0" />
                                        <div class="input-group-append">
                                            <span class="input-group-text">THB</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="overflow-x:auto">
                        <div class="card-header" style="background-color:#42D5D8">
                            <span style="font-weight:bold">Cost</span>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus" style="color:black"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="col-sm-6 col-md-6 col-xl-6">
                                    <label for="gp">%GP</label>
                                    <div class="input-group">
                                        <input id="gp" type="number" class="form-control" placeholder="0" value="0" />
                                        <div class="input-group-append">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6 col-md-6 col-xl-6">
                                    <label for="est_cost">EST Cost</label>
                                    <div class="input-group">
                                        <input id="est_cost" type="number" class="form-control" placeholder="0" value="0" />
                                        <div class="input-group-append">
                                            <span class="input-group-text">THB</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6 col-md-4 col-xl-4">
                                    <label for="cost">ENG Cost</label>
                                    <div class="input-group">
                                        <input id="eng_cost" type="number" class="form-control" placeholder="0" value="0" />
                                        <div class="input-group-append">
                                            <span class="input-group-text">THB</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6 col-md-4 col-xl-4">
                                    <label for="cost">CIS Cost</label>
                                    <div class="input-group">
                                        <input id="cis_cost" type="number" class="form-control" placeholder="0" value="0" />
                                        <div class="input-group-append">
                                            <span class="input-group-text">THB</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6 col-md-4 col-xl-4">
                                    <label for="cost">AIS Cost</label>
                                    <div class="input-group">
                                        <input id="ais_cost" type="number" class="form-control" placeholder="0" value="0" />
                                        <div class="input-group-append">
                                            <span class="input-group-text">THB</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="col-12">
                            <div class="card" style="overflow-x:auto">
                                <div class="card-header" style="background-color:#42D5D8">
                                    <span style="font-weight:bold">Job File</span>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                            <i class="fas fa-minus" style="color:black"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="form-row pt-1">
                                        <div class="col-12">
                                            <table id="table_job_file" class="table table-sm table-bordered table-hover text-center table-striped nowrap w-100">
                                                <thead style="background-color:#42B4D8">
                                                    <tr>
                                                        <th>หัวข้อ</th>
                                                        <th style="text-align:center">ไฟล์แนบ</th>
                                                        <th style="width:10%"></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="overflow-x:auto">
                        <div class="card-header" style="background-color:#42D5D8">
                            <span style="font-weight:bold">Process & System</span>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus" style="color:black"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="col-sm-6 col-md-6 col-xl-6">
                                    <div class="card">
                                        <div class="card-header" style="background-color: #42B4D8">
                                            <span style="font-weight:bold;">Process</span>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-row">
                                                <div class="col-sm-6 col-md-9 col-xl-9">
                                                    <label for="select_process">Process</label>
                                                    <select id="select_process" class="form-control">
                                                    </select>
                                                </div>
                                                <div class="col-sm-6 col-md-3 col-xl-3">
                                                    <label for="add_process">Add</label>
                                                    <button id="add_process" type="button" class="btn btn-primary form-control elevation-1" disabled>
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="form-row pt-1">
                                                <div class="col-12" style="overflow-x:auto">
                                                    <table id="table_process" class="table table-sm table-bordered table-hover text-center table-striped nowrap w-100">
                                                        <thead style="background-color:#42B4D8">
                                                            <tr>
                                                                <th>Process</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6 col-md-6 col-xl-6">
                                    <div class="card">
                                        <div class="card-header" style="background-color: #42B4D8">
                                            <span style="font-weight:bold">System</span>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-row">
                                                <div class="col-sm-6 col-md-9 col-xl-9">
                                                    <label for="select_system">System</label>
                                                    <select id="select_system" class="form-control">
                                                    </select>
                                                </div>
                                                <div class="col-sm-6 col-md-3 col-xl-3">
                                                    <label for="add_system">Add</label>
                                                    <button id="add_system" type="button" class="btn btn-primary form-control elevation-1" disabled>
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="form-row pt-1">
                                                <div class="col-12" style="overflow-x:auto">
                                                    <table id="table_system" class="table table-sm table-bordered table-hover text-center table-striped nowrap w-100">
                                                        <thead style="background-color:#42B4D8">
                                                            <tr>
                                                                <th>System</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="col-12">
                            <div class="card" style="overflow-y:auto">
                                <div class="card-header" style="background-color:#42D5D8">
                                    <span style="font-weight:bold">Term Payment</span>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                            <i class="fas fa-minus" style="color:black"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="form-row">
                                        <div class="col-sm-6 col-md-5 col-xl-5">
                                            <label for="select_payment">Term Payment</label>
                                            <select id="select_payment" class="form-control">
                                            </select>
                                        </div>
                                        <div class="col-sm-6 col-md-2 col-xl-2">
                                            <label for="add_payment">Add</label>
                                            <button id="add_payment" type="button" class="btn btn-primary form-control elevation-1" disabled>
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-row pt-1">
                                        <div class="col-12">
                                            @*<table id="table_payment" class="table table-sm table-bordered table-hover text-center table-striped nowrap w-100">
                                    <thead style="background-color:#42B4D8">
                                        <tr>
                                            <th>Milestone</th>
                                            <th>%</th>
                                            <th>Month</th>
                                            <th>% Forecast</th>
                                            <th>Remark</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>*@
                                            <div id="table_payment"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row pt-2">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header" style="background-color:#42D5D8">
                                    <span style="font-weight:bold">Invoice</span>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                            <i class="fas fa-minus" style="color:black"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-10 d-flex justify-content-start pt-2">

                                        </div>
                                        <div class="col-2 col-md-2 d-flex justify-content-end">
                                            <button id="add_invoice" type="button" class="btn btn-primary form-control elevation-1" style="width:50px">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-row pt-1">
                                        <div class="col-12" style="overflow-x:auto">
                                            <table id="table_invoice" class="table table-sm table-bordered table-hover text-center table-striped nowrap w-100">
                                                <thead style="background-color:#42B4D8">
                                                    <tr>
                                                        <th>No</th>
                                                        <th>ID</th>
                                                        <th>Milestone</th>
                                                        <th>Invoice</th>
                                                        <th>Plan Date</th>
                                                        <th>Actual Date</th>
                                                        <th>New Plan Date</th>
                                                        <th>Status</th>
                                                        <th>Remark</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="col-sm-6 col-md-6 col-xl-6 pt-1">
                                        <div class="row">
                                            <div class="col-sm-6 col-md-2 col-xl-2 pt-1">
                                                <label for="cost">รวม</label>
                                            </div>
                                            <div class="col-sm-6 col-md-10 col-xl-10">
                                                <div class="input-group">
                                                    <input id="invoice" type="text" class="form-control" placeholder="0" value="0" />
                                                    <div class="input-group-append">
                                                        <span class="input-group-text">THB</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="overflow-x:auto">
                        <div class="card-header" style="background-color:#42D5D8">
                            <span style="font-weight:bold">Bank</span>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus" style="color:black"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="col-sm-6 col-md-3 col-xl-3">
                                    <label for="bank_guarantee">Bank Guarantee</label>
                                    <div class="input-group">
                                        <input id="bank_guarantee" type="number" class="form-control" placeholder="#" value="0" step="1" min="0" max="100" />
                                        <div class="input-group-append">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6 col-md-3 col-xl-3">
                                    <label for="bg_start">BG Start</label>
                                    <input id="bg_start" type="date" class="form-control" />
                                </div>
                                <div class="col-sm-6 col-md-3 col-xl-3">
                                    <label for="bg_finish">BG Finish</label>
                                    <input id="bg_finish" type="date" class="form-control" />
                                </div>
                                <div class="col-sm-6 col-md-3 col-xl-3">
                                    <div class="form-group ">
                                        <label for="retention">Retention</label>
                                        <div class="input-group">
                                            <input id="retention" type="number" class="form-control" placeholder="#" value="0" step="1" min="0" max="100" />
                                            <div class="input-group-append">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="overflow-x:auto">
                        <div class="card-header" style="background-color:#42D5D8">
                            <span style="font-weight:bold">Total Cost</span>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus" style="color:black"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="col-sm-6 col-md-4 col-xl-4">
                                    <label for="total_cost">Total Cost</label>
                                    <div class="input-group">
                                        <input id="total_cost" type="number" class="form-control" placeholder="0" value="0" />
                                        <div class="input-group-append">
                                            <span class="input-group-text">THB</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6 col-md-4 col-xl-4">
                                    <label for="remaining_cost">Remaining Cost</label>
                                    <div class="input-group">
                                        <input id="remaining_cost" type="number" class="form-control" placeholder="0" value="0" />
                                        <div class="input-group-append">
                                            <span class="input-group-text">THB</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6 col-md-2 col-xl-2">
                                    <label for="btn_cal_gp">Calculate GP</label>
                                    <input id="btn_cal_gp" type="button" class="form-control btn btn-primary" value="Cal GP" />
                                </div>
                                <div class="col-sm-6 col-md-2 col-xl-2">
                                    <label for="gp_improve">%GP Improve</label>
                                    <div class="input-group">
                                        <input id="gp_improve" type="number" class="form-control" placeholder="0" value="0" disabled />
                                        <div class="input-group-append">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="overflow-x:auto">
                        <div class="card-header" style="background-color:#42D5D8">
                            <span style="font-weight:bold">Status</span>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus" style="color:black"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="col-sm-6 col-md-5 col-xl-5">
                                    <label for="status">Status</label>
                                    <select id="status" class="form-control">
                                    </select>
                                </div>
                                <div class="col-sm-6 col-md-4 col-xl-4" id="group_finished_date">
                                    <label for="finished_date">Date Finished</label>
                                    <input id="finished_date" type="date" class="form-control" value="1900-01-01" />
                                </div>
                                <div class="col-sm-6 col-md-3 col-xl-3" id="group_warranty_period">
                                    <label for="warranty_period">Warranty Period</label>
                                    <input id="warranty_period" type="number" class="form-control" value="0" disabled />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="overflow-x:auto">
                        <div class="card-header" style="background-color:#42D5D8">
                            <span style="font-weight:bold">Note</span>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus" style="color:black"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="col-sm-12 col-md-12 col-xl-12">
                                    <textarea id="note" class="form-control">
                                    </textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="btn_save" type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal_edit_payment" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-md" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="modal_title" class="modal-title"><b>Edit Term Payment</b></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-row">
                        <div class="col-sm-6 col-md-8 col-xl-8">
                            <label for="edit_payment_name">Term Payment</label>
                            <input id="edit_payment_name" type="text" class="form-control" placeholder="" disabled />
                        </div>
                        <div class="col-sm-6 col-md-4 col-xl-4">
                            <label for="edit_percent">Percent</label>
                            <input id="edit_percent" type="number" class="form-control" placeholder="" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="btn_payment_delete" type="button" class="btn btn-danger mr-auto elevation-1">
                    <i class="fas fa-trash-alt"></i> Delete
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="btn_payment_save" type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal_edit_invoice" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="modal_title" class="modal-title"><b>Edit Invoice</b></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-row">
                        <div class="col-sm-6 col-md-2 col-xl-2">
                            <label for="edit_invoice_no">No</label>
                            <input id="edit_invoice_no" type="text" class="form-control" placeholder="" disabled />
                        </div>
                        <div class="col-sm-6 col-md-2 col-xl-2">
                            <label for="edit_invoice_id">ID</label>
                            <input id="edit_invoice_id" type="number" class="form-control" placeholder="" disabled />
                        </div>
                        <div class="col-sm-6 col-md-8 col-xl-8">
                            <label for="edit_invoice_milestone">Milestone</label>
                            <select id="edit_invoice_milestone" class="form-control"></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="col-sm-6 col-md-4 col-xl-4">
                            <label for="edit_invoice">Invoice</label>
                            <input id="edit_invoice" type="number" class="form-control" placeholder="" />
                        </div>
                        <div class="col-sm-6 col-md-4 col-xl-4">
                            <label for="edit_invoice_plan_date">Plan Date</label>
                            <input id="edit_invoice_plan_date" type="date" class="form-control" placeholder="" />
                        </div>
                        <div class="col-sm-6 col-md-4 col-xl-4">
                            <label for="edit_invoice_actual_date">Actual Date</label>
                            <input id="edit_invoice_actual_date" type="date" class="form-control" placeholder="" />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="col-sm-6 col-md-4 col-xl-4">
                            <label for="edit_invoice_status">Status</label>
                            <select id="edit_invoice_status" class="form-control"></select>
                        </div>
                        <div class="col-sm-6 col-md-4 col-xl-4">
                            <label for="edit_invoice_remark">Remark</label>
                            <textarea id="edit_invoice_remark" cols="50" rows="3" class="form-control"></textarea>
                        </div>
                        <div class="col-sm-6 col-md-4 col-xl-4">
                            <label for="edit_invoice_new_plan_date">New Plan Date</label>
                            <input id="edit_invoice_new_plan_date" type="date" class="form-control" placeholder="" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="btn_invoice_delete" type="button" class="btn btn-danger mr-auto elevation-1">
                    <i class="fas fa-trash-alt"></i> Delete
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="btn_invoice_save" type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal_edit_process" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-md" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="modal_title" class="modal-title"><b>Edit Process</b></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-row">
                        <div class="col-sm-12 col-md-12 col-xl-12">
                            <label for="edit_process_name">Process</label>
                            <input id="edit_process_name" type="text" class="form-control" placeholder="" disabled />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="btn_process_delete" type="button" class="btn btn-danger mr-auto elevation-1">
                    <i class="fas fa-trash-alt"></i> Delete
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal_edit_system" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-md" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="modal_title" class="modal-title"><b>Edit System</b></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-row">
                        <div class="col-sm-12 col-md-12 col-xl-12">
                            <label for="edit_system_name">System</label>
                            <input id="edit_system_name" type="text" class="form-control" placeholder="" disabled />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="btn_system_delete" type="button" class="btn btn-danger mr-auto elevation-1">
                    <i class="fas fa-trash-alt"></i> Delete
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="ImportJobFileModal" tabindex="-1" role="dialog" style="overflow-y:auto" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title"><b>อัพเดทไฟล์</b></h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-body">
                    <form>
                        <div class="row pt-1" style="row-gap:1px">
                            <div class="col-sm-12 col-md-12 col-xl-12">
                                <div class="card elevation-1">
                                    <div class="card-header">
                                        <span class="card-title">
                                            <i class="fas fa-file-excel"></i> <b> Import File</b>
                                        </span>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group">
                                            <label id="importJobFileName">File Name</label>
                                            <input id="importJobFile" type="file" class="form-control-file" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts
{
    <script type="text/javascript">
        //Variable Declaration
        let table;
        let table_payment;
        let table_process;
        let table_system;
        let table_invoice;
        let table_job_file;

        let update = false;
        let jobs = [];
        let jobs_owner = [];
        let users = [];
        let quots = [];
        let statuses = [];
        let processes = [];
        let systems = [];
        let all_users = [];
        let set_payments = [];
        let set_processes = [];
        let set_systems = [];
        let set_invoice = [];
        let job_files = [];
        let set_select = ["ENG","CIS","AIS"];
        let status_invoices = ['', 'วางบิลแล้ว', 'คาดว่าจะวางบิลได้ภายในเดือน', 'อยู่ระหว่างรอลูกค้าตรวจรับงาน', 'ยังไม่เริ่มงาน', 'เลื่อน', 'งานยกเลิก'];
        //Change these parameters to true to show result

        $(document).ready(async function () {
            await GetStatus();
            await GetAllUsers();
            await GenerateStatusOption();
            await GeneratePaymentOption();
            await GetProcess();
            await GetSystem();
            await GenerateProcessOption();
            await GenerateSystemOption();
            await GenerateAllUser();
            await GenerateResponsible();
            GetJobs(set_select);
            GenerateSelectCheckBox();
        });

        async function GetJobs(set_select) {
            await $.ajax({
                type: "POST",
                url: '@Url.Action("GetJobs", "Job")',
	            contentType: 'application/x-www-form-urlencoded',
                data: { set_select: set_select },
                success: function (response) {
                    jobs = response.jobs;
                    jobs_owner = response.jobs_owner;
                    GenerateTable(jobs);
                }
            });
        };

        async function GetUsers() {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetUsers", "EngUser")',
	            contentType: 'application/x-www-form-urlencoded',
                data: { },
                success: function (response) {
                    users = response;
                }
            });
        }

        async function GetQuotations() {
            let today = new Date();
            let year = today.getFullYear().toString().substring(2, 4);
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetQuotations", "Job")',
	            contentType: 'application/x-www-form-urlencoded',
                data: { },
                success: function (response) {
                    quots = response;
                }
            });
        }

        async function GetProcess() {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetProcesses", "EngProcess")',
	            contentType: 'application/x-www-form-urlencoded',
                data: { },
                success: function (response) {
                    processes = response;
                }
            });
        }
        async function GetSystem() {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetSystems", "EngSystem")',
	            contentType: 'application/x-www-form-urlencoded',
                data: { },
                success: function (response) {
                    systems = response;
                }
            });
        }

        function GenerateProcessOption() {
            let process = $('#select_process').val();
            $('#select_process').empty();
            $('#select_process').append(`<option value="" selected disabled>Please Select Process</option>`);
            for (let i = 0; i < processes.length; i++) {
                if (processes[i].process_name === process || process === "" || process === null) {
                    $('#select_process').append(`<option value="${processes[i].process_id}">${processes[i].process_id}: ${processes[i].process_name}</option>`);
                }
            }
        }

        function GenerateSystemOption() {
            let system = $('#select_system').val();
            $('#select_system').empty();
            $('#select_system').append(`<option value="" selected disabled>Please Select System</option>`);
            for (let i = 0; i < systems.length; i++) {
                if (systems[i].system_name === system || system === "" || system === null) {
                    $('#select_system').append(`<option value="${systems[i].system_id}">${systems[i].system_id}: ${systems[i].system_name}</option>`);
                }
            }
        }

        async function GetAllUsers() {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetAllUsers", "Job")',
	            contentType: 'application/x-www-form-urlencoded',
                data: {  },
                success: function (response) {
                    all_users = response;
                }
            });
        };

        function GenerateAllUser() {
            let user = $('#select_sale').val();
            $('#select_sale').empty();
            $('#select_sale').append(`<option value="" selected disabled>Please Select Sale</option>`);
            for (let i = 0; i < all_users.length; i++) {
                if (all_users[i].user_name === user || user === "" || user === null) {
                    $('#select_sale').append(`<option value="${all_users[i].user_name}">${all_users[i].user_name}</option>`);
                }
            }
        }

        function GenerateResponsible() {
            let user = $('#select_responsible').val();
            $('#select_responsible').empty();
            $('#select_responsible').append(`<option value="" selected disabled>Please Select Responsible</option>`);
            for (let i = 0; i < all_users.length; i++) {
                if (all_users[i].user_name === user || user === "" || user === null) {
                    $('#select_responsible').append(`<option value="${all_users[i].user_name}">${all_users[i].user_name}</option>`);
                }
            }
        }

        async function GetStatus() {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetStatus", "Job")',
	            contentType: 'application/x-www-form-urlencoded',
                data: {  },
                success: function (response) {
                    statuses = response;
                }
            });
        };
        function GenerateTable(jobs) {
            let datas = [];
            if (table !== null)
                $('#table_job').DataTable().destroy();

            for (let i = 0; i < jobs.length; i++) {

                let countProcess = (jobs[i].process.match(/,/g) || []).length;
                let countSystem = (jobs[i].system.match(/,/g) || []).length;

                let process = "";
                let system = "";

                for (let k=0;k<=countProcess;k++ ){
                    if (k < countProcess){
                        process += processes.filter(f=> f.process_id === jobs[i].process.split(',')[k]).map(m=> m.process_name) + ",";
                    }else{
                        process += processes.filter(f=> f.process_id === jobs[i].process.split(',')[k]).map(m=> m.process_name);
                    }
                }

                for (let k=0;k<=countSystem;k++ ){
                    if (k < countSystem){
                        system += systems.filter(f=> f.system_id === jobs[i].system.split(',')[k]).map(m=> m.system_name) + ",";
                    }else{
                        system += systems.filter(f=> f.system_id === jobs[i].system.split(',')[k]).map(m=> m.system_name);
                    }
                }
                datas.push([
                    jobs[i].job_id,
                    jobs[i].job_name,
                    jobs[i].quotation_no,
                    jobs[i].customer,
                    jobs[i].status,
                    jobs[i].enduser,
                    jobs[i].sale_name,
                    jobs[i].department,
                    process,
                    system,
                    jobs[i].eng_cost.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","),
                    jobs[i].cis_cost.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","),
                    jobs[i].ais_cost.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","),
                    jobs[i].md_rate,
                    jobs[i].pd_rate,
                    jobs[i].md_rate * jobs[i].pd_rate, //Factor
                    jobs[i].manpower,
                    jobs[i].cost_per_manpower,
                    jobs[i].ot_manpower,                   
                    "", //Customer Satisfaction
                    jobs[i].gp,
                    jobs[i].est_cost,
                    jobs[i].total_cost,
                    jobs[i].remaining_cost
                ]);
            }

            table = $('#table_job').DataTable({
                data: datas,
                lengthMenu: [[25, 50, 100, -1], [25, 50, 100, "All"]],
                fixedHeader: true,
                fixedColumns: {
                    left: 2
                },
                columnDefs: [
                    {
                        targets: [5, 6, 12, 13, 15, 16, 17,19,20,21,22,23],
                        visible: false
                    },
                ],
                rowCallback: function (row, data) {
                    $('td:eq(1)', row).addClass("text-left");
                    $('td:eq(3)', row).addClass("text-left");
                    let code_status = data[4];
                    let status = statuses.filter(f=>f.status_id === code_status).map(m=>m.status_name);
                    let status_str =  '';
                    if (code_status === "STA999"){
                        status_str = `<span class="badge badge-success">${status}</span>`;
                    }else{
                        status_str = `<span class="badge badge-warning">${status}</span>`;
                    }

                    $('td:eq(4)', row).html(status_str);
                }
            });
        };

        function paymentIdSort(set_payments) {
            function compare(a, b) {
                const regex = /^([A-Z]+)(\d+)(?:-(\d+))?$/;

                const aParts = a.payment_id.match(regex);
                const bParts = b.payment_id.match(regex);

                if (!aParts || !bParts) {
                    return a.payment_id.localeCompare(b.payment_id);
                }

                const [, aPrefix, aNum, aSub] = aParts;
                const [, bPrefix, bNum, bSub] = bParts;

                if (aPrefix !== bPrefix) {
                    return aPrefix.localeCompare(bPrefix);
                }

                const numA = Number(aNum);
                const numB = Number(bNum);
                if (numA !== numB) {
                    return numA - numB;
                }

                const subA = Number(aSub || 0);
                const subB = Number(bSub || 0);
                return subA - subB;
            }
            return [...set_payments].sort(compare);
        }

        function regenerateProgressWork(set_payments) {
            const nonProgress = set_payments.filter(item => !item.payment_id.startsWith('STA009'));
            let progressItems = set_payments.filter(item => item.payment_id.startsWith('STA009'));

            progressItems.sort((a, b) => {
                const numA = parseInt(a.payment_id.split('-')[1] || 9999);
                const numB = parseInt(b.payment_id.split('-')[1] || 9999);
                return numA - numB;
            });

            const newProgress = [];
            let counter = 1;
            for (let item of progressItems) {
                const newId = `STA009-${counter.toString().padStart(2, '0')}`;
                const newName = `Progress Work-${counter.toString().padStart(2, '0')}`;

                newProgress.push({
                    ...item, 
                    payment_id: newId,
                    payment_name: newName
                });

                counter++;
            }

            return [...nonProgress, ...newProgress];
        }
        const DeleteTermPaymentColumn = {
            createCell: function (cell, value, x, y, instance) {
                const icon = document.createElement('i');
                icon.className = 'material-icons delete-icon';
                icon.innerHTML = 'delete';
                icon.title = 'ลบแถวนี้';

                icon.addEventListener('click', function (e) {
                    e.stopPropagation();
                    if (confirm(`ยืนยันลบแถวที่ ${y + 1} ใช่ไหม?`)) {
                        instance.deleteRow(y);
                        set_payments.splice(y, 1);

                        set_payments = regenerateProgressWork(set_payments);
                        //set_payments = paymentIdSort(set_payments);

                        GenerateTablePayment();
                    }
                });

                cell.appendChild(icon);
                cell.style.textAlign = 'center';
                cell.style.verticalAlign = 'middle';
            },
            openEditor: function () { return false; },
            updateCell: function () { return ''; }
        };
        function GenerateTablePayment() {
            const spreadsheetData = set_payments.map(item => [
                item.payment_id,
                item.payment_name,
                item.percent,
                item.forecast_month,
                item.remark
            ]);
            $('#table_payment').empty();
            jspreadsheet(document.getElementById('table_payment'), {
                worksheets: [{
                    data: spreadsheetData,
                    columns: [
                        { type: 'text', title: 'ID', width: 80, readOnly: true,},
                        { type: 'text', title: 'Milestone', width: 150, readOnly: true, },
                        {
                            type: 'numeric',
                            title: '%',
                            width: 80,
                            mask: '0',             
                            decimal: '.',
                            options: {
                                decimal: '.',
                                thousands: ',',
                                regex: /^[0-9]*$/,
                            }
                        },
                        {
                            type: 'calendar', title: 'Month', width: 100,
                            options: {
                                type: 'year-month-picker',   
                                format: 'MM/YYYY'            
                            }},
 
                        { type: 'text', title: 'Remark', width: 200 },
                        {
                            type: DeleteTermPaymentColumn,
                            title: 'ลบ',
                            width: 50,
                            readOnly: true,
                            align: 'center'
                        }
                    ],
                    minDimensions: [6, spreadsheetData.length],
                }],
                toolbar: false,
                tabs: false,
                onchange: function (worksheet, changedCellElement, x, y, newValue) {
                    const fullRowData = worksheet.getRowData(y);

                    const payment_id = fullRowData[0];
                    const percent = fullRowData[2];
                    const forecast_month = fullRowData[3];
                    const remark = fullRowData[4];

                    const existingIndex = set_payments.findIndex(item => item.payment_id === payment_id);
                    if (existingIndex !== -1) {
                        set_payments[existingIndex].percent = percent;
                        set_payments[existingIndex].forecast_month = forecast_month;
                        set_payments[existingIndex].remark = remark;
                    }

                    updatePercentSum();
                },
            });
            addTotalRow();
        };

        function updatePercentSum() {
            const total = set_payments.reduce((sum, item) => sum + (Number(item.percent) || 0), 0);

            $('#payment_total_percent').text(total.toFixed(2) + '%');

            if (total > 100) {
                $('#payment_total_percent').css('color', 'red');
            } else if (total < 100) {
                $('#payment_total_percent').css('color', 'orange');
            } else {
                $('#payment_total_percent').css('color', 'green');
            }
        }

        function addTotalRow() {
            let total = set_payments.reduce((sum, item) => sum + (Number(item.percent) || 0), 0);
            $('#div_payment_total').empty();
            if (!$('#payment_total_percent').length) {
                $('#table_payment').after(
                    '<div id="div_payment_total" style="margin-top:8px; font-weight:bold;">รวม: <span id="payment_total_percent">'
                    + total.toFixed(2) + '%</span></div>'
                );
            }
        }

        function GenerateTableProcess(processes) {
            let datas = [];
            if (table_process !== null)
                $('#table_process').DataTable().destroy();

            for (let i = 0; i < processes.length; i++) {

                let process = processes[i].process_name;
                datas.push([
                    process
                ]);
            }

            table_process = $('#table_process').DataTable({
                data: datas,
                lengthMenu: [[25, 50, 100, -1], [25, 50, 100, "All"]],
                fixedHeader: true,
                fixedColumns: {
                    left: 2
                },
                columnDefs: [
                    {

                    },
                ],
                rowCallback: function (row, data) {

                },
                searching: false,
                ordering: false,
                paging: false,
                info : false
            });
        };

        function GenerateTableSystem(systems) {
            let datas = [];
            if (table_system !== null)
                $('#table_system').DataTable().destroy();

            for (let i = 0; i < systems.length; i++) {

                let system = systems[i].system_name;
                datas.push([
                    system
                ]);
            }

            table_system = $('#table_system').DataTable({
                data: datas,
                lengthMenu: [[25, 50, 100, -1], [25, 50, 100, "All"]],
                fixedHeader: true,
                fixedColumns: {
                    left: 2
                },
                columnDefs: [
                    {

                    },
                ],
                rowCallback: function (row, data) {

                },
                searching: false,
                ordering: false,
                paging: false,
                info : false
            });
        };

        function GenerateStatusOption() {
            let status = $('#status').val();
            $('#status').empty();
            $('#status').append(`<option value="" selected disabled>Please Select Status</option>`);
            for (let i = 0; i < statuses.length; i++) {
                if (statuses[i].status_name === status || status === "" || status === null) {
                    $('#status').append(`<option value="${statuses[i].status_id}">${statuses[i].status_id}: ${statuses[i].status_name}</option>`);
                }
            }
        }
        function GeneratePaymentOption() {
            let payment = $('#select_payment').val();
            $('#select_payment').empty();
            $('#select_payment').append(`<option value="" selected disabled>Please Select Term Payment</option>`);
            for (let i = 0; i < statuses.length; i++) {
                if (statuses[i].status_name === payment || payment === "" || payment === null) {
                    $('#select_payment').append(`<option value="${statuses[i].status_id}">${statuses[i].status_name}</option>`);
                }
            }
        }
        function GenerateMilestoneOption() {
            $('#edit_invoice_milestone').empty();
            $('#edit_invoice_milestone').append(`<option value="" selected disabled>Please Select Milestone</option>`);
            $('#edit_invoice_milestone').append(`<option value="STA000"></option>`);
            for (let i = 0; i < statuses.length; i++) {
                $('#edit_invoice_milestone').append(`<option value="${statuses[i].status_id}">${statuses[i].status_name}</option>`);
            }
        }
        function GenerateStatusInvoiceOption() {
            $('#edit_invoice_status').empty();
            $('#edit_invoice_status').append(`<option value="" selected disabled>Please Select Status</option>`);
            for (let i = 0; i < status_invoices.length; i++) {
                $('#edit_invoice_status').append(`<option value="${i}">${status_invoices[i]}</option>`);
            }
        }
        function GenerateQuotationOptions() {
            let quots_str = '';
            for (let i = 0; i < quots.length; i++) {
                quots_str += `<option value="${quots[i].quotation_no}">${quots[i].quotation_no} - ${quots[i].customer} - ${quots[i].type}</option>`;
            }
            $('#quotations').empty();
            $('#quotations').append(quots_str);
        }
        $('#select_sale').on('change', function () {
            let user_name = $('#select_sale').val();
            let department = all_users.filter(f => f.user_name === user_name).map(m => m.department)[0];
            $('#sale_department').val(department);
        });

        $('#btn_create').on('click', async function () {
            set_payments = [];
            set_processes = [];
            set_systems = [];
            set_invoice = [];

            GenerateStatusInvoiceOption();
            GenerateMilestoneOption();
            GenerateTablePayment();
            GenerateTableProcess(set_processes);
            GenerateTableSystem(set_systems);
            GenerateTableInvoice(set_invoice);
            GenerateTableInvoice(set_invoice);

            Prepmodal();
        });

        function Prepmodal() {
            $('#job_id').attr('disabled', false);
            update = false;
            $('#modal_title').text("Create Job");
            $('#job_id').val(null);
            $('#job_name').val(null);
            $('#job_customer').val(null);
            $('#end_user').val(null);
            $('#sale_department').val(null);
            $('#job_date').val(null);
            $('#quotation_no').val(null);
            $('#gp').val(0);
            $('#est_cost').val(0);
            $('#eng_cost').val(0);
            $('#cis_cost').val(0);
            $('#ais_cost').val(0);
            $('#total_cost').val(0);
            $('#remaining_cost').val(0);
            $('#md').val(1);
            $('#pd').val(1);
            $('#status').val(1);
            $('#job_in_hand').val(0);
            $('#job_eng_in_hand').val(0);
            $('#job_cis_in_hand').val(0);
            $('#job_ais_in_hand').val(0);
            $('#invoice').val(0);
            $('#due_date').val(null);
            $('#bank_guarantee').val(0);
            $('#bg_start').val(null);
            $('#bg_finish').val(null);
            $('#retention').val(0);
            $('#group_finished_date').hide();
            $('#group_warranty_period').hide();
            document.getElementById("chk_eng").checked = false;
            document.getElementById("chk_cis").checked = false;
            document.getElementById("chk_ais").checked = false;
            $('#modal_job').modal();
        };

        $('#table_job tbody').on('click', 'tr', async function () {           
            let admin = '@Model.role' == "Admin" ? true : false;           
            if (admin) {
                let job_id = table.row(this).data()[0];
                await GetJobFile(job_id);
                await EditJob(table.row(this).data());
            }
        });

        async function GetJobFile(job_id) {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetJobFileByJob", "Job")',
                contentType: 'application/x-www-form-urlencoded',
                data: { job_id },
                success: function (response) {
                    job_files = response;
                }
            });
        }

        function EditJob(data) {
            set_payments = [];
            set_processes = [];
            set_systems = [];
            set_invoice = [];

            update = true;
            $('#modal_job').modal();
            $('#modal_title').text("Edit Job");

            let job_id = data[0];
            let job_name = data[1];

            let quotation_no = data[2];
            let list_process = [];
            let job = jobs.filter(f=>f.job_id == job_id).map(m=>m)[0];
            let customer = job.customer;
            let sale_name = job.sale;
            let sale_department = job.sale_department;
            let end_user = job.enduser;
            let job_date = job.job_date.split('T')[0];
            let job_type = job.job_type;
            let countProcess = (job.process.match(/,/g) || []).length;
            let bank_guarantee = job.bank_guarantee;
            let bg_start = job.bg_start.split('T')[0];
            let bg_finish = job.bg_finish.split('T')[0];
            let retention = job.retention;
            for (let k=0;k<=countProcess;k++){
                let _process = processes.filter(f=>f.process_id == job.process.split(',')[k]).map(m=>m.process_name)[0];
                if (_process !== undefined){
                    list_process.push(_process);
                }
            }

            let list_system = [];
            let countSystem = (job.system.match(/,/g) || []).length;
            for (let k=0;k<=countSystem;k++){
                let _system = systems.filter(f=>f.system_id == job.system.split(',')[k]).map(m=>m.system_name)[0];
                if (_system !== undefined){
                    list_system.push(_system);
                }
            }

            let list_invoice = job.invoices;

            let eng_cost = data[10].replaceAll(",", "");
            let cis_cost = data[11].replaceAll(",", "");
            let ais_cost = data[12].replaceAll(",", "");
            let md = data[13];
            let pd = data[14];
            let status = data[4];
            let gp = data[20];
            let est_cost = data[21];
            let total_cost = data[22];
            let remaining_cost = data[23];
            let finished_date = jobs.filter(f => f.job_id == job_id).map(m => m.finished_date)[0];
            let responsible = job.responsible;
            let note = job.note;

            $('#job_id').val(job_id);
            $('#job_id').attr('disabled', true);
            $('#job_name').val(job_name);
            $('#job_customer').val(customer);
            $('#select_sale').val(sale_name);
            $('#sale_department').val(sale_department);
            $('#end_user').val(end_user);
            $('#job_date').val(job_date);
            $('#quotation_no').val(quotation_no);
            $('#job_type').val(job_type);
            $('#gp').val(gp);
            $('#est_cost').val(est_cost);
            $('#eng_cost').val(eng_cost);
            $('#cis_cost').val(cis_cost);
            $('#ais_cost').val(ais_cost);
            $('#total_cost').val(total_cost);
            $('#remaining_cost').val(remaining_cost);
            $('#md').val(md);
            $('#pd').val(pd);
            $('#status').val(status);
            $('#job_in_hand').val(job.job_in_hand);
            $('#job_eng_in_hand').val(job.job_eng_in_hand);
            $('#job_cis_in_hand').val(job.job_cis_in_hand);
            $('#job_ais_in_hand').val(job.job_ais_in_hand);
            $('#due_date').val(job.due_date.split('T')[0]);
            $('#note').val(note);

            $('#finished_date').val(finished_date.split('T')[0]);
            $('#warranty_period').val(job.warranty_period);
            $('#bank_guarantee').val(bank_guarantee);
            $('#bg_start').val(bg_start);
            $('#bg_finish').val(bg_finish);
            $('#retention').val(retention);
            $('#select_responsible').val(responsible);

            //Check Job Owner
            let job_owner = jobs_owner.filter(f => f.job_id === job_id).map(m => m);
            if (job_owner === null) {
                document.getElementById('chk_eng').checked = false;
                document.getElementById('chk_cis').checked = false;
                document.getElementById('chk_ais').checked = false;

                $('#job_eng_in_hand').attr('disabled', true);
                $('#job_cis_in_hand').attr('disabled', true);
                $('#job_ais_in_hand').attr('disabled', true);
                $('#eng_cost').attr('disabled', true);
                $('#cis_cost').attr('disabled', true);
                $('#ais_cost').attr('disabled', true);
            } else {
                let chk_eng = job_owner.filter(f => f.job_department === "ENG");
                if (chk_eng.length > 0) {
                    document.getElementById('chk_eng').checked = true;
                    $('#job_eng_in_hand').attr('disabled', false);
                    $('#eng_cost').attr('disabled', false);
                } else {
                    document.getElementById('chk_eng').checked = false;
                    $('#job_eng_in_hand').attr('disabled', true);
                    $('#eng_cost').attr('disabled', true);
                }
                let chk_cis = job_owner.filter(f => f.job_department === "CIS");
                if (chk_cis.length > 0) {
                    document.getElementById('chk_cis').checked = true;
                    $('#job_cis_in_hand').attr('disabled', false);
                    $('#cis_cost').attr('disabled', false);
                } else {
                    document.getElementById('chk_cis').checked = false;
                    $('#job_cis_in_hand').attr('disabled', true);
                    $('#cis_cost').attr('disabled', true);
                }
                let chk_ais = job_owner.filter(f => f.job_department === "AIS");
                if (chk_ais.length > 0) {
                    document.getElementById('chk_ais').checked = true;
                    $('#job_ais_in_hand').attr('disabled', false);
                    $('#ais_cost').attr('disabled', false);
                } else {
                    document.getElementById('chk_ais').checked = false;
                    $('#job_ais_in_hand').attr('disabled', true);
                    $('#ais_cost').attr('disabled', true);
                }                
            }

            let finish_status = statuses.filter(f=>f.status_id == status).map(m=> m.status_name);
            if (finish_status[0] === "Warranty") {
                $('#group_finished_date').show();
                $('#group_warranty_period').show();
                $('#warranty_period').attr('disabled', false);
            } else {
                if (finish_status[0] === "Finished") {
                    $('#warranty_period').val(0);
                    $('#warranty_period').attr('disabled', true);
                    $('#group_warranty_period').show();
                    $('#group_finished_date').show();
                } else {
                    $('#group_warranty_period').hide();
                    $('#group_finished_date').hide();
                }
                $('#group_warranty_period').hide();
            }

            //let datas_percent = [];
            //datas_percent.push(job.term_payment.down_payment);
            //datas_percent.push(job.term_payment.document_submit);
            //datas_percent.push(job.term_payment.instrument_vendor);
            //datas_percent.push(job.term_payment.instrument_delivered_ctl);
            //datas_percent.push(job.term_payment.system_delivered_ctl);
            //datas_percent.push(job.term_payment.fat);
            //datas_percent.push(job.term_payment.delivery_instrument);
            //datas_percent.push(job.term_payment.delivery_system);
            //datas_percent.push(job.term_payment.progress_work);
            //datas_percent.push(job.term_payment.installation_work_complete);
            //datas_percent.push(job.term_payment.commissioning);
            //datas_percent.push(job.term_payment.startup);
            //datas_percent.push(job.term_payment.as_built);
            //datas_percent.push(job.term_payment.warranty);          
            //datas_percent.push(job.term_payment.complete);
            //datas_percent.push(job.term_payment.after_hmc);
            //datas_percent.push(job.term_payment.finished);
            for (let i = 0; i < job.term_payments.length; i++){
                set_payments.push({
                    'job_id': job_id,
                    'payment_id': job.term_payments[i].payment_id,
                    'payment_name': job.term_payments[i].payment_name,
                    'percent': job.term_payments[i].percent,
                    'forecast_month': job.term_payments[i].forecast_month,
                    'remark': job.term_payments[i].remark
                });
                //set_payments = paymentIdSort(set_payments);
            }
     
            //Term Payment
            //let new_payments = [];
            //for (let i=0;i<set_payments.length;i++){
            //    if (set_payments[i].percent > 0){
            //        new_payments.push(set_payments[i]);
            //    }                
            //}
            //set_payments = new_payments;
            
            //Process
            for (let i=0;i<list_process.length;i++){
                let process_id = processes.filter(f=>f.process_name == list_process[i] ).map(m=>m.process_id)[0];
                set_processes.push({'process_id': process_id ,'process_name': list_process[i]});
            }

            //System
            for (let i=0;i<list_system.length;i++){
                let system_id = systems.filter(f=>f.system_name == list_system[i] ).map(m=>m.system_id)[0];
                set_systems.push({'system_id': system_id ,'system_name': list_system[i]});
            }

            //Invoice
            for (let i=0;i<list_invoice.length;i++){
                let invoice = list_invoice[i].invoice;
                let actual_date = list_invoice[i].actual_date;
                let plan_date = list_invoice[i].plan_date;
                let new_plan_date = list_invoice[i].new_plan_date;
                let status = list_invoice[i].status;
                let remark = list_invoice[i].remark;
                let milestone = list_invoice[i].milestone;
                let id = 0;
                if (milestone !== "") {
                    id = statuses.filter(f => f.status_name === milestone).map(m => m.no)[0];
                }
                set_invoice.push({
                    'no': (i + 1),
                    'id': id,
                    'milestone': milestone,
                    'invoice': invoice,
                    'plan_date': plan_date,
                    'actual_date': actual_date,
                    'new_plan_date': new_plan_date,
                    'status': status,
                    'remark': remark
                });
            }

            set_invoice.sort((a, b) => a.id - b.id || a.no - b.no);

            GenerateStatusInvoiceOption();
            GenerateMilestoneOption();
            GenerateTablePayment();
            GenerateTableProcess(set_processes);
            GenerateTableSystem(set_systems);
            GenerateTableInvoice(set_invoice);
            GenerateTableJobFile(job_files);
        }
        $('#quotation_no').on('change',function(){
            let quo = $('#quotation_no').val();
            let customer = quots.filter(f=>f.quotation_no == quo).map(m=>m.customer)[0];
            let type = quots.filter(f=>f.quotation_no == quo).map(m=>m.type)[0];
            $('#job_customer').val(customer);
            $('#job_type').val(type);
        });


        $('#status').on('change',function(){
            let status = $('#status').val();
            let finish_status = statuses.filter(f=>f.status_id === status).map(m=> m.status_name);
            if (finish_status[0] === "Warranty") {
                $('#group_finished_date').show();
                $('#group_warranty_period').show();
                $('#warranty_period').attr('disabled', false);
            }else{
                if (finish_status[0] === "Finished") {
                    $('#warranty_period').val(0);
                    $('#warranty_period').attr('disabled', true);
                    $('#group_warranty_period').show();
                    $('#group_finished_date').show();
                } else {
                    $('#group_warranty_period').hide();
                    $('#group_finished_date').hide();
                }
                $('#group_warranty_period').hide();
            }
        });

        $('#btn_save').on('click', function () {
            let job_id = $('#job_id').val();
            let job_name = $('#job_name').val();
            let customer = $('#job_customer').val();
            let sale = $('#select_sale').val();
            let sale_department = $('#sale_department').val();
            let enduser = $('#end_user').val();
            let job_date = $('#job_date').val();
            let quotation_no = $('#quotation_no').val();
            let job_type = $('#job_type').val();
            let gp = $('#gp').val();
            let est_cost = $('#est_cost').val();
            let eng_cost = $('#eng_cost').val();
            let cis_cost = $('#cis_cost').val();
            let ais_cost = $('#ais_cost').val();
            let total_cost = $('#total_cost').val();
            let remaining_cost = $('#remaining_cost').val();
            let md_rate = $('#md_rate').val();
            let pd_rate = $('#pd_rate').val();
            let status = $('#status').val();
            let finished_date = $('#finished_date').val();
            let job_in_hand = $('#job_in_hand').val();
            let job_eng_in_hand = $('#job_eng_in_hand').val();
            let job_cis_in_hand = $('#job_cis_in_hand').val();
            let job_ais_in_hand = $('#job_ais_in_hand').val();
            let due_date = $('#due_date').val();
            let warranty_period = $('#warranty_period').val();
            let bank_guarantee = $('#bank_guarantee').val();
            let bg_start = $('#bg_start').val();
            let bg_finish = $('#bg_finish').val();
            let retention = $('#retention').val();
            let responsible = $('#select_responsible').val();
            let note = $('#note').val();
            if (status === null) {
                status = 1;
            }

            let term_payment = {};
            let down_payment = set_payments.filter(f=>f.payment_id == "STA001").map(m=>m.percent)[0];
            let document_submit = set_payments.filter(f=>f.payment_id == "STA002").map(m=>m.percent)[0];
            let instrument_vendor = set_payments.filter(f=>f.payment_id == "STA003").map(m=>m.percent)[0];
            let instrument_delivered_ctl = set_payments.filter(f=>f.payment_id == "STA004").map(m=>m.percent)[0];
            let system_delivered_ctl = set_payments.filter(f=>f.payment_id == "STA005").map(m=>m.percent)[0];
            let fat = set_payments.filter(f=>f.payment_id == "STA006").map(m=>m.percent)[0];
            let delivery_instrument = set_payments.filter(f=>f.payment_id == "STA007").map(m=>m.percent)[0];
            let delivery_system = set_payments.filter(f=>f.payment_id == "STA008").map(m=>m.percent)[0];
            let progress_work = set_payments.filter(f=>f.payment_id == "STA009").map(m=>m.percent)[0];
            let installation_work_complete = set_payments.filter(f=>f.payment_id == "STA010").map(m=>m.percent)[0];
            let commissioning = set_payments.filter(f=>f.payment_id == "STA011").map(m=>m.percent)[0];
            let startup = set_payments.filter(f=>f.payment_id == "STA012").map(m=>m.percent)[0];
            let as_built = set_payments.filter(f=>f.payment_id == "STA013").map(m=>m.percent)[0];
            let warranty = set_payments.filter(f => f.payment_id == "STA014").map(m => m.percent)[0];
            let complete = set_payments.filter(f => f.payment_id == "STA015").map(m => m.percent)[0];
            let after_hmc = set_payments.filter(f => f.payment_id == "STA016").map(m => m.percent)[0];
            let finished = set_payments.filter(f=>f.payment_id == "STA999").map(m=>m.percent)[0];

            term_payment.job_id = job_id;
            term_payment.down_payment = down_payment;
            term_payment.document_submit = document_submit;
            term_payment.instrument_vendor = instrument_vendor;
            term_payment.instrument_delivered_ctl = instrument_delivered_ctl;
            term_payment.system_delivered_ctl = system_delivered_ctl;
            term_payment.fat = fat;
            term_payment.delivery_instrument = delivery_instrument;
            term_payment.delivery_system = delivery_system;
            term_payment.progress_work = progress_work;
            term_payment.installation_work_complete = installation_work_complete;
            term_payment.commissioning = commissioning;
            term_payment.startup = startup;
            term_payment.as_built = as_built;
            term_payment.warranty = warranty;           
            term_payment.complete = complete;
            term_payment.after_hmc = after_hmc;
            term_payment.finished = finished;

            let invoices = [];
            for (let i = 0; i < set_invoice.length; i++){
                invoices.push({
                    'job_id': job_id,
                    'invoice': set_invoice[i].invoice,
                    'milestone': set_invoice[i].milestone,
                    'plan_date': set_invoice[i].plan_date,
                    'actual_date': set_invoice[i].actual_date,
                    'new_plan_date': set_invoice[i].new_plan_date,
                    'status': set_invoice[i].status,
                    'remark': set_invoice[i].remark
                });
            }

            let str_process = "";
            let str_system = "";
            let list_process = Array.from(set_processes).map(m=>m.process_id);
            let list_system = Array.from(set_systems).map(m=>m.system_id);

            for(let k=0 ;k<list_process.length;k++){
                if (k === list_process.length - 1){
                    str_process += list_process[k];
                }else{
                    str_process += list_process[k] + ",";
                }
            }

            for(let k=0 ;k<list_system.length;k++){
                if (k === list_system.length - 1){
                    str_system += list_system[k];
                }else{
                    str_system += list_system[k] + ",";
                }
            }

            let job_string = JSON.stringify({
                "job_id": job_id,
                "job_name": job_name,
                "customer": customer,
                "sale": sale,
                "sale_department": sale_department,
                "enduser": enduser,
                "job_date":job_date,
                "quotation_no": quotation_no,
                "job_type": job_type,
                "gp": gp,
                "est_cost": est_cost,
                "eng_cost": eng_cost,
                "cis_cost": cis_cost,
                "ais_cost": ais_cost,
                "total_cost": total_cost,
                "remaining_cost": remaining_cost,
                "process":str_process,
                "system": str_system,
                "md_rate": md_rate,
                "pd_rate": pd_rate,
                "status": status,
                "term_payment": term_payment,
                "term_payments": set_payments,
                "job_in_hand":job_in_hand,
                "job_eng_in_hand": job_eng_in_hand,
                "job_cis_in_hand": job_cis_in_hand,
                "job_ais_in_hand": job_ais_in_hand,
                "invoices":invoices,
                "due_date":due_date,
                "finished_date": finished_date,
                "warranty_period": warranty_period,
                "bank_guarantee": bank_guarantee,
                "bg_start": bg_start,
                "bg_finish": bg_finish,
                "retention": retention,
                "responsible": responsible,
                "note":note
            });

            if (update) {
                UpdateJob(job_string);
            }
            else {
                AddJob(job_string);
            }
        });

        $('#add_payment').on('click',function(){
            let _payment = $('#select_payment').val();
     
            let progress_work_no = set_payments.filter(p => p.payment_id.startsWith('STA009-'));
            let latestNum = 0;
            if (progress_work_no.length > 0) {
                progress_work_no.forEach(item => {
                    let parts = item.payment_id.split('-');
                    if (parts.length === 2) {
                        let num = parseInt(parts[1]);
                        if (!isNaN(num) && num > latestNum) {
                            latestNum = num;
                        }
                    }
                });
            }
            let nextNum = latestNum + 1;

            let payment = statuses.filter(f => f.status_id === _payment).map(m => m.status_name)[0];
            if (_payment === "STA009") {
                _payment = `${_payment}-${String(nextNum).padStart(2, '0')}`;
                payment = `${payment}-${String(nextNum).padStart(2, '0')}`;
            }
            
            let check_payment = set_payments.find(f => f.payment_name == payment);
            const job_id = $('#job_id').val();
            if (check_payment == undefined){
                set_payments.push({
                    'job_id': job_id,
                    'payment_id': _payment,
                    'payment_name': payment,
                    'percent': 0,
                    'forecast_month': '',
                    'remark': ''
                });

                //set_payments = paymentIdSort(set_payments);
                GenerateTablePayment();
            }

        });

        $('#add_process').on('click',function(){
            let _process = $('#select_process').val();
            let process = processes.filter(f=>f.process_id === _process ).map(m=>m.process_name)[0];
            let check_process = set_processes.find(f=>f.process_name == process);
            if (check_process == undefined){
                set_processes.push({'process_id': _process ,'process_name': process});
                GenerateTableProcess(set_processes);
            }
        });

        $('#add_system').on('click',function(){
            let _system = $('#select_system').val();
            let system = systems.filter(f=>f.system_id === _system ).map(m=>m.system_name)[0];
            let check_system = set_systems.find(f=>f.system_name == system);
            if (check_system == undefined){
                set_systems.push({'system_id': _system ,'system_name': system});
                GenerateTableSystem(set_systems);
            }
        });

        $('#select_payment').on('change',function(){
            $('#add_payment').attr('disabled',false);
        });

        $('#select_process').on('change',function(){
            $('#add_process').attr('disabled',false);
        });

        $('#select_system').on('change',function(){
            $('#add_system').attr('disabled',false);
        });

        @*$('#table_payment tbody').on('click', 'tr', async function () {
            let admin = '@Model.role' == "Admin" ? true : false;
            if (admin) {
                let data = table_payment.row(this).data();
                let payment = data[0];
                let percent = data[1];
                $('#edit_payment_name').val(payment);
                $('#edit_percent').val(percent);
                $('#modal_edit_payment').modal();
            }
        });*@

        $('#table_process tbody').on('click', 'tr', async function () {
            let admin = '@Model.role' == "Admin" ? true : false;
            if (admin) {
                let data = table_process.row(this).data();
                let process = data[0];
                $('#edit_process_name').val(process);
                $('#modal_edit_process').modal();
            }
        });

        $('#table_system tbody').on('click', 'tr', async function () {
            let admin = '@Model.role' == "Admin" ? true : false;
            if (admin) {
                let data = table_system.row(this).data();
                let system = data[0];
                $('#edit_system_name').val(system);
                $('#modal_edit_system').modal();
            }
        });

        $('#btn_payment_save').on('click',function(){
            let payment = $('#edit_payment_name').val();
            let payment_id = set_payments.filter(f=>f.payment_name == payment).map(m=>m.payment_id)[0];
            let percent = $('#edit_percent').val();

            let sum_percent = set_payments.filter(f=>f.payment_id !== payment_id).reduce((total, arg) => Number(total) + Number(arg.percent), 0);
            if (Number(sum_percent) + Number(percent) > 100){
                alert('percent more than 100 %');
            }else{
                let index = set_payments.findIndex(f=>f.payment_id == payment_id);
                set_payments[index].payment_id = payment_id;
                set_payments[index].payment_name = payment;
                set_payments[index].percent = percent;
                GenerateTablePayment();
                $('#modal_edit_payment').modal('hide');
            }

        });

        //$('#btn_payment_delete').on('click',function(){
        //    let payment = $('#edit_payment_name').val();
        //    let payment_id = set_payments.filter(f=>f.payment_name == payment).map(m=>m.payment_id)[0];

        //    let index = set_payments.findIndex(f=>f.payment_id == payment_id);
        //    set_payments.splice(index,1);
        //    GenerateTablePayment(set_payments);
        //    $('#modal_edit_payment').modal('hide');
        //});

        $('#btn_process_delete').on('click',function(){
            let process = $('#edit_process_name').val();
            let process_id = set_processes.filter(f=>f.process_name == process).map(m=>m.process_id)[0];

            let index = set_processes.findIndex(f=>f.process_id == process_id);
            set_processes.splice(index,1);
            GenerateTableProcess(set_processes);
            $('#modal_edit_process').modal('hide');
        });

        $('#btn_system_delete').on('click',function(){
            let system = $('#edit_system_name').val();
            let system_id = set_systems.filter(f=>f.system_name == system).map(m=>m.system_id)[0];

            let index = set_systems.findIndex(f=>f.system_id == system_id);
            set_systems.splice(index,1);
            GenerateTableSystem(set_systems);
            $('#modal_edit_system').modal('hide');
        });

        async function AddJob(job_string) {
            await $.ajax({
                type: "POST",
                url: '@Url.Action("AddJob", "Job")',
	            contentType: 'application/x-www-form-urlencoded',
                data: {
                    job_string
                },
                success: function (response) {
                    if (response === "Success") {
                        location.reload();
                    }
                    else {
                        alert(response);
                    }
                }
            });
        };

        async function UpdateJob(job_string) {
            await $.ajax({
                type: "PATCH",
                url: '@Url.Action("UpdateJob", "Job")',
	            contentType: 'application/x-www-form-urlencoded',
                data: {
                    job_string
                },
                success: function (response) {
                    if (response === "Success") {
                        location.reload();
                    }
                    else {
                        alert(response);
                    }
                }
            });
        }

        $('#add_invoice').on('click',function(){
            var today = new Date();
            var year = today.getFullYear();
            var month = (today.getMonth() + 1).toString().padStart(2,0);
            var day = today.getDate().toString().padStart(2,0);
            let date = year + "-" + month + "-" + day;
            let actual_date = new Date(1900,1,1).toISOString().split('T')[0];
            set_invoice.sort();
            let last_id = 0;
            if (set_invoice.length > 0){
                last_id = set_invoice[set_invoice.length-1].no;
                set_invoice.push({
                    'no': Number(last_id + 1),
                    'id': 0,
                    'milestone': "",
                    'invoice': 0,
                    'plan_date': date,
                    'actual_date': actual_date,
                    'new_plan_date': date,
                    'status': "",
                    'remark': ""
                });
            }else{
                set_invoice.push({
                    'no': 1,
                    'id': 0,
                    'milestone': "",
                    'invoice': 0,
                    'plan_date': date,
                    'actual_date': actual_date,
                    'new_plan_date': date,
                    'status': "",
                    'remark': ""
                });
            }

            GenerateTableInvoice(set_invoice);
        });

        $('#table_invoice tbody').on('click', 'tr', async function () {
            let data = table_invoice.row(this).data();
            let no = data[0];
            let id = data[1];
            let milestone = data[2];
            let invoice = data[3].replaceAll(',','');
            let plan_date = data[4];
            let actual_date = data[5];
            let new_plan_date = data[6];
            let status = data[7];
            let remark = data[8];
            let milestone_id = statuses.filter(f => f.status_name === milestone).map(m => m.status_id);
            $('#edit_invoice_no').val(no);
            $('#edit_invoice_id').val(id);
            $('#edit_invoice_milestone').val(milestone_id);
            $('#edit_invoice').val(invoice);
            $('#edit_invoice_plan_date').val(plan_date);
            $('#edit_invoice_actual_date').val(actual_date);
            $('#edit_invoice_new_plan_date').val(new_plan_date);
            $('#edit_invoice_status').val(status_invoices.findIndex(f=>f === status));
            $('#edit_invoice_remark').val(remark);
            $('#modal_edit_invoice').modal();
        });

        $('#edit_invoice_milestone').on('change', function () {
            let milestone = $('#edit_invoice_milestone').val();
            let data = statuses.filter(f => f.status_id === milestone).map(m => m)[0];
            let id = 0;
            if (typeof(data) !== "undefined") {
                id = data.no;
            }
            $('#edit_invoice_id').val(id);
        });

        $('#btn_invoice_save').on('click',function(){
            let no = $('#edit_invoice_no').val();
            let id = $('#edit_invoice_id').val();
            let invoice = $('#edit_invoice').val();
            let milestone = statuses.filter(f => f.status_id === $('#edit_invoice_milestone').val()).map(m => m.status_name)[0];
            let plan_date = $('#edit_invoice_plan_date').val();
            let actual_date = $('#edit_invoice_actual_date').val();
            let new_plan_date = $('#edit_invoice_new_plan_date').val();
            let status = status_invoices[$('#edit_invoice_status').val()];
            let remark = $('#edit_invoice_remark').val();
            let index = set_invoice.findIndex(f => f.no == no);
            set_invoice[index].id = id;
            set_invoice[index].invoice = invoice;
            set_invoice[index].milestone = milestone;
            set_invoice[index].plan_date = plan_date;
            set_invoice[index].actual_date = actual_date;
            set_invoice[index].new_plan_date = new_plan_date;
            set_invoice[index].status = status;
            set_invoice[index].remark = remark;

            set_invoice.sort((a, b) => a.id - b.id || a.no - b.no);
            GenerateTableInvoice(set_invoice);
            $('#modal_edit_invoice').modal('hide');
        });

        $('#btn_invoice_delete').on('click',function(){
            let no = $('#edit_invoice_no').val();

            let index = set_invoice.findIndex(f=>f.id == no);
            set_invoice.splice(index,1);
            GenerateTableInvoice(set_invoice);
            $('#modal_edit_invoice').modal('hide');
        });

        function GenerateTableInvoice(invoices) {
            $('#invoice').val(0);
            let datas = [];
            if (table_invoice !== null)
                $('#table_invoice').DataTable().destroy();

            for (let i = 0; i < invoices.length; i++) {
                let no = (i+1);
                let id = invoices[i].id;
                let milestone = invoices[i].milestone;
                let invoice = invoices[i].invoice;
                let plan_date = invoices[i].plan_date;
                let actual_date = invoices[i].actual_date;
                let new_plan_date = invoices[i].new_plan_date;
                let status = invoices[i].status;
                let remark = invoices[i].remark;

                set_invoice[i].no = (i + 1);
                datas.push([
                    no,
                    id,
                    milestone,
                    invoice.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","),
                    plan_date.split('T')[0],
                    actual_date.toString().split('T')[0],
                    new_plan_date.split('T')[0],
                    status,
                    remark
                ]);
            }

            table_invoice = $('#table_invoice').DataTable({
                data: datas,
                lengthMenu: [[25, 50, 100, -1], [25, 50, 100, "All"]],
                fixedHeader: true,
                fixedColumns: {
                    left: 2
                },
                columnDefs: [
                    {

                    },
                ],
                rowCallback: function (row, data) {
                    let sum_invoice = set_invoice.map(m=>Number(m.invoice)).reduce((acc,curr)=> acc+curr);
                    let sumStr = sum_invoice.toFixed(2);
                    let formatted = sumStr.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                    $('#invoice').val(formatted);
                },
                searching: false,
                ordering: false,
                paging: false,
                info : false
            });
        };

        function GenerateTableJobFile(job_files) {
            let _datas = [];
            _datas.push([
                "Quotation", job_files.quotation, ""
            ]);
            _datas.push([
                "PO", job_files.po, ""
            ]);
            _datas.push([
                "Hand Over", job_files.hand_over, ""
            ]);


            if (table_job_file !== undefined) {
                table_job_file.destroy();
            }
            table_job_file = $('#table_job_file').DataTable({
                data: _datas,
                columnDefs: [
                    {
                        targets: 1,
                        className: "dt-left"
                    },
                ],
                rowCallback: function (row, data) {
                    let job_id = $("#job_id").val();
                    let item = data[0];
                    $('td:eq(2)', row).html(`
                        <input type="button" class="btn btn-success" style="width:80px;font-size:12px" onclick="AddJobFile('${job_id}','${item}')" value="อัพเดทไฟล์" />
                    `);
                },
                searching: false,
                paging: false,
                info: false,
                order: false,
            });
        }
        $('#table_job_file tbody').on('click', 'td','tr', async function () {
            let col = table_job_file.cell(this)[0][0].column;
            let path = table_job_file.row(this).data()[1];
            if (col === 1) {
                window.open(path);
            }
        });

        async function AddJobFile(job_id, item) {
            await $.ajax({
                type: "POST",
                url: '@Url.Action("InsertFile", "Job")',
                contentType: 'application/x-www-form-urlencoded',
                data: { job_id, item },
                success: async function (response) {
                    if (response === "Success") {
                        $('#ImportJobFileModal').modal();
                    } else {
                        alert(response);
                    }
                }
            });
        }

        $('#importJobFile').on('change', async function (e) {
            if (e.target.files[0]) {
                let fdata = new FormData();
                let fileUpload = $('#importJobFile').get(0);
                let files = fileUpload.files;
                fdata.append(files[0].name, files[0]);
                $('#importJobFileName').text(files[0].name);

                await $.ajax({
                    type: "POST",
                    url: "Job/ImportJobfile",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("XSRF-TOKEN",
                            $('input:hidden[name="__RequestVerificationToken"]').val());
                    },
                    data: fdata,
                    contentType: false,
                    processData: false,
                    success: async function (response) {
                        if (response.length == 0)
                            alert('Some error occured while uploading');
                        else {
                            alert(response);
                            let job_id = $('#job_id').val();
                            await GetJobFile(job_id);
                            GenerateTableJobFile(job_files);
                            $('#ImportJobFileModal').modal('hide');
                        }
                    },
                });
            }
        });


        $("#job_id").on("input", function (e) {
            $(this).val(function (i, v) {
                return v.replace(/[^a-z0-9-_.]/gi, "");
            });
        });

        $('#btn_cal_gp').on('click', async function () {
            let job = $('#job_id').val();
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetJobsSummaryByJob", "Job")',
	            contentType: 'application/x-www-form-urlencoded',
                data: {
                    job
                },
                success: function (response) {
                    let use_cost = (parseFloat(response.eng_cost) + parseFloat(response.cis_cost) + parseFloat(response.ais_cost)) - parseFloat(response.remainingCost);
                    let remaining_cost = parseFloat($('#remaining_cost').val());
                    let est_cost = parseFloat($('#est_cost').val());
                    let total_cost = parseFloat($('#total_cost').val());
                    let gp = (((remaining_cost - use_cost - (total_cost - est_cost)) / est_cost) * 100.0).toFixed(1);
                    $('#gp_improve').val(gp);
                }
            });
        });

        $('#btn_export').on('click', function () {
            location.href = '@Url.Action("ExportJob", "Job")';
        });

        $('#chk_eng').on('change', async function () {
            let chk = document.getElementById("chk_eng").checked;
            let job_id = $('#job_id').val();
            let job_department = "ENG";
            if (job_id !== "") {
                if (chk === true) {
                    await $.ajax({
                        type: "POST",
                        url: '@Url.Action("InsertJobOwner", "Job")',
                        contentType: 'application/x-www-form-urlencoded',
                        data: {
                            job_id, job_department
                        },
                        success: function (response) {
                            alert(response);
                            $('#job_eng_in_hand').attr('disabled', false);
                            $('#eng_cost').attr('disabled', false);
                        }
                    });
                } else {
                    await $.ajax({
                        type: "DELETE",
                        url: '@Url.Action("DeleteJobOwner", "Job")',
                        contentType: 'application/x-www-form-urlencoded',
                        data: {
                            job_id, job_department
                        },
                        success: function (response) {
                            alert(response);
                            $('#job_eng_in_hand').attr('disabled', true);
                            $('#eng_cost').attr('disabled', true);
                        }
                    });
                }
                GetJobs(set_select);
            }
        });
        $('#chk_cis').on('change', async function () {
            let chk = document.getElementById("chk_cis").checked;
            let job_id = $('#job_id').val();
            let job_department = "CIS";
            if (job_id !== "") {
                if (chk === true) {
                    await $.ajax({
                        type: "POST",
                        url: '@Url.Action("InsertJobOwner", "Job")',
                        contentType: 'application/x-www-form-urlencoded',
                        data: {
                            job_id, job_department
                        },
                        success: function (response) {
                            alert(response);
                            $('#job_cis_in_hand').attr('disabled', false);
                            $('#cis_cost').attr('disabled', false);
                        }
                    });
                } else {
                    await $.ajax({
                        type: "DELETE",
                        url: '@Url.Action("DeleteJobOwner", "Job")',
                        contentType: 'application/x-www-form-urlencoded',
                        data: {
                            job_id, job_department
                        },
                        success: function (response) {
                            alert(response);
                            $('#job_cis_in_hand').attr('disabled', true);
                            $('#cis_cost').attr('disabled', true);
                        }
                    });
                }
                GetJobs(set_select);
            }
        });
        $('#chk_ais').on('change', async function () {
            let chk = document.getElementById("chk_ais").checked;
            let job_id = $('#job_id').val();
            let job_department = "AIS";
            if (job_id !== "") {
                if (chk === true) {
                    await $.ajax({
                        type: "POST",
                        url: '@Url.Action("InsertJobOwner", "Job")',
                        contentType: 'application/x-www-form-urlencoded',
                        data: {
                            job_id, job_department
                        },
                        success: function (response) {
                            alert(response);
                            $('#job_ais_in_hand').attr('disabled', false);
                            $('#ais_cost').attr('disabled', false);
                        }
                    });
                } else {
                    await $.ajax({
                        type: "DELETE",
                        url: '@Url.Action("DeleteJobOwner", "Job")',
                        contentType: 'application/x-www-form-urlencoded',
                        data: {
                            job_id, job_department
                        },
                        success: function (response) {
                            alert(response);
                            $('#job_ais_in_hand').attr('disabled', true);
                            $('#ais_cost').attr('disabled', true);
                        }
                    });
                }
                GetJobs(set_select);
            }
        });

        var expanded = false;
        function showColumnCheckboxes() {
            var checkboxes = document.getElementById("checkcolumnboxes");
            if (!expanded) {
                checkboxes.style.display = "block";
                expanded = true;
            } else {
                checkboxes.style.display = "none";
                expanded = false;
            }
        }

        function GenerateSelectCheckBox() {
            $('#checkcolumnboxes').empty();
            let str = `<div class="row">
                           <label for="SELECT_ENG" class="form-check-label pl-3">
                               <input type="checkbox" id="SELECT_ENG" value="ENG" onchange="SelectCheckChange('SELECT_ENG')" checked/>ENG</label>
                       </div>
                       <div class="row">
                           <label for="SELECT_CIS" class="form-check-label pl-3">
                               <input type="checkbox" id="SELECT_CIS" value="CIS" onchange="SelectCheckChange('SELECT_CIS')" checked/>CIS</label>
                       </div>
                        <div class="row">
                        <label for="SELECT_AIS" class="form-check-label pl-3">
                           <input type="checkbox" id="SELECT_AIS" value="AIS" onchange="SelectCheckChange('SELECT_AIS')" checked/>AIS</label>
                       </div>`;
            $('#checkcolumnboxes').append(str);
        }

        function SelectCheckChange(select) {
            let chk = $(`#${select}`).prop('checked');
            let value = $(`#${select}`).val();
            if (!chk) {
                const index = set_select.indexOf(value);
                if (index > -1) {
                    set_select.splice(index, 1);
                }
            } else {
                set_select.push(value);
            }
            GetJobs(set_select);
        };

    </script>
}