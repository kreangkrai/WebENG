@using Microsoft.AspNetCore.Http
@model WebENG.Models.UserModel;
@{
    ViewData["Title"] = "Calendar";
}
<link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

<style>
    .kanit-thin {
        font-family: "Kanit", sans-serif;
        font-weight: 100;
        font-style: normal;
    }

    .kanit-extralight {
        font-family: "Kanit", sans-serif;
        font-weight: 200;
        font-style: normal;
    }

    .kanit-light {
        font-family: "Kanit", sans-serif;
        font-weight: 300;
        font-style: normal;
    }

    .kanit-regular {
        font-family: "Kanit", sans-serif;
        font-weight: 400;
        font-style: normal;
    }

    .kanit-medium {
        font-family: "Kanit", sans-serif;
        font-weight: 500;
        font-style: normal;
    }

    .kanit-semibold {
        font-family: "Kanit", sans-serif;
        font-weight: 600;
        font-style: normal;
    }

    .kanit-bold {
        font-family: "Kanit", sans-serif;
        font-weight: 700;
        font-style: normal;
    }

    .kanit-extrabold {
        font-family: "Kanit", sans-serif;
        font-weight: 800;
        font-style: normal;
    }

    .kanit-black {
        font-family: "Kanit", sans-serif;
        font-weight: 900;
        font-style: normal;
    }

    .kanit-thin-italic {
        font-family: "Kanit", sans-serif;
        font-weight: 100;
        font-style: italic;
    }

    .kanit-extralight-italic {
        font-family: "Kanit", sans-serif;
        font-weight: 200;
        font-style: italic;
    }

    .kanit-light-italic {
        font-family: "Kanit", sans-serif;
        font-weight: 300;
        font-style: italic;
    }

    .kanit-regular-italic {
        font-family: "Kanit", sans-serif;
        font-weight: 400;
        font-style: italic;
    }

    .kanit-medium-italic {
        font-family: "Kanit", sans-serif;
        font-weight: 500;
        font-style: italic;
    }

    .kanit-semibold-italic {
        font-family: "Kanit", sans-serif;
        font-weight: 600;
        font-style: italic;
    }

    .kanit-bold-italic {
        font-family: "Kanit", sans-serif;
        font-weight: 700;
        font-style: italic;
    }

    .kanit-extrabold-italic {
        font-family: "Kanit", sans-serif;
        font-weight: 800;
        font-style: italic;
    }

    .kanit-black-italic {
        font-family: "Kanit", sans-serif;
        font-weight: 900;
        font-style: italic;
    }
    /* สไตล์สำหรับ input */
    input[type="text"] {
        transition: opacity 0.3s ease, background-color 0.3s ease; /* แอนิเมชันนุ่มนวล */
    }
        /* input ตอน disable */
        input[type="text"]:disabled {
            cursor: not-allowed;
        }
        /* input ตอน enable */
        input[type="text"]:not(:disabled) {
            opacity: 1;
        }
    /* สไตล์สำหรับ input */
    input[type="number"] {
        transition: opacity 0.3s ease, background-color 0.3s ease; /* แอนิเมชันนุ่มนวล */
    }
        /* input ตอน disable */
        input[type="number"]:disabled {
            cursor: not-allowed;
        }
        /* input ตอน enable */
        input[type="number"]:not(:disabled) {
            opacity: 1;
        }

    /* สไตล์สำหรับส่วนอัปโหลดไฟล์ */
    #uploadForm {
        transition: all 0.3s ease;
    }

        #uploadForm:hover {
            background: #e9ecef;
            border-color: #007bff;
        }

        #uploadForm.dragover {
            background: #e3f2fd;
            border-color: #007bff;
            transform: scale(1.02);
        }

    /* สไตล์สำหรับรายการไฟล์ */
    .file-item {
        padding: 10px 15px;
        border-bottom: 1px solid #e9ecef;
    }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item:hover {
            background: #f8f9fa;
        }

    .file-link {
        color: #007bff;
        text-decoration: none;
        transition: color 0.3s ease;
    }

        .file-link:hover {
            color: #0056b3;
            text-decoration: underline;
        }

    .delete-btn {
        transition: all 0.3s ease;
    }

        .delete-btn:hover {
            background: #dc3545;
            color: white;
            transform: translateY(-2px);
        }

    /* สไตล์สำหรับ dropzone */
    .dropzone {
        position: relative;
        transition: all 0.3s ease;
        cursor: pointer;
    }

        .dropzone:hover {
            background: #e9ecef;
            border-color: #007bff;
        }

        .dropzone.dragover {
            background: #e3f2fd;
            border-color: #007bff;
            transform: scale(1.02);
        }

        .dropzone input[type="file"] {
            z-index: 1000;
        }

    /* สไตล์สำหรับปุ่มเลือกไฟล์ */
    .select-file-btn {
        transition: all 0.3s ease;
    }

        .select-file-btn:hover {
            background: #007bff;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
            transform: translateY(-2px);
        }

    /* สไตล์สำหรับรายการไฟล์ */
    .file-item {
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
        transition: opacity 0.3s ease; /* ใช้ transition แทน keyframes */
    }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item:hover {
            background: #f8f9fa;
        }

        .file-item.added {
            background: #e3f2fd; /* Highlight สีฟ้าเมื่อเพิ่ม */
            opacity: 0; /* เริ่มจากโปร่งใส */
        }

            .file-item.added.show {
                opacity: 1; /* Fade-in ถึงทึบ */
            }

        .file-item.removing {
            background: #f8d7da; /* Highlight สีแดงเมื่อลบ */
            opacity: 0; /* Fade-out ถึงโปร่งใส */
        }

    .file-link {
        color: #007bff;
        text-decoration: none;
        transition: color 0.3s ease;
    }

        .file-link:hover {
            color: #0056b3;
            text-decoration: underline;
        }

    .delete-btn {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        transition: all 0.3s ease;
    }

        .delete-btn:hover {
            background: #dc3545;
            color: white;
            transform: translateY(-2px);
        }

        .delete-btn i {
            font-size: 14px;
        }

    /* Responsive design */
    .responsive-file-item {
        flex-direction: column;
        align-items: flex-start;
    }

    .responsive-delete-btn {
        margin-top: 10px;
    }

    .responsive-select-file-btn {
        width: 100%;
    }

    /* สไตล์สำหรับส่วนผู้อนุมัติ */
    .approver-item {
        padding: 12px 15px;
        border-bottom: 1px solid #dee2e6;
        transition: all 0.3s ease; /* เหมือน dropzone */
    }

        .approver-item:last-child {
            border-bottom: none;
        }

        .approver-item:hover {
            background: #f8f9fa; /* Highlight เหมือน file-item */
            transform: translateY(-2px); /* ยกขึ้นเล็กน้อย */
        }

        .approver-item i {
            font-size: 16px;
        }

    #approver-note {
        font-size: 14px;
        background: #e9ecef;
        border-bottom: 1px solid #dee2e6;
    }

    .badge {
        font-size: 14px;
        padding: 8px 12px;
        border-radius: 12px; /* ขอบโค้งทันสมัย */
    }

    .badge-warning {
        background-color: #ffc107; /* รออนุมัติ = เหลือง */
    }

    .badge-success {
        background-color: #28a745; /* อนุมัติ = เขียว */
    }

    .badge-danger {
        background-color: #dc3545; /* ไม่อนุมัติ = แดง */
    }
</style>
<div class="row p-3">
    <div class="col-xl-12">
        <div class="card">
            <div class="card-body">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<!-- Task Modal -->
<div class="modal" id="modal_task" tabindex="-1" role="dialog" aria-hidden="true" style="overflow-y:hidden">
    <div class="modal modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal_task_title">Add Tasks</h5>
                <button type="button" id="task_close" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="overflow-y:auto">
                <form>
                    <div class="form-group" hidden>
                        <label for="user_id">User</label>
                        <select id="user_id" class="form-control" disabled></select>
                    </div>
                    <div id="working_date_group" class="form-group row">
                        <div class="col-4 col-md-4">
                            <label for="working_hour_id">Working Hours</label>
                            <input id="working_hour_id" type="text" class="form-control" disabled />
                        </div>
                        <div class="col-4 col-md-4">
                            <label for="working_date">Date</label>
                            <input id="working_date" type="date" class="form-control" disabled />
                        </div>
                        <div class="col-4 col-md-4pt-5">
                            <label for="leave">Leave</label>
                            <input id="leave" class="btn btn-primary form-control" type="button" value="ยื่นวันลา" />

                        </div>
                    </div>
                    <div id="date_group" class="form-group row">
                        <div class="col-6 col-md-6">
                            <label for="start_date">From</label>
                            <input id="start_date" type="date" class="form-control" />
                        </div>
                        <div class="col-6 col-md-6">
                            <label for="stop_date">To</label>
                            <input id="stop_date" type="date" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="row">
                            <div id="form_customers" class="col-6 col-md-6">
                                <label for="customers">Filter By Customers</label>
                                <select id="customers" class="form-control"></select>
                            </div>
                            <div id="form_job" class="col-6 col-md-6">
                                <label for="job_id">Job</label>
                                <select id="job_id" class="form-control"></select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-6 col-md-6">
                            <label for="process">Process</label>
                            <select id="process" class="form-control"></select>
                        </div>
                        <div class="col-6 col-md-6">
                            <label for="system">System</label>
                            <select id="system" class="form-control"></select>
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-6 col-md-6">
                            <label for="location">Location</label>
                            <select id="location" class="form-control"></select>
                        </div>
                        <div class="col-6 col-md-6">
                            <label for="task_id">Task</label>
                            <select id="task_id" class="form-control"></select>
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-4 col-md-4">
                            <label for="start_time">From</label>
                            <input id="start_time" type="time" class="form-control" />
                        </div>
                        <div class="col-4 col-md-4">
                            <label for="stop_time">To</label>
                            <input id="stop_time" type="time" class="form-control" />
                        </div>
                        <div class="col-2 col-md-2 pt-4">
                            <div class="form-check">
                                <input id="lunch_full" class="form-check-input" type="checkbox" checked />
                                <label class="form-check-label">Lunch Full</label>
                            </div>
                            <div class="form-check">
                                <input id="lunch_half" class="form-check-input" type="checkbox" />
                                <label class="form-check-label">Lunch Half</label>
                            </div>
                        </div>
                        <div class="col-2 col-md-2 pt-4">
                            <div class="form-check">
                                <input id="dinner_full" class="form-check-input" type="checkbox" />
                                <label class="form-check-label">Break Full</label>
                            </div>
                            <div class="form-check">
                                <input id="dinner_half" class="form-check-input" type="checkbox" />
                                <label class="form-check-label">Break Half</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-12 col-md-12">
                            <div class="form-group">
                                <label for="note">Note</label>
                                <textarea id="note" class="form-control" rows="2" placeholder="Note or Description"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer d-flex">
                <button type="button" id="btn_delete" class="btn btn-danger elevation-1">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <button type="button" class="btn btn-secondary elevation-1" data-dismiss="modal">
                    <i class="fas fa-times"></i> Close
                </button>
                <button id="btn_accept" type="button" class="btn btn-primary elevation-1">
                    <i class="fas fa-check"></i> Accept
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Alert -->
<div class="modal fade" id="modal_alert" tabindex="-1" role="dialog" data-backdrop="static">
    <div class="modal modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="modal_alert_title">Alert</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="alert_content" class="form-group">

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Delete -->
<div id="modal_delete" class="modal fade">
    <div class="modal modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger">
                <h5 class="modal-title" id="modal_alert_title">Delete</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <span>Are you sure you want to delete this ?</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer d-flex">
                <button id="btn_confirm_delete" type="button" class="btn btn-danger elevation-1 mr-auto">
                    <i class="fas fa-trash-alt"></i> Confirm Delete
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal_leave" tabindex="-1" role="dialog" aria-hidden="true" style="overflow-y:hidden">
    <div class="modal modal-dialog modal-dialog-centered modal-md" role="document">
        <div class="modal-content kanit-regular">
            <div class="modal-header" style="background: linear-gradient(90deg, rgba(33, 120, 190, 1) 0%, rgba(40, 71, 95, 1) 100%); color: white; border-bottom: none">
                <h5 class="modal-title" id="modal_leave_title">ยื่นการลา</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" style="color: white;">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="div_main_leave" style="height:100px;color:#555555">
                <form>
                    <div class="form-group row">
                        <div class="col-xl-6 col-md-6 col-sm-12 ">
                            <label for="request_id">ประเภทการลา</label>
                            <select id="select_leave_type" class="form-control">
                            </select>
                        </div>
                        <div class="col-xl-6 col-md-6 col-sm-12">
                            <label for="working_date">ช่วงเวลา</label>
                            <div class="row">
                                <div class="btn-group" role="group" aria-label="Basic example">
                                    <button id="leave_full" type="button" class="btn btn-outline-primary">ทั้งวัน</button>
                                    <button id="leave_half" type="button" class="btn btn-outline-info">ครึ่งวัน</button>
                                    <button id="leave_hours" type="button" class="btn btn-outline-secondary">รายชั่วโมง</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="div_leave" hidden>
                        <div class="row">
                            <div div class="col-8">
                                <label class="kanit-bold">สิทธิ์การลา</label>
                            </div>
                            <div div class="col-4 d-flex justify-content-end">
                                <span id="leave_balance" class="kanit-light"></span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-xl-12 col-md-12 col-sm-12">
                                <div class="card collapsed-card">
                                    <div class="card-header" style=" background: #EEE;cursor:pointer" data-card-widget="collapse">
                                        <div class="row">
                                            <div class="col-11 d-flex justify-content-end">
                                                <span class="kanit-bold" style="color:#555;">เงื่อนไขการลา</span>
                                            </div>
                                            <div class="col-1 d-flex justify-content-end">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <div class="card-tools">
                                                            <button type="button" class="btn btn-tool" style="color:#555 ; font-size:20px">
                                                                <i class="fas fa-chevron-down"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row" style="row-gap:1px">
                                            <div class="col-12">
                                                <div class="row">
                                                    <div class="col-12">
                                                        <span id="leave_description" class="kanit-light">

                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="leave_date_group" class="form-group row">
                            <div class="col-xl-4 col-md-6 col-sm-6">
                                <label for="leave_start_date">ลาตั้งแต่วันที่</label>
                                <input id="leave_start_date" type="date" class="form-control" />
                            </div>
                            <div class="col-xl-4 col-md-4 col-sm-12">
                                <label for="amount_leave">ลาจำนวน</label>
                                <div class="input-group">
                                    <input id="amount_leave" type="number" class="form-control" style="text-align:end" value="1" min="1" max="100" />
                                    <div class="input-group-append">
                                        <span class="input-group-text">วัน</span>
                                    </div>
                                </div>
                            </div>
                            <fieldset disabled class="col-xl-4 col-md-6 col-sm-6">
                                <label for="leave_stop_date">ถึงวันที่</label>
                                <input id="leave_stop_date" type="date" class="form-control" />
                            </fieldset>
                        </div>
                        <div id="leave_time_group" class="form-group row">
                            <div class="col-xl-4 col-md-4 col-sm-12">
                                <label>ระยะเวลา</label>
                                <div class="input-group">
                                    <select id="select_leave_hours_duration" class="form-control">
                                    </select>
                                </div>
                            </div>
                            <div class="col-xl-4 col-md-4 col-sm-6">
                                <label for="leave_start_time">ตั้งแต่เวลา</label>
                                @*<input id="leave_start_time" type="time" class="form-control" />*@
                                <div class="d-flex gap-2">
                                    <select id="leave_start_hour" class="form-control" style="width: auto;"></select>
                                    <span class="align-self-center">:</span>
                                    <select id="leave_start_minute" class="form-control" style="width: 80px;">
                                        <option value="00">00</option>
                                        <option value="30">30</option>
                                    </select>
                                </div>
                            </div>
                            <fieldset disabled class="col-xl-4 col-md-4 col-sm-6">
                                <label for="leave_stop_time">ถึงเวลา</label>
                                <input id="leave_stop_time" type="time" class="form-control" />
                            </fieldset>
                        </div>
                        <div class="form-group row">
                            <div class="col-12">
                                <div class="form-group">
                                    <label for="leave_note">รายละเอียด</label>
                                    <textarea id="leave_note" class="form-control" rows="2" placeholder="Note or Description"></textarea>
                                </div>
                            </div>
                        </div>

                        <hr />

                        <!-- ส่วนอัปโหลดไฟล์ -->
                        <div id="leave_date_group" class="form-group row">
                            <div class="col-12">
                                <label for="uploadForm" class="kanit-medium">แนบไฟล์</label>
                                <div id="uploadForm" class="card p-3 mb-3 dropzone" style="border: 2px dashed #ccc; border-radius: 10px; background: #f8f9fa; min-height: 120px; position: relative;">
                                    <div class="text-center">
                                        <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                        <p class="kanit-regular text-muted">ลากไฟล์มาวางที่นี่ หรือคลิกเพื่อเลือกไฟล์ <br />(.pdf, .jpg, .png, .xls, .xlsx)</p>
                                        <input type="file" id="leave_fileInput" name="files" accept=".pdf,.jpg,.png,.xls,.xlsx" multiple style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 1000;" />
                                        <button type="button" id="selectFileBtn"
                                                class="btn btn-outline-primary btn-md kanit-medium select-file-btn"
                                                style="position: relative; z-index: 1001; cursor: pointer; border-radius:5px; ">
                                            เลือกไฟล์
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ส่วนแสดงรายการไฟล์ -->
                        <div id="leave_fileList" class="form-group row">
                            <div class="col-12">
                                <label class="kanit-medium">เอกสารที่แนบ</label>
                                <div class="card" style="border-radius: 10px; overflow: hidden;">
                                    <div class="list-group" id="leave_fileListContainer">
                                        <!-- ตัวอย่างไฟล์ -->
                                        @*<div class="list-group-item d-flex align-items-center file-item">
                            <i class="fas fa-file-image text-primary mr-2"></i>
                            <a href="#" class="file-link kanit-regular flex-grow-1">File_001.png</a>
                            <button type="button" class="btn btn-outline-danger btn-sm delete-btn" style="border-radius: 50%;" data-file="File_001.png" title="ลบไฟล์">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                        <div class="list-group-item d-flex align-items-center file-item">
                            <i class="fas fa-file-pdf text-danger mr-2"></i>
                            <a href="#" class="file-link kanit-regular flex-grow-1">File_002.pdf</a>
                            <button type="button" class="btn btn-outline-danger btn-sm delete-btn" style="border-radius: 50%;" data-file="File_002.pdf" title="ลบไฟล์">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>*@
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-------------------------------------------------------------------------------------------------------------------------------->
                        <hr />
                        <div class="form-group row">
                            <div class="col-12">
                                <label for="leave_approvers" class="kanit-medium">ผู้อนุมัติ</label>
                                <div class="card" style="border-radius: 10px; overflow: hidden;">
                                    <!-- ข้อความแนะนำ (ถ้ามีผู้จัดการ 2 คน) -->
                                    <div class="p-3 kanit-regular text-muted" id="approver-note" style="display: none;">
                                        <i class="fas fa-info-circle mr-2"></i>เลือกอนุมัติโดย 1 ใน 2 ผู้จัดการด้านล่าง
                                    </div>
                                    <div class="list-group" id="approverList">
                                        <!-- ผู้อนุมัติคนที่ 1 -->
                                        <div class="list-group-item d-flex align-items-center approver-item">
                                            <div class="col-6">
                                                <i class="fas fa-user-check mr-2 text-primary"></i>
                                                <span class="kanit-regular">Chakrit R.</span>
                                            </div>
                                            <div class="col-6">
                                                <span class="kanit-regular text-muted">Manager</span>
                                            </div>
                                        </div>
                                        <!-- ผู้อนุมัติคนที่ 2 (ถ้ามี) -->
                                        <div class="list-group-item d-flex align-items-center approver-item">
                                            <div class="col-6">
                                                <i class="fas fa-user-check mr-2 text-primary"></i>
                                                <span class="kanit-regular">Kriangkrai R.</span>
                                            </div>
                                            <div class="col-6">
                                                <span class="kanit-regular text-muted">Manager</span>
                                            </div>
                                        </div>
                                        <!-- ผู้อนุมัติคนที่ 3 -->
                                        <div class="list-group-item d-flex align-items-center approver-item">
                                            <div class="col-6">
                                                <i class="fas fa-user-check mr-2 text-primary"></i>
                                                <span class="kanit-regular">Siriporn S.</span>
                                            </div>
                                            <div class="col-6">
                                                <span class="kanit-regular text-muted">Admin</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer d-flex">
                <button type="button" class="btn btn-secondary elevation-1" data-dismiss="modal">
                    <i class="fas fa-times"></i> ยกเลิก
                </button>
                <button id="btn_leave_send" type="button" class="btn btn-primary elevation-1" disabled>
                    <i class="fas fa-check"></i> ส่งเอกสาร
                </button>
            </div>
        </div>
    </div>
</div>
@section Scripts
{
    <script type="text/javascript">
        //Variable Declaration
        let users = [];
        let jobs = [];
        let processes = [];
        let systems = [];
        let quotations = [];
        let tasks = [];
        let holidays = [];
        let wh_day = [];
        let calendar;
        let calendarEl;
        let update = false;
        let drag = false;
        let overlap = true;
        let eng;
        let last_id = 0;
        let list_process_system = [];
        //Change these variable to true for show data response
        let debug_user = false;
        let debug_jobs = false;
        let debug_quotations = false;
        let debug_tasks = false;
        let debug_holiday = false;
        let debug_whs = false;
        let debug_whs_datas = false;
        let debug_accept = false;
        let debug_wh_day = false;
        let debug_edit = false;
        let debug_drop = false;

        $(document).ready(async function () {
            await GetHolidays();
            await GetEngineerUser("@Model.name.ToLower()");
            await GetWorkingHours("@Model.name.ToLower()");
            await GetProcessSystemByUser("@Model.user_id.ToLower()");
            await GetUsers();
            await GetJobs();
            await GetTasks();
        });

        async function GetProcessSystemByUser(user){
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetProcessSystemByUser", "Calendar")',
	            contentType: 'application/x-www-form-urlencoded',
                data: { user },
                success: function (response) {
                    list_process_system = response;
                }
            });
        }

        async function GetLastWorkingHoursID() {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetLastWorkingHoursID", "WorkingHours")',
	            contentType: 'application/x-www-form-urlencoded',
                data: { },
                success: function (response) {
                    last_id = response;
                }
            });
        }
        async function GetProcess(job_id) {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetProcessesByJob", "EngProcess")',
	            contentType: 'application/x-www-form-urlencoded',
                data: { job_id },
                success: function (response) {
                    processes = response;
                }
            });
        }
        async function GetSystem(job_id) {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetSystemsByJob", "EngSystem")',
	            contentType: 'application/x-www-form-urlencoded',
                data: { job_id },
                success: function (response) {
                    systems = response;
                }
            });
        }
        async function GetUsers() {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetUsers", "Calendar")',
	            contentType: 'application/x-www-form-urlencoded',
                data: { },
                success: function (response) {
                    users = response;
                    if (debug_user) {
                        console.log(users);
                    }
                }
            });
        }

        async function GetJobs() {
            let user_name = '@Model.name.ToLower()';
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetJobs", "Calendar")',
	            contentType: 'application/x-www-form-urlencoded',
                data: { user_name },
                success: function (response) {
                    jobs = response;
                    if (debug_jobs) {
                        console.log("Jobs");
                        console.log(jobs);
                    }
                }
            });
        };

        async function GetQuotations() {
            let user_name = '@Model.name.ToLower()';
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetQuotations", "Calendar")',
	            contentType: 'application/x-www-form-urlencoded',
                data: { user_name },
                success: function (response) {
                    quotations = response;
                    if (debug_quotations) {
                        console.log("Quotations");
                        console.log(quotations);
                    }
                }
            });
        };

        async function GetTasks() {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetAllTasks", "Tasks")',
	            contentType: 'application/x-www-form-urlencoded',
                data: { },
                success: function (response) {
                    tasks = response;
                    if (debug_tasks) {
                        console.log("Tasks");
                        console.log(tasks);
                    }
                }
            });
        };

        async function GetHolidays() {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetHolidays", "Holiday")',
	            contentType: 'application/x-www-form-urlencoded',
                data: { },
                success: function (response) {
                    holidays = response;
                    if (debug_holiday) {
                        console.log("Holidays");
                        console.log(holidays);
                    }
                }
            });
        };

        async function GetWorkingHours(user_name) {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetWorkingHours", "Calendar")',
	            contentType: 'application/x-www-form-urlencoded',
                data: { user_name },
                success: function (response) {
                    if (debug_whs) {
                        console.log("Working Hours Data");
                        console.log(response);
                    }
                    GenerateCalendar(response);
                }
            });
        };

        async function GetWorkingHoursByDate(user_name ,working_date) {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetWorkingHoursByDate", "Calendar")',
	            contentType: 'application/x-www-form-urlencoded',
                data: {
                    user_name, working_date
                },
                success: function (response) {
                    wh_day = response;
                    if (debug_wh_day) {
                        console.log(wh_day);
                    }
                }
            });
        }

        async function GenerateCalendar(whs) {
            let datas = [];
            for (let i = 0; i < whs.length; i++) {
                let start_date = new Date(whs[i].working_date);
                let enable_edit = false;

                if (eng.role === "Admin" || eng.allow_edit === true) {
                    enable_edit = true;
                } else {
                    let today = new Date();
                    let date_diff = Math.floor((today - start_date) / (1000 * 60 * 60 * 24));
                    enable_edit = date_diff < 15 ? true : false;
                }

                datas.push(
                    {
                        title: whs[i].job_name + ": " + whs[i].task_name,
                        start: start_date.setHours(whs[i].start_time.split(":")[0], whs[i].start_time.split(":")[1]),
                        end: start_date.setHours(whs[i].stop_time.split(":")[0], whs[i].stop_time.split(":")[1]),
                        allDay: false,
                        editable: enable_edit,
                        overlap: true,
                        extendedProps: {
                            "index": whs[i].index,
                            "user_id": whs[i].user_id,
                            "user_name": whs[i].user_name,
                            "working_date": whs[i].working_date,
                            "job_id": whs[i].job_id,
                            "job_name": whs[i].job_name,
                            "process_id": whs[i].process_id,
                            "process_name":whs[i].process_name,
                            "system_id":whs[i].system_id,
                            "system_name":whs[i].system_name,
                            "task_id": whs[i].task_id,
                            "task_name": whs[i].task_name,
                            "start_time": whs[i].start_time,
                            "stop_time": whs[i].stop_time,
                            "wh_type": whs[i].wh_type,
                            "lunch_full": whs[i].lunch_full,
                            "lunch_half": whs[i].lunch_half,
                            "dinner_full": whs[i].dinner_full,
                            "dinner_half": whs[i].dinner_half,
                            "note": whs[i].note,
                        }
                    }
                );
            }

            if (debug_whs_datas) {
                console.log("Calendar Working Hours Data");
                console.log(datas);
            }

            calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                views: {
                    dayGridMonth: {
                        displayEventTime: true,
                        displayEventEnd: true,
                        eventTimeFormat: {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false,
                            meridiem: false
                        },
                    }
                },
                headerToolbar: {
                    left: 'dayGridMonth,listMonth,timeGridWeek,timeGridDay',
                    center: 'title',
                    right: 'prev,next'
                },
                events: datas,
                height: 750,
                editable: true,
                eventDrop: async function (info) {
                    let enable = false;
                    let drop_date = new Date(info.event.startStr.split("T")[0]);
                    let today = new Date();
                    let date_diff = Math.floor((today - drop_date) / (1000 * 60 * 60 * 24));
                    let drop_overlap = await CheckDropOverlap(info.event.extendedProps, drop_date.toISOString().split("T")[0]);
                    if (drop_overlap === true) {
                        $('#modal_alert_title').text('Alert Task Overlap');
                        $('#alert_content').html('<p>Task Overlap</p>');
                        $('#modal_alert').modal();
                        info.revert();
                        return;
                    }

                    if (date_diff < 15) {
                        enable = true;
                    }
                    else {
                        enable = CheckAllowEditable();
                    }

                    if (enable == true) {
                        DropTask(info.event);
                    }
                    else {
                        $('#modal_alert_title').text('Alert Edit Task');
                        $('#alert_content').html('<p>You are not allow to edit task in beyond past 2 weeks</p>');
                        $('#modal_alert').modal();
                        info.revert();
                    }
                },
                selectable: true,
                select: function (info) {
                    let date_start = info.startStr;
                    let date_end = info.endStr.split("-")[0] + "-" + info.endStr.split("-")[1] + "-" + parseInt(info.endStr.split("-")[2] - 1).toString().padStart(2,'0');
                    let date_diff = Math.floor((new Date(date_end) - new Date(date_start)) / (1000 * 60 * 60 * 24));
                    if (date_diff === 0 || isNaN(date_diff)) {
                        AddTask(date_start)
                    }
                    else {
                        AddTasks(date_start,date_end)
                    }
                },
                eventClick: async function (info) {
                    EditTask(info.event);
                },
            });

            let weekend = [
                {
                    daysOfWeek: [0, 6],
                    display: 'background',
                    color: "#CCCCCC",
                    allDay: true,
                    overlap: true,
                    resourceEditable: false
                }
            ];
            calendar.addEventSource(weekend);

            let e_holidays = [];
            for (let i = 0; i < holidays.length; i++) {
                e_holidays.push(
                    {
                        id: (i+1),
                        title: holidays[i].detail,
                        start: holidays[i].date.split("T")[0],
                        display: 'background',
                        color: "#FF9999",
                        allDay: true,
                        overlap: true,
                        resourceEditable: false
                    }
                );
            }

            calendar.addEventSource(e_holidays);
            calendar.render();
        }

        async function GenerateProcessOption(processes) {
            $('#process').empty();
            $('#process').append(`<option value="" selected disabled>Please Select Process</option>`);
            for (let i = 0; i < processes.length; i++) {
                $('#process').append(`<option value="${processes[i].process_id}">${processes[i].process_id}: ${processes[i].process_name}</option>`);
            }
        }

        async function GenerateSystemOption(systems) {
            $('#system').empty();
            $('#system').append(`<option value="" selected disabled>Please Select System</option>`);
            for (let i = 0; i < systems.length; i++) {
                $('#system').append(`<option value="${systems[i].system_id}">${systems[i].system_id}: ${systems[i].system_name}</option>`);
            }
        }

        function GenerateUsersOption() {
            $('#user_id').empty();
            let user_string = `<option value="" selected disabled>Please Select User</option>`;
            for (let i = 0; i < users.length; i++) {
                user_string += `<option value="${users[i].user_id}">${users[i].name}</option>`;
            }
            $('#user_id').append(user_string);
        }

        function GenerateCustomerOptions() {
            let customers = jobs.map(m => m.customer);
            for (let i = 0; i < quotations.length; i++) {
                customers.push(quotations[i].map(m => m.customer));
            }
            customers = customers.filter(f => f !== "");
            customers = [...new Set(customers)];
            customers.sort();
            $('#customers').empty();
            $('#customers').append(`<option value="" selected>ALL</option>`);
            for (let i = 0; i < customers.length; i++) {
                $('#customers').append(`<option value="${customers[i]}">${customers[i]}</option>`);
            }
        }

        $('#customers').on('change', function () {
            GenerateJobsOption();
        });

        function GenerateJobsOption() {
            let customer = $('#customers').val();
            $('#job_id').empty();
            $('#job_id').append(`<option value="" selected disabled>Please Select Job</option>`);
            for (let i = 0; i < jobs.length; i++) {
                if (jobs[i].customer === customer || customer === "") {
                    $('#job_id').append(`<option value="${jobs[i].job_id}">${jobs[i].job_id}: ${jobs[i].job_name}</option>`);
                }
            }
            for (let i = 0; i < quotations.length; i++) {
                if (quotations[i].customer === customer || customer === "") {
                    $('#job_id').append(`<option value="${quotations[i].quotation_no}">${quotations[i].quotation_no}: ${quotations[i].project_name}</option>`);
                }
            }
        }

        function GenerateTasksOption() {
            let tasks_str = `<option value="" selected disabled>Please Select Task</option>`;
            for (let i = 0; i < tasks.length; i++) {
                tasks_str += `<option value="${tasks[i].task_id}">${tasks[i].task_name}</option>`;
            }
            $('#task_id').empty();
            $('#task_id').append(tasks_str);
        }

        async function CheckAllowEditable() {
            let user_name = '@Model.name.ToLower()';
            let allow = false;
            await $.ajax({
                type: "GET",
                url: '@Url.Action("CheckAllowEditable", "Calendar")',
	            contentType: 'application/x-www-form-urlencoded',
                data: { user_name },
                success: function (response) {
                    allow = response;
                }
            });
            return allow;
        }

        async function AddTask(date_start) {
            let show_modal = 0;
            let today = new Date();
            let edit_date = new Date(date_start);
            let date_diff = Math.floor((today - edit_date) / (1000 * 60 * 60 * 24));

            if (date_diff < 15) {
                show_modal = 1;
            }
            else {
                show_modal = await CheckAllowEditable();
            }

            if (show_modal) {
                update = false;
                if (wh_day !== null) {
                    wh_day = [];
                }
                await GetLastWorkingHoursID();
                await GetUsers();
                await GenerateUsersOption();
                await GetWorkingHoursByDate("@Model.name.ToLower()", date_start);
                await GetJobs();
                await GetQuotations();
                await GenerateCustomerOptions();
                await GenerateJobsOption();
                await GenerateLocationOption();
                await GetTasks();
                await GenerateTasksOption();
                await PrepmodalTask(date_start);
            }
        }

        async function AddTasks(date_start, date_end) {
            let show_modal = 0;
            let today = new Date();
            let edit_date = new Date(date_start);
            let date_diff = Math.floor((today - edit_date) / (1000 * 60 * 60 * 24));

            if (date_diff < 15) {
                show_modal = 1;
            }
            else {
                show_modal = await CheckAllowEditable();
            }

            if (show_modal) {
                update = false;
                await GetLastWorkingHoursID();
                await GetUsers();
                await GenerateUsersOption();
                await GetJobs();
                await GetQuotations();
                await GenerateCustomerOptions();
                await GenerateJobsOption();
                await GenerateLocationOption();
                await GetTasks();
                await GenerateTasksOption();
                PrepmodalTasks(date_start, date_end);

            }
        }

        function GenerateLocationOption() {
            $('#location').empty();
            let location_str = '<option value="" selected disabled>Please Select Location</option>';
            location_str += '<option value="O">Office</option>';
            location_str += '<option value="S">Site</option>';
            location_str += '<option value="T">Other</option>';
            location_str += '<option value="H">Home</option>';
            $('#location').append(location_str);
        }

        function PrepmodalTask(date_start) {
            $('#modal_task').modal();
            $('#modal_task_title').text("Add Task");
            let user_name = '@Model.name.ToLower()';
            let user_id = users.filter(f => f.name.toLowerCase() === user_name).map(m => m.user_id);
            $('#working_hour_id').val(last_id);
            $('#user_id').val(user_id);
            $('#working_date_group').show();
            $('#working_date').attr('disabled', true);
            $('#working_date').val(date_start);
            $('#date_group').hide();
            $('#start_date').val(null);
            $('#stop_date').val(null);
            $('#start_time').val(null);
            $('#stop_time').val(null);
            $('#note').val(null);
            $('#btn_delete').hide();
        }

        function PrepmodalTasks(date_start, date_end) {
            $('#modal_task').modal();
            $('#modal_task_title').text("Add Tasks");
            let user_name = '@Model.name.ToLower()';
            let user_id = users.filter(f => f.name.toLowerCase() === user_name).map(m => m.user_id);
            $('$working_hour_id').val(last_id);
            $('#user_id').val(user_id);
            $('#working_date_group').hide();
            $('#working_date').attr('disabled', true);
            $('#working_date').val(null);
            $('#date_group').show();
            $('#start_date').val(date_start);
            $('#stop_date').val(date_end);
            $('#location').attr('disabled', true);
            $('#task_id').attr('disabled', true);
            $('#start_time').val("08:30");
            $('#stop_time').val("17:30");
            $('#note').val(null);
            $('#btn_delete').hide();
        }
        $('#leave').on('change',function(){
            let status_leave = document.getElementById("leave").checked;
            if (status_leave){
                $('#form_customers').hide();
                $('#form_job').hide();

                document.getElementById("job_id").value = "J999999";
                document.getElementById("process").value = "PRO999";
                document.getElementById("system").value = "SYS999";
                document.getElementById("location").value = "T";
                document.getElementById("task_id").value = "T002";
                document.getElementById("start_time").value = "08:30";
                document.getElementById("stop_time").value = "17:30";

                document.getElementById("leave").checked = true;
            }else{
                $('#form_customers').show();
                $('#form_job').show();

                document.getElementById("job_id").selectedIndex = 0;
                document.getElementById("process").selectedIndex = 0;
                document.getElementById("system").selectedIndex = 0;
                document.getElementById("location").selectedIndex = 0;
                document.getElementById("task_id").selectedIndex = 0;
                document.getElementById("start_time").value = null;
                document.getElementById("stop_time").value = null;
                document.getElementById("leave").checked = false;
            }
        });

        $('#job_id').on('change', async function () {
            let job_id = $('#job_id').val();
            let enable_location = (job_id !== "") ? 1 : 0;
            $('#location').attr('disabled', !enable_location);

            let job = list_process_system.filter(f=>f.job_id == job_id).map(m=>m)[0];
            let _processes = job.processes;
            let _systems = job.systems;

            await GenerateProcessOption(_processes);
            await GenerateSystemOption(_systems);
        });

        $('#location').on('change', function () {
            let prefix = $('#location').val();
            let arr = tasks.filter(t => t.task_id.substring(0, 1) === prefix);
            let tasks_str = '<option value="" selected disabled>Please Select Task</option>';
            for (let i = 0; i < arr.length; i++) {
                tasks_str += '<option value="' + arr[i].task_id + '">' + arr[i].task_name + '</option>';
            }
            $('#task_id').empty();
            $('#task_id').append(tasks_str);
            let en = $('#job_id').val() !== "" ? true : false;
            $('#task_id').attr('disabled', !en);
        });

        $('#task_id').on('change', function () {
            let en = $('#job_id').val() !== "" ? true : false;
            en *= $('#task_id').val() !== "" ? true : false;
            if (en) {
                $('#start_time').attr('disabled', !en);
                if (wh_day.length === 0) {
                    $('#start_time').val("08:30");
                    $('#stop_time').attr('disabled', false);
                    $('#stop_time').val("17:30");
                }
            }
            else {
                $('#start_time').attr('disabled', !en);
                $('#start_time').val();
            }
        });

        $('#start_time').on('change focus', function () {

            let start_time = $('#start_time').val();
            document.getElementById("stop_time").min = start_time;
            $('#stop_time').attr('disabled', false);
            $('#stop_time').val(start_time);
            let date = new Date($('#working_date').val());
            date.setHours($('#start_time').val().split(":")[0]);
            date.setMinutes($('#start_time').val().split(":")[1]);
            if (date.getDay() == 0 || date.getDay() == 7) {
                $('#wh_type').val("OT1_5");
            } else if (date.getHours() >= 17 && date.getMinutes() >= 30) {
                $('#wh_type').val("OT1_5");
            }
        });

        $('#stop_time').on('change focus', function () {
            let start = $('#start_time').val();
            let stop = $('#stop_time').val();
            let minute_start = 0;
            let minute_stop = 0;
            if (start !== "") {
                let hours = parseInt(start.split(':')[0]);
                let minute = parseInt(start.split(':')[1]);
                minute_start = (hours * 60) + minute;
            }

            let hours_stop = parseInt(stop.split(':')[0]);
            let minutes_stop = parseInt(stop.split(':')[1]);
            minute_stop = (hours_stop * 60) + minutes_stop;
            if (minute_start > minute_stop) {
                //alert('เวลาไม่ถูกต้อง');
                $('#stop_time').val(null);
            }

            var [hours_start, minutes_start] = start.split(':');
            let total_minute_start = (parseInt(hours_start) * 60) + parseInt(minutes_start);
            let total_minute_stop = (parseInt(hours_stop) * 60) + parseInt(minutes_stop);
            if (total_minute_start > 720 && total_minute_stop > 720) {  // > 12:00
                $('#lunch_full').attr('checked', false);
                $('#lunch_half').attr('checked', false);
                $('#lunch_full').attr('disabled', true);
                $('#lunch_half').attr('disabled', true);

                if (total_minute_stop > 1050) {  // > 17:30
                    $('#dinner_full').attr('checked', true);
                    $('#dinner_half').attr('checked', false);
                    $('#dinner_full').attr('disabled', false);
                    $('#dinner_half').attr('disabled', false);
                }
            } else {
                $('#lunch_full').attr('checked', true);
                $('#lunch_half').attr('checked', false);
                $('#lunch_full').attr('disabled', false);
                $('#lunch_half').attr('disabled', false);

            }

            if (total_minute_start <= 720 && total_minute_stop <= 720) {  // < 12:00
                $('#dinner_full').attr('checked', false);
                $('#dinner_half').attr('checked', false);
                $('#dinner_full').attr('disabled', true);
                $('#dinner_half').attr('disabled', true);

                $('#lunch_full').attr('checked', false);
                $('#lunch_half').attr('checked', false);
                $('#lunch_full').attr('disabled', true);
                $('#lunch_half').attr('disabled', true);

            } else {
                $('#dinner_full').attr('checked', true);
                $('#dinner_half').attr('checked', false);
                $('#dinner_full').attr('disabled', false);
                $('#dinner_half').attr('disabled', false);
            }

            if (total_minute_start > 1050 && total_minute_stop > 1050) {  // < 12:00
                $('#dinner_full').attr('checked', true);
                $('#dinner_half').attr('checked', false);
                $('#dinner_full').attr('disabled', false);
                $('#dinner_half').attr('disabled', false);
            } else {
                $('#dinner_full').attr('checked', false);
                $('#dinner_half').attr('checked', false);
                $('#dinner_full').attr('disabled', true);
                $('#dinner_half').attr('disabled', true);
            }

            if (total_minute_stop > 1050) {  // > 17:30
                $('#dinner_full').attr('checked', true);
                $('#dinner_half').attr('checked', false);
                $('#dinner_full').attr('disabled', false);
                $('#dinner_half').attr('disabled', false);
            }
        });

        $('#btn_accept').on('click', async function () {
            let user_id = $('#user_id').val();
            let working_date = $('#working_date').val();
            let wh_index = $('#working_hour_id').val();

            let start_date = $('#start_date').val();
            let stop_date = $('#stop_date').val();
            let job_id = "";
            let status_leave = document.getElementById("leave").checked;
            if (status_leave){
                job_id = "J999999";
            }else{
                job_id = $('#job_id').val();
            }
            let process = $('#process').val();
            let system = $('#system').val();

            let task_id = $('#task_id').val();
            let start_time = $('#start_time').val();
            let stop_time = $('#stop_time').val();
            let lunch_full = $('#lunch_full').prop('checked');
            let lunch_half = $('#lunch_half').prop('checked');
            let dinner_full = $('#dinner_full').prop('checked');
            let dinner_half = $('#dinner_half').prop('checked');
            let note = $('#note').val();

            if (debug_accept) {
                console.log("Add Task");
                console.log("User ID -> " + user_id);
                console.log("Date -> " + working_date);
                console.log("Job -> " + job_id);
                console.log("Task -> " + task_id);
                console.log("From -> " + start_time);
                console.log("To -> " + stop_time);
                console.log("Note -> " + note);
            }

            if (update) {
                let wh_string = JSON.stringify({
                    "index": wh_index,
                    "user_id": user_id,
                    "working_date": working_date,
                    "job_id": job_id,
                    "process_id": process,
                    "system_id": system,
                    "task_id": task_id,
                    "start_time": start_time,
                    "stop_time": stop_time,
                    "lunch_full":lunch_full,
                    "lunch_half":lunch_half,
                    "dinner_full":dinner_full,
                    "dinner_half":dinner_half,
                    "note": note,
                });

                let enable_edit = false;
                if (eng.role === "Admin" || eng.allow_edit === true) {
                    enable_edit = true;
                } else {
                    let today = new Date();
                    let date_diff = Math.floor((today - working_date) / (1000 * 60 * 60 * 24));
                    enable_edit = date_diff < 15 ? true : false;
                }

                if (enable_edit) {
                    await UpdateWorkingHours(wh_string);
                }
                else {
                    $('#modal_alert_title').text('Alert Edit Task');
                    $('#alert_content').html('<p>You are not allow to edit task in beyond past 2 weeks</p>');
                    $('#modal_alert').modal();
                }
            }
            else {
                if (working_date !== "") {
                    let wh_string = JSON.stringify({
                        "index": wh_index,
                        "user_id": user_id,
                        "working_date": working_date,
                        "job_id": job_id,
                        "process_id": process,
                        "system_id": system,
                        "task_id": task_id,
                        "start_time": start_time,
                        "stop_time": stop_time,
                        "lunch_full":lunch_full,
                        "lunch_half":lunch_half,
                        "dinner_full":dinner_full,
                        "dinner_half":dinner_half,
                        "note": note,
                    });
                    await AddWorkingHours(wh_string);
                }
                else {
                    let wh_strings = [];
                    let date_start = new Date(start_date);
                    let date_stop = new Date(stop_date);
                    for (let cur_date = date_start; cur_date <= date_stop; cur_date.setDate(cur_date.getDate() + 1)){
                        let task_overlap = false;
                        let wh_string = JSON.stringify({
                            "index": wh_index,
                            "user_id": user_id,
                            "working_date": cur_date,
                            "job_id": job_id,
                            "process_id": process,
                            "system_id": system,
                            "task_id": task_id,
                            "start_time": start_time,
                            "stop_time": stop_time,
                            "lunch_full":lunch_full,
                            "lunch_half":lunch_half,
                            "dinner_full":dinner_full,
                            "dinner_half":dinner_half,
                            "note": note,
                        });
                        task_overlap = await CheckAddTasksOverlap(wh_string);
                        if (task_overlap === false) {
                            wh_strings.push(wh_string);
                        }
                    }
                    await AddWorkingHoursDays(wh_strings);
                }
            }
        });


        $('#btn_delete').on('click', function () {
            $('#modal_delete').modal();
        });

        $('#btn_confirm_delete').on('click', async function () {
            let user_id = $('#user_id').val();
            let wh_index = $('#working_hour_id').val();
            let working_date = $('#working_date').val();
            let job_id = "";
            let status_leave = document.getElementById("leave").checked;
            if (status_leave){
                job_id = "J999999";
            }else{
                job_id = $('#job_id').val();
            }

            let process = $('#process').val();
            let system = $('#system').val();
            let task_id = $('#task_id').val();
            let start_time = $('#start_time').val();
            let stop_time = $('#stop_time').val();
            let wh_type = ($('#wh_type').val() === "") ? "REG" : $('#wh_type').val();

            let lunch_full = $('#lunch_full').prop('checked');
            let lunch_half = $('#lunch_half').prop('checked');
            let dinner_full = $('#dinner_full').prop('checked');
            let dinner_half = $('#dinner_half').prop('checked');
            let note = $('#note').val();

            let wh_string = JSON.stringify({
                "index": wh_index,
                "user_id": user_id,
                "working_date": working_date,
                "job_id": job_id,
                "process_id": process,
                "system_id": system,
                "task_id": task_id,
                "start_time": start_time,
                "stop_time": stop_time,
                "wh_type": wh_type,
                "lunch_full":lunch_full,
                "lunch_half":lunch_half,
                "dinner_full":dinner_full,
                "dinner_half":dinner_half,
                "note": note,
            });
            await DeleteWorkingHours(wh_string);
        })

        async function CheckAddOverlap(wh_string) {
            let task = JSON.parse(wh_string);
            let date = task.working_date;
            let start_time = new Date();
            start_time.setHours(task.start_time.split(":")[0]);
            start_time.setMinutes(task.start_time.split(":")[1]);
            start_time.setSeconds(0);
            start_time.setMilliseconds(0);
            let stop_time = new Date();
            stop_time.setHours(task.stop_time.split(":")[0]);
            stop_time.setMinutes(task.stop_time.split(":")[1]);
            stop_time.setSeconds(0);
            stop_time.setMilliseconds(0);
            await GetWorkingHoursByDate("@Model.name", date);
            if (update) {
                wh_day = wh_day.filter(f => f.index !== task.index);
            }
            for (let i = 0; i < wh_day.length; i++) {
                let task_start = new Date();
                let task_stop = new Date();
                task_start.setHours(wh_day[i].start_time.split(":")[0]);
                task_start.setMinutes(wh_day[i].start_time.split(":")[1]);
                task_start.setSeconds(0);
                task_start.setMilliseconds(0);
                task_stop.setHours(wh_day[i].stop_time.split(":")[0]);
                task_stop.setMinutes(wh_day[i].stop_time.split(":")[1]);
                task_stop.setSeconds(0);
                task_stop.setMilliseconds(0);
                if (start_time >= task_start && start_time < task_stop) {
                    return true;
                }
                if (stop_time > task_start && stop_time < task_stop) {
                    return true;
                }
                if (task_start >= start_time && task_start < stop_time) {
                    return true;
                }
                if (task_stop > start_time && task_stop < stop_time) {
                    return true;
                }
            }
            return false;
        }

        async function CheckAddTasksOverlap(wh_string) {
            let task = JSON.parse(wh_string);
            let date = task.working_date;
            let start_time = new Date();
            start_time.setHours(task.start_time.split(":")[0]);
            start_time.setMinutes(task.start_time.split(":")[1]);
            start_time.setSeconds(0);
            start_time.setMilliseconds(0);
            let stop_time = new Date();
            stop_time.setHours(task.stop_time.split(":")[0]);
            stop_time.setMinutes(task.stop_time.split(":")[1]);
            stop_time.setSeconds(0);
            stop_time.setMilliseconds(0);
            await GetWorkingHoursByDate("@Model.name", date);
            for (let i = 0; i < wh_day.length; i++) {
                let task_start = new Date();
                let task_stop = new Date();
                task_start.setHours(wh_day[i].start_time.split(":")[0]);
                task_start.setMinutes(wh_day[i].start_time.split(":")[1]);
                task_start.setSeconds(0);
                task_start.setMilliseconds(0);
                task_stop.setHours(wh_day[i].stop_time.split(":")[0]);
                task_stop.setMinutes(wh_day[i].stop_time.split(":")[1]);
                task_stop.setSeconds(0);
                task_stop.setMilliseconds(0);
                if (start_time >= task_start && start_time < task_stop) {
                    return true;
                }
                if (stop_time > task_start && stop_time < task_stop) {
                    return true;
                }
                if (task_start >= start_time && task_start < stop_time) {
                    return true;
                }
                if (task_stop > start_time && task_stop < stop_time) {
                    return true;
                }
            }
            return false;
        }

        async function CheckDropOverlap(task, date) {
            let start_time = new Date();
            start_time.setHours(task.start_time.split(":")[0]);
            start_time.setMinutes(task.start_time.split(":")[1]);
            start_time.setSeconds(0);
            start_time.setMilliseconds(0);
            let stop_time = new Date();
            stop_time.setHours(task.stop_time.split(":")[0]);
            stop_time.setMinutes(task.stop_time.split(":")[1]);
            stop_time.setSeconds(0);
            stop_time.setMilliseconds(0);
            await GetWorkingHoursByDate("@Model.name", date);
            for (let i = 0; i < wh_day.length; i++) {
                let task_start = new Date();
                task_start.setHours(wh_day[i].start_time.split(":")[0]);
                task_start.setMinutes(wh_day[i].start_time.split(":")[1]);
                task_start.setSeconds(0);
                task_start.setMilliseconds(0);
                let task_stop = new Date();
                task_stop.setHours(wh_day[i].stop_time.split(":")[0]);
                task_stop.setMinutes(wh_day[i].stop_time.split(":")[1]);
                task_stop.setSeconds(0);
                task_stop.setMilliseconds(0);
                if (start_time >= task_start && start_time < task_stop) {
                    return true;
                }
                if (stop_time > task_start && stop_time < task_stop) {
                    return true;
                }
                if (task_start >= start_time && task_start < stop_time) {
                    return true;
                }
                if (task_stop > start_time && task_stop < stop_time) {
                    return true;
                }
            }
            return false;
        }

        async function GetEngineerUser(user_name) {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetEngineerUser", "Calendar")',
	            contentType: 'application/x-www-form-urlencoded',
                data: { user_name },
                success: function (response) {
                    eng = response;
                }
            });
        }

        async function EditTask(event) {
            update = true;
            let user_id = event.extendedProps.user_id;
            let user_name = users.filter(f => f.user_id === user_id).map(m => m.name.toLowerCase());
            let date = event.extendedProps.working_date;

            let job_id = event.extendedProps.job_id;

            let job = list_process_system.filter(f=>f.job_id == job_id).map(m=>m)[0];
            if (job_id !== "J999999"){
                let _processes = job.processes;
                let _systems = job.systems;

                await GenerateProcessOption(_processes);
                await GenerateSystemOption(_systems);
            }else{
                $('#process').empty();
                $('#system').empty();
            }
            await GetUsers();
            await GenerateUsersOption();
            await GetWorkingHoursByDate(user_name, date.split("T")[0]);
            await GetJobs();
           // await GetQuotations();
            await GenerateCustomerOptions();
            await GenerateJobsOption();
            await GenerateLocationOption();

            PrepmodalEditTask(event.extendedProps);

        }

        function DropTask(event) {
            drag = true;
            let task = event.extendedProps;
            task.working_date = event.startStr.split("T")[0];
            let wh_string = JSON.stringify({
                "index": task.index,
                "user_id": task.user_id,
                "working_date": event.startStr.split("T")[0],
                "job_id": task.job_id,
                "task_id": task.task_id,
                "start_time": task.start_time,
                "stop_time": task.stop_time,
                "wh_type": task.wh_type,
                "lunch_full": task.lunch_full,
                "lunch_half": task.lunch_half,
                "dinner_full": task.dinner_full,
                "dinner_half": task.dinner_half,
                "note": task.note,
            });
            UpdateWorkingHours(wh_string);
            event.setExtendedProp("working_date", event.startStr.split("T")[0]);
        }

        async function PrepmodalEditTask(task) {
            let status_leave = task.task_name;
            if (status_leave === "Leave"){
                $('#form_customers').hide();
                $('#form_job').hide();
                document.getElementById("job_id").value = "J999999";
                document.getElementById("process").value = "PRO000";
                document.getElementById("system").value = "SYS000";
                document.getElementById("location").value = "T";
                document.getElementById("task_id").value = "T002";
                document.getElementById("leave").checked = true;
            }else{

                $('#form_customers').show();
                $('#form_job').show();

                document.getElementById("job_id").selectedIndex = 0;
                document.getElementById("process").selectedIndex = 0;
                document.getElementById("system").selectedIndex = 0;
                document.getElementById("location").selectedIndex = 0;
                document.getElementById("task_id").selectedIndex = 0;

                document.getElementById("leave").checked = false;
            }

            $('#job_id').val(task.job_id);
            await GetTasks();
            await GenerateTasksOption();
            $('#location').val(task.task_id[0]);
            $('#task_id').val(task.task_id);
            $('#process').val(task.process_id);
            $('#system').val(task.system_id);
            if (debug_edit) {
                console.log(task);
            }
            $('#modal_task').modal();
            $('#modal_task_title').text("Edit Task");
            $('#working_hour_id').val(task.index);
            $('#user_id').val(task.user_id);
            $('#working_date_group').show();
            $('#working_date').val(task.working_date.split("T")[0]);
            $('#date_group').hide();
            $('#start_date').val(null);
            $('#stop_date').val(null);
            $('#start_time').val(task.start_time);
            $('#stop_time').val(task.stop_time);
            $('#lunch_full').prop('checked',task.lunch_full);
            $('#lunch_half').prop('checked',task.lunch_half);
            $('#dinner_full').prop('checked',task.dinner_full);
            $('#dinner_half').prop('checked',task.dinner_half);
            $('#note').val(task.note);
            $('#btn_delete').show();
        }

        async function AddWorkingHours(wh_string) {
            let add_overlap = await CheckAddOverlap(wh_string);
            if (add_overlap === false) {
                await $.ajax({
                    type: "POST",
                    url: '@Url.Action("AddWorkingHours", "Calendar")',
                    contentType: 'application/x-www-form-urlencoded',
                    data: {
                        wh_string
                    },
                    success: function (response) {
                        if (response == "Success") {
                            location.reload();
                        }
                        else {
                            toastr.error(response);
                        }
                    }
                });
            } else {
                $('#modal_alert_title').text('Alert Task Overlap');
                $('#alert_content').html('<p>Task Overlap</p>');
                $('#modal_alert').modal();
            }
        }

        async function AddWorkingHoursDays(wh_strings) {
            await $.ajax({
                type: "POST",
                url: '@Url.Action("AddWorkingHoursDays", "Calendar")',
	            contentType: 'application/x-www-form-urlencoded',
                data: {
                    wh_strings
                },
                success: function (response) {
                    if (response == "Success") {
                        location.reload();
                    }
                    else {
                        toastr.error(response);
                    }
                }
            });
        }

        async function UpdateWorkingHours(wh_string) {
            let edit_overlap = await CheckAddOverlap(wh_string);
            if (edit_overlap === false) {
                await $.ajax({
                    type: "PATCH",
                    url: '@Url.Action("EditWorkingHours", "Calendar")',
	                contentType: 'application/x-www-form-urlencoded',
                    data: {
                        wh_string
                    },
                    success: function (response) {
                        if (response == "Success") {
                            if(!drag)
                                location.reload();
                        }
                        else {
                            alert(response);
                        }
                    }
                });
            }
            else {
                $('#modal_alert_title').text('Alert Task Overlap');
                $('#alert_content').html('<p>Task Overlap</p>');
                $('#modal_alert').modal();
            }
        }

        async function DeleteWorkingHours(wh_string) {
            await $.ajax({
                type: "DELETE",
                url: '@Url.Action("DeleteWorkingHours", "Calendar")',
	            contentType: 'application/x-www-form-urlencoded',
                data: {
                    wh_string
                },
                success: function (response) {
                    if (response == "Success")
                        location.reload();
                }
            });
        }

        $('#lunch_full').on('click',function(){
            $('#lunch_half').prop('checked',false);
        });
        $('#lunch_half').on('click',function(){
            $('#lunch_full').prop('checked',false);
        });
        $('#dinner_full').on('click',function(){
            $('#dinner_half').prop('checked',false);
        });
        $('#dinner_half').on('click',function(){
            $('#dinner_full').prop('checked',false);
        });


    </script>

    <script>

        let leaves = [];
        let balance_entitlement;
        let path_file = [];

        const hourSelect = document.getElementById('leave_start_hour');
        $(document).ready(function () {
            
        });

        // 08-15
        for (let h = 8; h <= 15; h++) {
            const option = document.createElement('option');
            option.value = String(h).padStart(2, '0');
            option.textContent = String(h).padStart(2, '0');
            hourSelect.appendChild(option);
        }
        hourSelect.value = '08';
        // Leave

        $('#leave').on('click', async function () {
            $('#modal_leave').modal();
            $('#modal_task').modal('hide');
            $('#leave_start_date').val($('#working_date').val());
            $('#leave_stop_date').val($('#working_date').val());
            $('#div_leave').prop('hidden', true);
            $('#div_main_leave').css('height', '100px');
            $('#div_main_leave').css('overflow-y', 'hidden');
            $('#btn_leave_send').prop('disabled', true);
            await GetLeaveType();
        });

        $('#select_leave_type').on('change', function () {
            let leave_type_id = $('#select_leave_type').val();
            let description = leaves.filter(f => f.leave_type_id === leave_type_id).map(m => m.description)[0];
            let entitlement = balance_entitlement.entitlements.filter(f => f.leave_type_id === leave_type_id).map(m => m)[0];
            $('#leave_description').text(description);
            $('#leave_balance').text(entitlement.balance + '/' + entitlement.amount + ' วัน');
            $('#div_leave').prop('hidden', false);
            $('#div_main_leave').css('height', '600px');
            $('#div_main_leave').css('overflow-y', 'auto');
            $('#btn_leave_send').prop('disabled', false);
        });

        $('#amount_leave').on('change', function () {
            let start = new Date($('#leave_start_date').val());
            let amount = parseInt($('#amount_leave').val());

            start.setDate(start.getDate() + amount - 1);
            const day = String(start.getDate()).padStart(2, '0');
            const month = String(start.getMonth() + 1).padStart(2, '0');
            const year = start.getFullYear();
            $('#leave_stop_date').val(`${year}-${month}-${day}`);
        });

        document.addEventListener('DOMContentLoaded', function () {

            const leaveFullBtn = document.getElementById('leave_full');
            const leaveHalfBtn = document.getElementById('leave_half');
            const leaveHoursBtn = document.getElementById('leave_hours');
            const dateGroup = document.getElementById('leave_date_group');
            const timeGroup = document.getElementById('leave_time_group');
            const durationSelect = timeGroup.querySelector('select');
            const startHourTimeInput = document.getElementById('leave_start_hour');
            const startMinuteTimeInput = document.getElementById('leave_start_minute');
            const startDateInput = document.getElementById('leave_start_date');
            const stopTimeInput = document.getElementById('leave_stop_time');
            const stopDateInput = document.getElementById('leave_stop_date');
            const daysInput = dateGroup.querySelector('input[type="number"]'); // ช่องลาจำนวน
            // ฟังก์ชันรีเซ็ตการเลือกปุ่ม (ลบ active class)
            function resetButtonStyles() {
                leaveFullBtn.classList.remove('active');
                leaveHalfBtn.classList.remove('active');
                leaveHoursBtn.classList.remove('active');
            }
            // ฟังก์ชันจัดการตัวเลือกใน select สำหรับ leave_half
            function setHalfDayOptions() {
                durationSelect.innerHTML = `
                        <option value=""selected disabled>Select</option>
                        <option value="morning">ครึ่งวันเช้า</option>
                        <option value="afternoon">ครึ่งวันบ่าย</option>
                    `;
                startHourTimeInput.value = '08';
                startMinuteTimeInput.value = '00';
                stopTimeInput.value = '';
                startHourTimeInput.disabled = false;
                startMinuteTimeInput.disabled = false;
                daysInput.value = 0;
                stopDateInput.value = startDateInput.value;
                // เพิ่ม event listener สำหรับการเปลี่ยนแปลงใน select
                durationSelect.onchange = function () {
                    if (this.value === 'morning') {
                        startHourTimeInput.value = '08';
                        startMinuteTimeInput.value = '30';
                        stopTimeInput.value = '12:00';
                        startHourTimeInput.disabled = true;
                        startMinuteTimeInput.disabled = true;
                    } else if (this.value === 'afternoon') {
                        startHourTimeInput.value = '13';
                        startMinuteTimeInput.value = '00';
                        stopTimeInput.value = '17:30';
                        startHourTimeInput.disabled = true;
                        startMinuteTimeInput.disabled = true;
                    } else {
                        startHourTimeInput.value = '08';
                        startMinuteTimeInput.value = '30';
                        stopTimeInput.value = '';
                        startHourTimeInput.disabled = false;
                        startMinuteTimeInput.disabled = false;
                    }
                };
            }
            // ฟังก์ชันจัดการตัวเลือกใน select สำหรับ leave_hours
            function setHourlyOptions() {
                durationSelect.innerHTML = `
                        <option value="" selected disabled>Select</option>
                        <option value="2">2 ชั่วโมง</option>
                        <option value="4">4 ชั่วโมง</option>
                        <option value="6">6 ชั่วโมง</option>
                    `;
                startHourTimeInput.value = '08';
                startMinuteTimeInput.value = '30';
                stopTimeInput.value = '';
                startHourTimeInput.disabled = false;
                startMinuteTimeInput.disabled = false;
                daysInput.value = 0;
                stopDateInput.value = startDateInput.value;
                // รีเซ็ตค่าเวลาและ enable start_time เมื่อเปลี่ยนเป็นรายชั่วโมง
                durationSelect.onchange = function () {
                    
                    calculateTime();
                    startHourTimeInput.disabled = false; 
                    startMinuteTimeInput.disabled = false;
                };

                startHourTimeInput.onchange = function () {
                    calculateTime();
                };

                startMinuteTimeInput.onchange = function () {
                    calculateTime();
                };
            }
            // ฟังก์ชันจัดการ animation เมื่อแสดงหรือซ่อน
            function toggleGroupDisplay(group, show) {
                if (show) {
                    group.style.display = 'flex';
                    group.style.opacity = '0';
                    group.style.transition = 'opacity 0.3s ease-in-out';
                    setTimeout(() => {
                        group.style.opacity = '1';
                    }, 10);
                } else {
                    group.style.opacity = '0';
                    group.style.transition = 'opacity 0.3s ease-in-out';
                    setTimeout(() => {
                        group.style.display = 'none';
                        // รีเซ็ตค่าใน time_group เมื่อซ่อน
                        if (group === timeGroup) {
                            startHourTimeInput.value = '';
                            startMinuteTimeInput.value = '';
                            stopTimeInput.value = '';
                            durationSelect.value = '';
                            startHourTimeInput.disabled = false; // Enable start_time
                            startMinuteTimeInput.disabled = false; // Enable start_time
                        }
                    }, 300);
                }
            }
            // เมื่อกดปุ่ม "ทั้งวัน"
            leaveFullBtn.addEventListener('click', function () {
                resetButtonStyles();
                leaveFullBtn.classList.add('active');
                toggleGroupDisplay(dateGroup, true);
                toggleGroupDisplay(timeGroup, false);
                daysInput.disabled = false;
                daysInput.value = 1;
                stopDateInput.value = startDateInput.value;
            });
            // เมื่อกดปุ่ม "ครึ่งวัน"
            leaveHalfBtn.addEventListener('click', function () {
                resetButtonStyles();
                leaveHalfBtn.classList.add('active');
                toggleGroupDisplay(dateGroup, true); // แสดง date_group
                toggleGroupDisplay(timeGroup, true); // แสดง time_group
                setHalfDayOptions(); // เปลี่ยนตัวเลือกเป็นครึ่งวันเช้า/บ่าย
                daysInput.disabled = true; // DISABLE ลาจำนวน
            });
            // เมื่อกดปุ่ม "รายชั่วโมง"
            leaveHoursBtn.addEventListener('click', function () {
                resetButtonStyles();
                leaveHoursBtn.classList.add('active');
                toggleGroupDisplay(dateGroup, true); // แสดง date_group
                toggleGroupDisplay(timeGroup, true); // แสดง time_group
                setHourlyOptions(); // เปลี่ยนตัวเลือกเป็นรายชั่วโมง
                daysInput.disabled = true; // DISABLE ลาจำนวน
            });

            // เริ่มต้นด้วยการเลือก "ทั้งวัน" เป็นค่าเริ่มต้น
            function timeToMinutes(timeStr) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            }

            function calculateTime() {
                let first = timeToMinutes("08:30");
                let last = timeToMinutes("17:30");
                let duration = parseInt(durationSelect.value);
                let start = startHourTimeInput.value + ':' + startMinuteTimeInput.value;
                if (timeToMinutes(start) >= first && timeToMinutes(start) <= last) {
                    let [hours, minutes] = start.split(':').map(Number);
                    let date = new Date(startDateInput.value);
                    date.setHours(hours);
                    date.setMinutes(minutes);
                    date.setSeconds(0);

                    date.setHours(date.getHours() + duration);
                    if (timeToMinutes(date.toTimeString().split(' ')[0]) <= last) {
                        let stopHours = String(date.getHours()).padStart(2, '0');
                        let stopMinutes = String(date.getMinutes()).padStart(2, '0');
                        let stopTime = `${stopHours}:${stopMinutes}`;
                        stopTimeInput.value = stopTime;
                    } else {
                        alert('ใส่เวลาผิด');
                        startHourTimeInput.value = '08';
                        startMinuteTimeInput.value = '30';
                        stopTimeInput.value = '';
                    }
                } else {
                    alert('ใส่เวลาผิด');
                    startHourTimeInput.value = '08';
                    startMinuteTimeInput.value = '30';
                    stopTimeInput.value = '';
                }
            }
            leaveFullBtn.click();
        });

        document.addEventListener('DOMContentLoaded', function () {

            const fileInput = document.getElementById('leave_fileInput');
            const selectFileBtn = document.getElementById('selectFileBtn');
            const uploadForm = document.getElementById('uploadForm');
            const fileListContainer = document.getElementById('leave_fileListContainer');
       
            if (!fileInput || !selectFileBtn || !uploadForm || !fileListContainer) {
                console.error('ไม่พบ element');
                return;
            }

            selectFileBtn.addEventListener('click', (e) => {
                e.preventDefault();
                fileInput.click();
            });

            //Drag & Drop
            ['dragenter', 'dragover'].forEach(event => {
                uploadForm.addEventListener(event, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    uploadForm.classList.add('dragover');
                });
            });

            ['dragleave', 'drop'].forEach(event => {
                uploadForm.addEventListener(event, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    uploadForm.classList.remove('dragover');
                    if (event === 'drop') handleFiles(e.dataTransfer.files);
                });
            });

            fileInput.addEventListener('change', () => {
                handleFiles(fileInput.files);
                fileInput.value = '';
            });

            //Delete File
            fileListContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('.delete-btn');
                if (!btn) return;

                const fileItem = btn.closest('.file-item');
                const fileName = btn.dataset.file;

                path_file = path_file.filter(name => name !== fileName);

                fileItem.classList.add('removing');
                setTimeout(() => fileItem.remove(), 300);

                console.log('ลบไฟล์:', fileName, 'เหลือ:', path_file);
            });

            
            function handleFiles(files) {
                if (!files || files.length === 0) return;

                for (let file of files) {
                    const fileType = file.name.split('.').pop().toLowerCase();
                    const allowedTypes = ['pdf', 'jpg', 'png', 'xls', 'xlsx'];

                    if (!allowedTypes.includes(fileType)) {
                        showAlert(`ประเภทไฟล์ไม่ถูกต้อง: ${file.name}`);
                        continue;
                    }

                    if (path_file.includes(file.name)) {
                        showAlert(`ไฟล์ "${file.name}" มีอยู่แล้ว`);
                        continue;
                    }

                    path_file.push(file.name);

                    const fileItem = createFileItem(file.name, fileType);
                    fileListContainer.appendChild(fileItem);

                    setTimeout(() => fileItem.classList.add('show'), 10);
                    setTimeout(() => fileItem.classList.remove('added'), 1000);
                }
            }

            //UI File
            function createFileItem(fileName, fileType) {
                const fileItem = document.createElement('div');
                fileItem.className = 'list-group-item d-flex align-items-center file-item added';
                fileItem.innerHTML = `
            <i class="fas fa-file-${fileType === 'pdf' ? 'pdf text-danger' : 'image text-primary'} mr-2"></i>
            <a href="#" class="file-link kanit-regular flex-grow-1">${fileName}</a>
            <button type="button" class="btn btn-outline-danger btn-sm delete-btn" style="border-radius: 50%;" data-file="${fileName}" title="ลบไฟล์">
                <i class="fas fa-trash-alt"></i>
            </button>
        `;
                return fileItem;
            }

            //Load old FIle
            window.loadExistingFiles = function (existingFileNames) {
                fileListContainer.innerHTML = '';
                path_file = [];

                if (!Array.isArray(existingFileNames)) return;

                existingFileNames.forEach(fileName => {
                    const fileType = fileName.split('.').pop().toLowerCase();
                    const allowedTypes = ['pdf', 'jpg', 'png', 'xls', 'xlsx'];

                    if (allowedTypes.includes(fileType)) {
                        path_file.push(fileName);
                        const fileItem = createFileItem(fileName, fileType);
                        fileItem.classList.add('show');
                        fileListContainer.appendChild(fileItem);
                    }
                });
            };

            //Alert
            function showAlert(message) {
                const modalAlert = document.getElementById('modal_alert');
                const alertContent = document.getElementById('alert_content');
                if (modalAlert && alertContent) {
                    alertContent.innerHTML = `<p class="kanit-regular">${message}</p>`;
                    $(modalAlert).modal('show');
                } else {
                    alert(message);
                }
            }
        });

        async function GetLeaveType() {
            let emp_id = '@Html.Raw(Model.emp_id)';
            let now = new Date();
            let year = now.getFullYear();
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetLeaves", "Leave")',
	            contentType: 'application/x-www-form-urlencoded',
                data: {
                    emp_id,year
                },
                success: function (response) {
                    leaves = response.leaves;
                    balance_entitlement = response.balance_entitlement
                    GenerateLeaveOption(leaves);

                    loadExistingFiles(['test.xlsx']);
                }
            });
        }
        function GenerateLeaveOption(leaves) {
            $('#select_leave_type').empty();
            $('#select_leave_type').append(`<option value="" selected disabled>Select</option>`);
            for (let i = 0; i < leaves.length; i++) {
                $('#select_leave_type').append(`<option value="${leaves[i].leave_type_id}">${leaves[i].leave_name_th}</option>`);
            }
        }

    </script>
}