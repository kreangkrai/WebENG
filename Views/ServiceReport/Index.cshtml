
@model WebENG.Models.UserModel;
@{ ViewData["Title"] = "Service Report"; }
<div class="row p-4" style="row-gap:20px">
    <div class="col-xl-12">
        <div class="card card-dark">
            <div class="card-header">
                <span class="card-title">Service Reports</span>
            </div>
            <div class="card-body">
                <form>
                    <div class="form-group row" style="row-gap:20px">

                        <div class="col-xl-3">
                            <select id="select_job" class="form-control">
                                <option value="" selected disabled>Please Select Job</option>
                            </select>
                        </div>

                        <div class="col-xl-1">
                            <button id="btn_load" type="button" class="btn btn-primary form-control elevation-1">
                                <i class="fas fa-sync"></i> Load
                            </button>
                        </div>
                        <div class="col-2 col-md-1 col-xl-1">
                            <a class="btn btn-success form-control" href="@Url.Action("ExportReport", "ServiceReport")">
                                <i class="fas fa-download"></i> Download
                            </a>
                        </div>
                    </div>
                    <hr />
                    <div class="form-group">
                        <table id="table_activity" class="table table-sm compact table-bordered table-hover text-center w-100">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Date</th>
                                    <th>Start</th>
                                    <th>Stop</th>
                                    <th>Activity</th>
                                    <th>Problem</th>
                                    <th>Solution</th>
                                    <th>Tomorrow Plan</th>
                                    <th>Note</th>
                                    <th>Action By</th>
                                    <th>Customer</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts
{
    <script type="text/javascript">
        var jobs;
        var drs = [];
        var table;

        $(document).ready(async function () {
            await GetJobs();
            GenerateJobs();

            table = $('#table_activity').DataTable();
            EnableExport();
        });

        async function GetJobs() {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetJobs", "ServiceReport")',
	            contentType: 'application/x-www-form-urlencoded',
                data: { },
                success: function (response) {
                    jobs = response;
                }
            });
        }

        function GenerateJobs() {
            var str = '<option value="" selected disabled>Please Select Job</option>';
            for (var i = 0; i < jobs.length; i++) {
                str += `<option value="${jobs[i]}">${jobs[i]}</option>`;
            }
            $('#select_job').empty();
            $('#select_job').append(str);
        }

        $('#btn_load').on('click', async function () {
            var job = $('#select_job').val();
            await GetDailyActivities(job);
            EnableExport();
            GenerateTableActivity();
        });

        async function GetDailyActivities(job) {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetReportByJob", "ServiceReport")',
	            contentType: 'application/x-www-form-urlencoded',
                data: { job },
                success: function (response) {
                    drs = response;
                }
            });
        }

        function EnableExport() {
            if (drs.length > 0) {
                $('#btn_export').attr('disabled', false);
            } else {
                $('#btn_export').attr('disabled', true);
            }
        }

        function GenerateTableActivity() {
            var datas = [];

            for (var i = 0; i < drs.length; i++) {
                datas.push([
                    drs[i].ind,
                    drs[i].date.split("T")[0],
                    drs[i].start_time.substring(0,5),
                    drs[i].stop_time.substring(0,5),
                    drs[i].job_id + " " + drs[i].task_name,
                    drs[i].problem,
                    drs[i].solution,
                    drs[i].tomorrow_plan,
                    drs[i].note,
                    drs[i].user_name,
                    drs[i].customer
                ]);
            }

            if (table !== undefined) {
                table.destroy();
            }

            table = $('#table_activity').DataTable({
                lengthMenu: [[25,50,100,200], [25,50,100,200]],
                data: datas,
            });

            table.column(0).visible(false);
        }

    </script>
}
