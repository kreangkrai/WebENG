@model WebENG.Models.UserModel;
@using WebENG.LeaveModels;
@{
    List<int> years = ViewBag.listYears;
    List<LevelModel> levels = ViewBag.levels;
    ViewData["Title"] = "Leave Status";

    string emp_id = ViewBag.emp;

    string role = ViewBag.role;
}
<link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

<style>

    .custom-control-input:not(:checked) ~ .custom-control-label::before {
        background-color: lightgray;
        border-color: lightgray;
    }

    .custom-control-input:checked ~ .custom-control-label::before {
        background-color: green;
        border-color: green;
    }

    .kanit-thin {
        font-family: "Kanit", sans-serif !important;
        font-weight: 100 !important;
        font-style: normal !important;
    }

    .kanit-extralight {
        font-family: "Kanit", sans-serif;
        font-weight: 200;
        font-style: normal;
    }

    .kanit-light {
        font-family: "Kanit", sans-serif !important;
        font-weight: 300 !important;
        font-style: normal !important;
    }

    .kanit-regular {
        font-family: "Kanit", sans-serif;
        font-weight: 400;
        font-style: normal;
    }

    .kanit-medium {
        font-family: "Kanit", sans-serif;
        font-weight: 500;
        font-style: normal;
    }

    .kanit-semibold {
        font-family: "Kanit", sans-serif;
        font-weight: 600;
        font-style: normal;
    }

    .kanit-bold {
        font-family: "Kanit", sans-serif;
        font-weight: 700;
        font-style: normal;
    }

    .kanit-extrabold {
        font-family: "Kanit", sans-serif;
        font-weight: 800;
        font-style: normal;
    }

    .kanit-black {
        font-family: "Kanit", sans-serif;
        font-weight: 900;
        font-style: normal;
    }

    .kanit-thin-italic {
        font-family: "Kanit", sans-serif;
        font-weight: 100;
        font-style: italic;
    }

    .kanit-extralight-italic {
        font-family: "Kanit", sans-serif;
        font-weight: 200;
        font-style: italic;
    }

    .kanit-light-italic {
        font-family: "Kanit", sans-serif;
        font-weight: 300;
        font-style: italic;
    }

    .kanit-regular-italic {
        font-family: "Kanit", sans-serif;
        font-weight: 400;
        font-style: italic;
    }

    .kanit-medium-italic {
        font-family: "Kanit", sans-serif;
        font-weight: 500;
        font-style: italic;
    }

    .kanit-semibold-italic {
        font-family: "Kanit", sans-serif;
        font-weight: 600;
        font-style: italic;
    }

    .kanit-bold-italic {
        font-family: "Kanit", sans-serif;
        font-weight: 700;
        font-style: italic;
    }

    .kanit-extrabold-italic {
        font-family: "Kanit", sans-serif;
        font-weight: 800;
        font-style: italic;
    }

    .kanit-black-italic {
        font-family: "Kanit", sans-serif;
        font-weight: 900;
        font-style: italic;
    }

    /* สไตล์สำหรับ input */
    input[type="text"] {
        transition: opacity 0.3s ease, background-color 0.3s ease; /* แอนิเมชันนุ่มนวล */
    }
        /* input ตอน disable */
        input[type="text"]:disabled::placeholder {
            cursor: not-allowed;
            color: #444;
        }

        /* input ตอน enable */
        input[type="text"]:not(:disabled) {
            opacity: 1;
        }
    /* สไตล์สำหรับ input */
    input[type="number"] {
        transition: opacity 0.3s ease, background-color 0.3s ease; /* แอนิเมชันนุ่มนวล */
    }
        /* input ตอน disable */
        input[type="number"]:disabled {
            cursor: not-allowed;
        }
        /* input ตอน enable */
        input[type="number"]:not(:disabled) {
            opacity: 1;
        }

    /* สไตล์สำหรับรายการไฟล์ */
    .file-item {
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
        transition: opacity 0.3s ease; /* ใช้ transition แทน keyframes */
    }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item:hover {
            background: #f8f9fa;
        }

    .file-link {
        color: #007bff;
        text-decoration: none;
        transition: color 0.3s ease;
    }

        .file-link:hover {
            color: #0056b3;
            text-decoration: underline;
        }

    /* Responsive design */
    .responsive-file-item {
        flex-direction: column;
        align-items: flex-start;
    }

    .responsive-select-file-btn {
        width: 100%;
    }

    /* สไตล์สำหรับส่วนผู้อนุมัติ */
    .approver-item {
        padding: 12px 15px;
        border-bottom: 1px solid #dee2e6;
        transition: all 0.3s ease; /* เหมือน dropzone */
    }

        .approver-item:last-child {
            border-bottom: none;
        }

        .approver-item:hover {
            background: #f8f9fa; /* Highlight เหมือน file-item */
            transform: translateY(-2px); /* ยกขึ้นเล็กน้อย */
        }

        .approver-item i {
            font-size: 16px;
        }

    #approver-note {
        font-size: 14px;
        background: #e9ecef;
        border-bottom: 1px solid #dee2e6;
    }

    .badge {
        font-size: 14px;
        padding: 8px 12px;
        border-radius: 12px; /* ขอบโค้งทันสมัย */
    }

    .badge-warning {
        background-color: #ffc107; /* รออนุมัติ = เหลือง */
    }

    .badge-success {
        background-color: #28a745; /* อนุมัติ = เขียว */
    }

    .badge-danger {
        background-color: #dc3545; /* ไม่อนุมัติ = แดง */
    }

    /* ตารางมีมุมโค้งมน */
    #table_leave {
        border-collapse: separate !important;
        border-spacing: 0;
        table-layout: fixed !important; /* สำคัญที่สุด! */
        width: auto; /* บังคับให้เต็ม container */
        /* border-radius: 12px !important; */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

        /* เส้นขอบแนวนอนใน tbody */
        #table_leave tbody td {
            border-top: 1px solid #dee2e6 !important;
            border-bottom: none !important;
        }

        /* ลบเส้นแนวตั้งทั้งหมด (ถ้าต้องการ) */
        /*#table_leave th,
        #table_leave td {
            border-left: none !important;
            border-right: none !important;
            padding: 8px 10px !important;*/ /* ทำให้เซลล์สูงขึ้น */
            /*vertical-align: middle !important;*/ /* สำรองถ้า Bootstrap ไม่ทำงาน */
        /*}*/

        /* Badge โค้งมน */
        #table_leave .badge {
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 14px;
            font-weight: 500;
        }

    .clickable-row {
        cursor: pointer !important;
        transition: all 0.2s ease !important;
    }

        .clickable-row:hover {
            background-color: #f2faff !important;
            transform: translateY(-1px) !important; /* เพิ่มยกขึ้นเล็กน้อย */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
        }

    /* Card พนักงาน */
    .modern-card {
        transition: all 0.3s ease;
        border: none !important;
    }

        .modern-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(28, 70, 152, 0.15) !important;
        }

    /* ป้องกัน dropdown ถูกตัด */
    .dropdown-search {
        position: relative;
        z-index: 1050;
    }

    /* 1. header sticky เท่านั้นที่เป็นสีเทา */
    .freeze-head.freeze-left-1,
    .freeze-head.freeze-left-2,
    .freeze-head.freeze-left-3 {
        background: #E8E8E8 !important;
        z-index: 15 !important;
    }

    /* 2. body sticky (td) เป็นสีขาว */
    /*#table_leave tbody td.freeze-left-1,
    #table_leave tbody td.freeze-left-2,
    #table_leave tbody td.freeze-left-3 {
        background: white !important;
        z-index: 10;
    }*/

    /* 3. ป้องกันทับกันตอนเลื่อน */
    .freeze-head {
        background: #EEE !important;
        z-index: 10;
    }

    /* sticky styles */
    .freeze-pane {
        overflow: auto;
        height: 600px;
        width: 100%;
        position: relative;
        display: block;
    }

    .freeze-head {
        position: sticky;
        top: 0;
        background: #EEE;
        z-index: 10;
        box-shadow: 0 2px 2px rgba(0,0,0,0.3);
    }

    /* คอลัมน์ 1: ติดซ้ายสุด */
    .freeze-left-1 {
        position: sticky;
        left: 0;
        background: #EEE;
        z-index: 10;
    }

    /* คอลัมน์ 2: ติดถัดจากคอลัมน์ 1 */
    .freeze-left-2 {
        position: sticky;
        left: 60px; /* ปรับตามความกว้างจริงของคอลัมน์ 1 */
        background: #EEE;
        z-index: 9;
    }

    /* คอลัมน์ 3: ติดถัดจากคอลัมน์ 2 */
    .freeze-left-3 {
        position: sticky;
        left: 160px; /* 60 + 100 = 160px (ปรับตามจริง) */
        background: #EEE;
        z-index: 8;
        box-shadow: 2px 0 5px -2px rgba(0,0,0,0.3);
    }

    .freeze-corner {
        z-index: 15 !important;
    }

    #modal_leave .modal-body {
        height: auto !important;
        max-height: 500px;
    }

    .modal-footer {
        position: sticky;
        bottom: 0;
        background: white;
        z-index: 1;
        box-shadow: 0 -5px 10px rgba(0,0,0,0.05);
    }

    /* ปุ่มทันสมัย 2025 - ใช้ชุดแรก แต่ไม่มี shimmer */
    .modern-btn {
        font-weight: 600;
        letter-spacing: 1px;
        text-transform: uppercase;
        border-radius: 12px !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        min-width: 110px;
    }

        /* Hover สวย ยกขึ้น + เงาเข้มขึ้น (ไม่มีแสงวิ่งแล้ว) */
        .modern-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.18);
        }

    /* ปุ่มปฏิเสธ */
    .btn-outline-danger.modern-btn {
        color: #e74c3c;
        border: 2px solid #e74c3c;
        background: transparent;
    }

        .btn-outline-danger.modern-btn:hover {
            background: #e74c3c;
            color: white;
            box-shadow: 0 10px 25px rgba(231, 76, 60, 0.3);
        }

    /* ปุ่มส่งกลับ */
    .btn-outline-warning.modern-btn {
        color: #f39c12;
        border: 2px solid #f39c12;
        background: transparent;
    }

        .btn-outline-warning.modern-btn:hover {
            background: #f39c12;
            color: white;
            box-shadow: 0 10px 25px rgba(243, 156, 18, 0.3);
        }

    /* ปุ่มอนุมัติ */
    .btn-success.modern-btn {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        border: 2px solid #27ae60;
        color: white;
        background-size: 200% 200%;
        transition: all 0.4s ease;
    }

        .btn-success.modern-btn:hover {
            background-position: 100% 100%;
            box-shadow: 0 10px 25px rgba(46, 204, 113, 0.4);
            transform: translateY(-3px);
        }

    /* ปุ่ม Primary แบบใหม่ – เข้ากับชุดปุ่มอนุมัติ/ปฏิเสธ 100% */
    .btn-primary.modern-btn {
        background: linear-gradient(135deg, #2c79c9, #3498db); /* น้ำเงินสวย ดูเป็นองค์กร */
        background-size: 200% 200%;
        border: none;
        color: white;
        transition: all 0.4s ease;
    }

        .btn-primary.modern-btn:hover {
            background-position: 100% 100%; /* ไหลลื่นเหมือนปุ่มอนุมัติ */
            box-shadow: 0 10px 25px rgba(52, 152, 219, 0.35);
            transform: translateY(-3px);
            color: white;
        }

    /* ถ้าอยากใช้แบบ outline (เส้นขอบ) บางกรณี */
    .btn-outline-primary.modern-btn {
        color: #3498db;
        border: 2px solid #3498db;
        background: transparent;
    }

        .btn-outline-primary.modern-btn:hover {
            background: #3498db;
            color: white;
            box-shadow: 0 10px 25px rgba(52, 152, 219, 0.3);
        }

    /* ไอคอนยังคงสวยงาม */
    .modern-btn i {
        margin-right: 6px;
        font-size: 1.1em;
    }

    body, .modal, .btn, .toast * {
        font-family: 'Kanit', sans-serif !important;
    }

    .toast-header strong,
    .toast-body {
        font-weight: 400 !important; /* Kanit Regular */
    }

    .toast-header {
        font-weight: 500 !important; /* หัวข้อ Toast ตัวหนาเล็กน้อยให้อ่านง่าย */
    }
</style>


<div class="row" style="row-gap:1px;">

    <!-- HEADER -->
    <div class="col-12" style="padding:20px">
        <span class="kanit-bold d-flex justify-content-center " style="font-size:30px; color:#1C4698; text-align:center;">
            ข้อมูล & ประวัติการลา
        </span>

        @* <hr style="border:solid; color:#1C4698; border-width:1px" /> *@
    </div>

    <div class="col-xl-3 col-sm-12">
        <!-- Top Left Side: Employee Info -->
        <div class=" mb-3">
            <form>
                <div class="col-12">
                    <div class="card shadow-sm modern-card" style="border-radius: 12px; overflow: hidden;">
                        <div class="card-header text-white p-3 d-flex justify-content-between align-items-center" style="background: linear-gradient(90deg, rgba(33, 120, 190, 1) 0%, rgba(40, 71, 95, 1) 100%); padding: 12px 15px;">
                            <h5 class="kanit-medium mb-0" style="font-size: 20px; letter-spacing: 2px;">ตัวกรองวันที่</h5>
                            <div class="ml-auto">
                                <input type="button" class="btn kanit-medium" onclick="CreateLeave()"
                                       style="border-radius:5px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); white-space: nowrap;background-color:rgb(5 213 242 / 0.73); color:white; letter-spacing:1px" value="สร้างวันลา" />
                            </div>
                        </div>
                        <div class="card-body p-3">
                            <div class="form-group row">
                                <label class="col-4 kanit-regular text-muted" style="font-size: 18px;">วันเริ่มต้น</label>
                                <input type="date" class="col-8 form-control kanit-regular" style="border-radius:20px" id="date_start">
                            </div>
                            <div class="form-group row">
                                <label class="col-4 kanit-regular text-muted" style="font-size: 18px;">วันสิ้นสุด</label>
                                <input type="date" class="col-8 form-control kanit-regular" style="border-radius:20px" id="date_stop">
                            </div>
                            <input type="hidden" id="hidden_emp_id" value="@Model.emp_id" />
                        </div>
                    </div>
                    @if (levels.Where(w => w.emp_id == emp_id).Any(a => a.level > 0) || role == "Admin" || role == "Admin Leave")
                    {
                        <div class="card shadow-sm modern-card" style="border-radius: 12px; overflow: hidden;">
                            <div class="card-header text-white" style="background: linear-gradient(90deg, rgba(33, 120, 190, 1) 0%, rgba(40, 71, 95, 1) 100%); padding: 12px 15px;">
                                <h5 class="kanit-medium mb-0" style="font-size: 20px; letter-spacing: 2px;">ข้อมูลพนักงาน</h5>
                            </div>
                            <div class="card-body p-3">
                                <!-- Dropdown วันที่เริ่มต้น -->
                                <!-- Dropdown กรองแผนก -->
                                <div class="form-group row mb-3">
                                    <label class="col-4 kanit-regular text-muted" style="font-size: 18px;">แผนก</label>
                                    <select id="departmentSelect" class="col-8 form-control kanit-regular" style="font-size: 16px; border-radius:20px">
                                    </select>
                                </div>
                                <!-- Dropdown เลือกพนักงาน -->
                                <div class="form-group mb-3">
                                    <label class="kanit-regular text-muted" style="font-size: 18px;">พนักงาน</label>
                                    <select id="employeeSelect" class="form-control kanit-regular" style="font-size: 16px;border-radius:20px">
                                        @*<option value="All">ทุกคน</option>*@
                                    </select>
                                </div>

                                <hr />

                                <!-- Dropdown + Search -->
                                <div class="form-group mb-3">
                                    <label class="kanit-regular text-muted" style="font-size: 18px;">ค้นหาโดยตรง</label>
                                    <div class="dropdown-search">
                                        <div class="input-group">
                                            <input type="text" id="employeeSearch" class="form-control kanit-regular"
                                                   placeholder="ค้นหา รหัส/ชื่อพนักงาน" style="font-size: 15px; border-radius:20px">
                                            <div class="input-group-append">
                                                <button id="clearSearch" class="btn btn-outline-secondary btn-sm" type="button" style="border:none;">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div id="searchResults" class="list-group position-absolute w-100" style="max-height: 150px; overflow-y: auto;  display: none; border-radius: 0 0 8px 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"></div>
                                    </div>
                                </div>

                                <hr />


                                <!-- แสดงข้อมูลพนักงาน -->
                                <div id="employeeInfo" class="text-left" style="font-size: 16px; display: none;">
                                    <div class="row">
                                        <div class="col-4 kanit-light text-muted">รหัสพนักงาน</div>
                                        <label class="col-8 kanit-light text-dark d-flex justify-content-end" id="EmpId"></label>
                                    </div>
                                    <div class="row">
                                        <div class="col-4 kanit-light text-muted">ชื่อ-สกุล</div>
                                        <label class="col-8 kanit-light text-dark d-flex justify-content-end" id="EmpName">-</label>
                                    </div>
                                    <div class="row">
                                        <div class="col-4 kanit-light text-muted">แผนก</div>
                                        <label class="col-8 kanit-light text-dark d-flex justify-content-end" id="department">-</label>
                                    </div>
                                    <div class="row">
                                        <div class="col-4 kanit-light text-muted">ตำแหน่ง</div>
                                        <label class="col-8 kanit-light text-dark d-flex justify-content-end" id="position">-</label>
                                    </div>
                                    <div class="row">
                                        <div class="col-4 kanit-light text-muted">เบอร์โทร</div>
                                        <label class="col-8 kanit-light text-dark d-flex justify-content-end" id="phone">-</label>
                                    </div>
                                    <div class="row">
                                        <div class="col-4 kanit-light text-muted">วันที่เริ่มงาน</div>
                                        <label class="col-8 kanit-light text-dark d-flex justify-content-end" id="startDate">-</label>
                                    </div>
                                </div>

                                <!-- แสดงเมื่อยังไม่เลือก -->
                                <div id="noEmployee" class="text-center text-muted kanit-light" style="font-size: 14px; padding: 20px;">
                                    <i class="fas fa-user-slash fa-2x mb-2"></i><br>
                                    กรุณาเลือกพนักงาน
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </form>
        </div>

        <!-- Bottom Left Side : Leave Info -->
        <div>
            <form>
                <div class="col-12">
                    <div class="card shadow-sm modern-card" style="border-radius:10px; padding:10px">
                        <div class="card-body" overflow-y:auto">
                            <div class="form-group row">
                                <label id="label_entitlement" class="kanit-regular col-12" style="font-size:22px; letter-spacing:1px; color:#1C4698;">สิทธิ์การลาที่ใช้ปี (วัน)</label>
                                <label id="emp_th_used_leave" class="kanit-regular col-12" style="letter-spacing:1px; color:#666;font-size:20px"></label>
                                <div class="col-12" style="font-size:18px; ">
                                    <div id="div_leaves_used"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Right Side : Table Leave History-->
    <div class="col-xl-9 col-md-9 col-sm-12">
        <div class="card card-dark" style="border-top-right-radius:20px; border-top-left-radius:20px;">
            <div class="card-header p-3 d-flex justify-content-between align-items-center"
                 style="background: linear-gradient(90deg, rgba(33, 120, 190, 1) 0%, rgba(40, 71, 95, 1) 100%);
                 border-radius: 20px 20px 0 0; min-height: 60px;">

                <!-- ซ้าย: หัวข้อ + ปี + เดือน -->
                <h4 class="kanit-medium mb-0 text-white d-flex align-items-center flex-nowrap" style="letter-spacing: 2px; font-size: 22px; gap: 8px; white-space: nowrap;">
                    ประวัติการลา
                </h4>

                <!-- ขวา: ปุ่ม Export ชิดขวา -->
                @if (levels.Where(w => w.emp_id == emp_id).Any(a => a.level > 0) || role == "Admin" || role == "Admin Leave")
                {
                    <div class="ml-auto">
                        <button class="btn btn-light mr-2 kanit-regular" onclick="ExportToText()"
                                style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); white-space: nowrap;">
                            <i class="fas fa-file-alt mr-2"></i>Export to Text
                        </button>
                        @*<button class="btn btn-success  kanit-regular" data-toggle="modal" data-target="#sendModal"
                                style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); white-space: nowrap;">
                            <i class="fas fa-file-excel mr-1"></i> Export to Excel
                        </button>*@
                    </div>
                }
            </div>

            <div>
                <table id="table_leave" class="table table-sm table-hover text-center mb-0 w-100">
                    <thead style="font-size:18px; color:#555">
                        <tr class="kanit-light align-middle freeze-head freeze-left freeze-corner">
                            <th style="width:40px;"> ลำดับ</th>
                            <th style="width:80px;">รหัสพนักงาน</th>
                            <th style="width:180px;">ชื่อ-สกุล</th>
                            <th>วันที่ยื่นลา</th>
                            <th>วันที่ลา</th>
                            <th>เวลาที่ลา</th>
                            <th>ระยะเวลา (วัน)</th>
                            <th>ประเภทการลา</th>
                            <th>รายละเอียด</th>
                            <th>สถานะ</th>
                        </tr>

                    </thead>

                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modal_leave" tabindex="-1" role="dialog" aria-hidden="true" style="overflow-y:hidden" data-backdrop="static">
    <div class="modal modal-dialog modal-dialog-centered modal-md" role="document">
        <div class="modal-content kanit-regular">
            <div class="modal-header" style="background: linear-gradient(90deg, rgba(33, 120, 190, 1) 0%, rgba(40, 71, 95, 1) 100%); color: white; border-bottom: none">
                <h5 class="modal-title" id="modal_leave_title">แก้ไขการลา</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="ModalCloseClick()">
                    <span aria-hidden="true" style="color: white;">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="height:500px; color:#555555;overflow-y:auto">
                <form>
                    <div class="form-group row">
                        <div class="col-xl-4 col-md-4 col-sm-6">
                            <input id="emp_id" type="text" class="form-control" placeholder="" disabled />
                        </div>
                        <div class="col-xl-8 col-md-8 col-sm-6">
                            <input id="emp_name" type="text" class="form-control" placeholder="" disabled />
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-xl-6 col-md-6 col-sm-12 ">
                            <label for="request_id">ประเภทการลา</label>
                            <select id="select_leave_type" class="form-control">
                            </select>
                        </div>
                        <div class="col-xl-6 col-md-6 col-sm-12">
                            <label>ช่วงเวลา</label>
                            <div class="row">
                                <div class="btn-group" role="group" aria-label="Basic example">
                                    <button id="leave_full" type="button" class="btn btn-outline-primary">ทั้งวัน</button>
                                    <button id="leave_half" type="button" class="btn btn-outline-info">ครึ่งวัน</button>
                                    <button id="leave_hours" type="button" class="btn btn-outline-secondary">รายชั่วโมง</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div div class="col-8">
                            <label class="kanit-bold">สิทธิ์การลาคงเหลือ</label>
                        </div>
                        <div div class="col-4 d-flex justify-content-end">
                            <span id="leave_balance" class="kanit-light"></span>
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-xl-12 col-md-12 col-sm-12">
                            <div class="card collapsed-card">
                                <div class="card-header" style=" background: #EEE;cursor:pointer" data-card-widget="collapse">
                                    <div class="row">
                                        <div class="col-11 d-flex justify-content-end">
                                            <span class="kanit-bold" style="color:#555;">เงื่อนไขการลา</span>
                                        </div>
                                        <div class="col-1 d-flex justify-content-end">
                                            <div class="row">
                                                <div class="col-6">
                                                    <div class="card-tools">
                                                        <button type="button" class="btn btn-tool" style="color:#555 ; font-size:20px">
                                                            <i class="fas fa-chevron-down"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row" style="row-gap:1px">
                                        <div class="col-12">
                                            <div class="row">
                                                <div class="col-12">
                                                    <span id="leave_description" class="kanit-light">

                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="leave_date_group" class="form-group row">
                        <div class="col-xl-4 col-md-6 col-sm-6">
                            <label for="leave_start_date">ลาตั้งแต่วันที่</label>
                            <input id="leave_start_date" type="date" class="form-control" disabled />
                        </div>
                        <div class="col-xl-4 col-md-6 col-sm-6">
                            <label for="leave_stop_date">ถึงวันที่</label>
                            <input id="leave_stop_date" type="date" class="form-control" />
                        </div>
                        <div class="col-xl-4 col-md-4 col-sm-12">
                            <label for="amount_leave">ลาจำนวน</label>
                            <div class="input-group">
                                <input id="amount_leave" type="number" class="form-control" style="text-align:end" value="1" min="1" max="200" disabled />
                                <div class="input-group-append">
                                    <span class="input-group-text">วัน</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="leave_time_group" class="form-group row">
                        <div class="col-xl-4 col-md-4 col-sm-12">
                            <label>ระยะเวลา</label>
                            <div class="input-group">
                                <select id="select_leave_hours_duration" class="form-control">
                                </select>
                            </div>
                        </div>
                        <div class="col-xl-4 col-md-4 col-sm-6">
                            <label for="leave_start_time">ตั้งแต่เวลา</label>
                            <div class="d-flex gap-2">
                                <select id="leave_start_hour" class="form-control" style="width: auto;"></select>
                                <span class="align-self-center">:</span>
                                <select id="leave_start_minute" class="form-control" style="width: 80px;">
                                    <option value="00">00</option>
                                    <option value="30">30</option>
                                </select>
                            </div>
                        </div>
                        <fieldset disabled class="col-xl-4 col-md-4 col-sm-6">
                            <label for="leave_stop_time">ถึงเวลา</label>
                            <input id="leave_stop_time" type="time" class="form-control" />
                        </fieldset>
                    </div>
                    <div class="form-group row">
                        <div class="col-12">
                            <div class="form-group">
                                <label for="leave_note">รายละเอียด</label>
                                <textarea id="leave_note" class="form-control" rows="2" placeholder="Note or Description"></textarea>
                            </div>
                        </div>
                    </div>
                    <!-- ส่วนอัปโหลดไฟล์ -->
                    <div id="leave_attach_file_group">
                        <hr />
                        <div class="form-group row">
                            <div class="col-12">
                                <label for="uploadForm" class="kanit-medium">แนบไฟล์</label>
                                <div id="uploadForm" class="card p-3 mb-3 dropzone" style="border: 2px dashed #ccc; border-radius: 10px; background: #f8f9fa; min-height: 120px; position: relative;">
                                    <div class="text-center">
                                        <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                        <p class="kanit-regular text-muted">ลากไฟล์มาวางที่นี่ หรือคลิกเพื่อเลือกไฟล์ <br />(.pdf, .jpg, .png, .xls, .xlsx)</p>
                                        <input type="file" id="leave_fileInput" name="files" accept=".pdf,.jpg,.png,.xls,.xlsx" multiple style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 1000;" />
                                        <button type="button" id="selectFileBtn"
                                                class="btn btn-outline-primary btn-md kanit-medium select-file-btn"
                                                style="position: relative; z-index: 1001; cursor: pointer; border-radius:5px; ">
                                            เลือกไฟล์
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ส่วนแสดงรายการไฟล์ -->
                        <div class="form-group row">
                            <div class="col-12">
                                <label class="kanit-medium">เอกสารที่แนบ</label>
                                <div class="card" style="border-radius: 10px; overflow: hidden;">
                                    <div class="list-group" id="leave_fileListContainer">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-------------------------------------------------------------------------------------------------------------------------------->
                        <hr />

                    </div>
                    <div class="col-12">
                        <label class="kanit-medium" style="letter-spacing:1px; font-size:16px; color:#555;">
                            ไทม์ไลน์การอนุมัติ
                        </label>
                        <div id="div_history_approved" class="timeline-container" style="position: relative; padding-left: 35px;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer d-flex">
                <button id="btn_delete" type="button" class="btn modern-btn btn-danger mr-auto elevation-1" data-toggle="modal" data-target="#confirmDeleteModal">
                    <i class="mr-1 fas fa-trash-alt"></i> ยกเลิกการลา
                </button>
                <button id="btn_checker_delete" type="button" class="btn modern-btn btn-danger mr-auto elevation-1" data-toggle="modal" data-target="#confirmCheckerDeleteModal">
                    <i class="mr-1 fas fa-trash-alt"></i> ยกเลิกการลา
                </button>
                <button type="button" class="btn btn-secondary elevation-1" data-dismiss="modal" onclick="ModalCloseClick()">
                    <i class="fas fa-times"></i> ปิด
                </button>
                <button id="btn_leave_send" type="button" class="btn btn-primary elevation-1">
                    <i class="fas fa-check"></i> แก้ไขวันลา
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Modal : บันทึกการตั้งค่า-->
<div class="modal fade" id="modal_confirm" tabindex="-1" role="dialog" aria-labelledby="modal_confirm_title" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered" role="document">
        <div class="modal-content kanit-regular" style="border-radius: 10px; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(90deg, #034694 0%, #022f5b 100%); border-bottom: none; padding: 15px;">
                <h5 class="modal-title kanit-medium" style="color: white; font-size: 24px; letter-spacing: 1px;" id="modal_confirm_title">บันทึกการส่งวันลา</h5>
                <button type="button" class="close" style="color: white; font-size: 24px;" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 20px; text-align: center;">
                <div class="d-flex justify-content-center">
                    <p class="kanit-light" id="confirm_description" style="font-size: 16px; color: #333; margin-bottom: 0;"></p>
                </div>
                <div class="d-flex justify-content-center">
                    <p class="kanit-light" style="font-size: 20px; color: #333; margin-bottom: 0;">คุณต้องการส่งวันลาหรือไม่?</p>
                </div>
            </div>
            <div class="modal-footer" style="border-top: none; padding: 15px 30px; background-color: #f8f9fa;">
                <div class="row justify-content-center" style=" width: 100%;">
                    <div class="col-xl-4 col-md-4 col-sm-4">
                        <button type="button" class="btn btn-danger kanit-medium" style="width:100px" data-dismiss="modal">ยกเลิก</button>
                    </div>
                    <div class="col-xl-4 col-md-4 col-sm-4">
                        <button type="button" class="btn btn-primary kanit-medium" style="width:100px" id="confirm_ok">ยืนยัน</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal ยืนยันการลบ -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white">
                <h6 class="modal-title"><i class="fas fa-trash-alt mr-2"></i>ยืนยันการลบ</h6>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <p class="mb-0">คุณต้องการลบรายการนี้หรือไม่?</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn modern-btn btn-secondary" data-dismiss="modal">ยกเลิก</button>
                <button type="button" id="btn_confirm_delete" class="btn modern-btn btn-danger">ลบ</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="confirmCheckerDeleteModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white">
                <h6 class="modal-title"><i class="fas fa-trash-alt mr-2"></i>ยืนยันการลบ</h6>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <p class="mb-0">คุณต้องการลบรายการนี้หรือไม่?</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn modern-btn btn-secondary" data-dismiss="modal">ยกเลิก</button>
                <button type="button" id="btn_confirm_checker_delete" class="btn modern-btn btn-danger">ลบ</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="CreateModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h6 class="modal-title"><i class="fas fa-plus mr-2"></i>สร้างวันลา</h6>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="form-group row">
                    <p class="mb-0">เลือกวันที่ต้องการลา</p>
                    <input type="date" class="form-control" id="date_create_leave" />
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn modern-btn btn-secondary" data-dismiss="modal">ยกเลิก</button>
                <button type="button" id="btn_confirm_date_create" class="btn modern-btn btn-primary" disabled>สร้าง</button>
            </div>
        </div>
    </div>
</div>
<partial name="ModalSpin" />
<partial name="Create" />
@section Scripts
{
    <script type="text/javascript">

        let leaves = [];
        let balance_leave = 0;
        let type_duration = "Day";
        let file_require = false;
        let is_full_day = true;
        let gender = "";
        let tempFileIds = [];
        let holidays = [];
        let tigger_select = false;
        let request_id = "";

        const hourSelect = document.getElementById('leave_start_hour');
        const leaveFullBtn = document.getElementById('leave_full');
        const leaveHalfBtn = document.getElementById('leave_half');
        const leaveHoursBtn = document.getElementById('leave_hours');
        const dateGroup = document.getElementById('leave_date_group');
        const attachFileGroup = document.getElementById('leave_attach_file_group');
        const timeGroup = document.getElementById('leave_time_group');
        const durationSelect = timeGroup.querySelector('select');
        const startHourTimeInput = document.getElementById('leave_start_hour');
        const startMinuteTimeInput = document.getElementById('leave_start_minute');
        const startDateInput = document.getElementById('leave_start_date');
        const stopTimeInput = document.getElementById('leave_stop_time');
        const stopDateInput = document.getElementById('leave_stop_date');
        const daysInput = dateGroup.querySelector('input[type="number"]');

        const fileInput = document.getElementById('leave_fileInput');
        const selectFileBtn = document.getElementById('selectFileBtn');
        const uploadForm = document.getElementById('uploadForm');
        const fileListContainer = document.getElementById('leave_fileListContainer');

        const today = new Date();


        $(document).ready(async function () {
            await GetLeaveType();
            await GetHolidays();
        });

        async function GetHolidays() {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetHolidays", "Holiday")',
	            contentType: 'application/x-www-form-urlencoded',
                data: { },
                success: function (response) {
                    holidays = response;
                }
            });
        };

        // 08-15
        for (let h = 8; h <= 15; h++) {
            const option = document.createElement('option');
            option.value = String(h).padStart(2, '0');
            option.textContent = String(h).padStart(2, '0');
            hourSelect.appendChild(option);
        }
        hourSelect.value = '08';

        async function GetLeaveByID(leave_type_id, emp_id, year) {
            try {
                const response = await $.ajax({
                    type: "GET",
                    url: '@Url.Action("GetLeaveByID", "StatusLeave")',
                    contentType: 'application/x-www-form-urlencoded',
                    data: { leave_type_id, emp_id, year }
                });

                return {
                    leave: response.leave,
                    balance_leave: response.balance,
                    gender: response.gender,
                    hire_date: response.hire_date
                };

            } catch (error) {
                console.error("Error fetching leave data:", error);
                throw error;
            }
        }

        function diffDays(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);

            d1.setHours(0, 0, 0, 0);
            d2.setHours(0, 0, 0, 0);

            const diffTime = Math.abs(d2 - d1);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            return diffDays;
        }

            function resetButtonStyles() {
                leaveFullBtn.classList.remove('active');
                leaveHalfBtn.classList.remove('active');
                leaveHoursBtn.classList.remove('active');
            }

            function setHalfDayOptions() {
                durationSelect.innerHTML = `
                        <option value=""selected disabled>Select</option>
                        <option value="morning">ครึ่งวันเช้า</option>
                        <option value="afternoon">ครึ่งวันบ่าย</option>
                    `;
                startHourTimeInput.value = '08';
                startMinuteTimeInput.value = '00';
                stopTimeInput.value = '';
                startHourTimeInput.disabled = false;
                startMinuteTimeInput.disabled = false;
                daysInput.value = 0;
                stopDateInput.value = startDateInput.value;
                stopDateInput.disabled = true;
                // เพิ่ม event listener สำหรับการเปลี่ยนแปลงใน select
                durationSelect.onchange = function () {
                    if (this.value === 'morning') {
                        startHourTimeInput.value = '08';
                        startMinuteTimeInput.value = '30';
                        stopTimeInput.value = '12:00';
                        startHourTimeInput.disabled = true;
                        startMinuteTimeInput.disabled = true;
                    } else if (this.value === 'afternoon') {
                        startHourTimeInput.value = '13';
                        startMinuteTimeInput.value = '00';
                        stopTimeInput.value = '17:30';
                        startHourTimeInput.disabled = true;
                        startMinuteTimeInput.disabled = true;
                    } else {
                        startHourTimeInput.value = '08';
                        startMinuteTimeInput.value = '30';
                        stopTimeInput.value = '';
                        startHourTimeInput.disabled = false;
                        startMinuteTimeInput.disabled = false;
                    }

                    // Check balance
                    if (balance_leave < 0.5) {
                        alert('วันลาไม่เพียงพอ');
                        $('#btn_leave_send').prop('disabled', true);
                    } else {
                        $('#btn_leave_send').prop('disabled', false);
                    }
                };
            }
            // ฟังก์ชันจัดการตัวเลือกใน select สำหรับ leave_hours
            function setHourlyOptions() {
                durationSelect.innerHTML = `
                        <option value="" selected disabled>Select</option>
                        <option value="2">2 ชั่วโมง</option>
                        <option value="4">4 ชั่วโมง</option>
                        <option value="6">6 ชั่วโมง</option>
                    `;
                startHourTimeInput.value = '08';
                startMinuteTimeInput.value = '30';
                stopTimeInput.value = '';
                startHourTimeInput.disabled = false;
                startMinuteTimeInput.disabled = false;
                daysInput.value = 0;
                stopDateInput.value = startDateInput.value;
                stopDateInput.disabled = true;
                // รีเซ็ตค่าเวลาและ enable start_time เมื่อเปลี่ยนเป็นรายชั่วโมง
                durationSelect.onchange = function () {

                    calculateTime();
                    startHourTimeInput.disabled = false;
                    startMinuteTimeInput.disabled = false;
                    // Check Balance
                    let duration = parseInt(durationSelect.value);
                    let hour = (duration / 8);
                    if (balance_leave < hour) {
                        alert('วันลาไม่เพียงพอ');
                        $('#btn_leave_send').prop('disabled', true);
                    } else {
                        $('#btn_leave_send').prop('disabled', false);
                    }
                };

                startHourTimeInput.onchange = function () {
                    calculateTime();
                };

                startMinuteTimeInput.onchange = function () {
                    calculateTime();
                };
            }
            // ฟังก์ชันจัดการ animation เมื่อแสดงหรือซ่อน
        function toggleGroupDisplay(group, show) {
            if (show) {
                group.style.display = 'flex';
                group.style.opacity = '0';
                group.style.transition = 'opacity 0.3s ease-in-out';
                setTimeout(() => {
                    group.style.opacity = '1';
                }, 10);
            } else {
                group.style.opacity = '0';
                group.style.transition = 'opacity 0.3s ease-in-out';
                setTimeout(() => {
                    group.style.display = 'none';
                    // รีเซ็ตค่าใน time_group เมื่อซ่อน
                    if (group === timeGroup) {
                        startHourTimeInput.value = '';
                        startMinuteTimeInput.value = '';
                        stopTimeInput.value = '';
                        durationSelect.value = '';
                        startHourTimeInput.disabled = false; // Enable start_time
                        startMinuteTimeInput.disabled = false; // Enable start_time
                    }
                }, 300);
            }
        }
            // เมื่อกดปุ่ม "ทั้งวัน"
        leaveFullBtn.addEventListener('click', function () {
            resetButtonStyles();
            leaveFullBtn.classList.add('active');
            toggleGroupDisplay(dateGroup, true);
            toggleGroupDisplay(timeGroup, false);
            //daysInput.disabled = false;
            daysInput.value = 1;
            stopDateInput.value = startDateInput.value;
            stopDateInput.disabled = false;

            //Check attachment_required
            type_duration = "Day";
            CheckAttachFileRequire(type_duration);

            is_full_day = true;

        });
            // เมื่อกดปุ่ม "ครึ่งวัน"
        leaveHalfBtn.addEventListener('click', function () {
            resetButtonStyles();
            leaveHalfBtn.classList.add('active');
            toggleGroupDisplay(dateGroup, true); // แสดง date_group
            toggleGroupDisplay(timeGroup, true); // แสดง time_group
            setHalfDayOptions(); // เปลี่ยนตัวเลือกเป็นครึ่งวันเช้า/บ่าย
            //daysInput.disabled = true; // DISABLE ลาจำนวน

            //Check attachment_required
            type_duration = "Half";
            CheckAttachFileRequire(type_duration);

            is_full_day = false;
        });
            // เมื่อกดปุ่ม "รายชั่วโมง"
        leaveHoursBtn.addEventListener('click', function () {
            resetButtonStyles();
            leaveHoursBtn.classList.add('active');
            toggleGroupDisplay(dateGroup, true); // แสดง date_group
            toggleGroupDisplay(timeGroup, true); // แสดง time_group
            setHourlyOptions(); // เปลี่ยนตัวเลือกเป็นรายชั่วโมง
            //daysInput.disabled = true; // DISABLE ลาจำนวน

            //Check attachment_required
            type_duration = "Hours";
            CheckAttachFileRequire(type_duration);

            is_full_day = false;
        });

            //Stop date Change
        stopDateInput.addEventListener('change', function () {
            //Check attachment_required
            type_duration = "Day";
            CheckAttachFileRequire(type_duration);
        });

        function CheckAttachFileRequire(type_duration) {
            $('#btn_leave_send').prop('disabled', true);
            let leave_type_id = $('#select_leave_type').val();
            let _leave = leaves.filter(f => f.leave_type_id === leave_type_id).map(m => m)[0];
            if (type_duration == "Day") {
                if (startDateInput.value !== "" && stopDateInput.value !== "") {
                    let start = new Date(startDateInput.value);
                    let stop = new Date(stopDateInput.value);
                    let diffInDays = 0;
                    if (stop >= start) {
                        if (_leave.count_holidays_as_leave === true) {
                            diffInDays = getDaysBetween(start, stop, true);
                        } else {
                            diffInDays = getBusinessDays(start, stop, holidays);
                        }
                        if (balance_leave >= diffInDays) {
                            if (_leave.is_consecutive === true) {
                                if (_leave.max_consecutive_days >= diffInDays) {
                                    daysInput.value = diffInDays;
                                } else {
                                    alert(`ไม่สามารถลาเกิน ${_leave.max_consecutive_days} วัน`);
                                    daysInput.value = 1;
                                    stopDateInput.value = today;
                                }
                            } else {
                                daysInput.value = diffInDays;
                            }
                            $('#btn_leave_send').prop('disabled', false);
                        } else {
                            //alert('วันลาไม่เพียงพอ');
                            //daysInput.value = _leave.amount_leave_day;
                            //stopDateInput.value = stopDateInput.value;
                            $('#btn_leave_send').prop('disabled', true);
                        }
                    } else {
                        alert('ใส่วันผิด');
                        daysInput.value = 1;
                        stopDateInput.value = today;
                    }
                    //Check attachment_required
                    if (_leave.attachment_required === true) {
                        if (diffInDays >= Number(_leave.attachment_threshold_days)) {
                            attachFileGroup.hidden = false;
                            file_require = true;
                        } else {
                            clearAttachFile();
                        }
                    } else {
                        clearAttachFile();
                    }
                }
            } else if (type_duration === "Half") {
                //Check attachment_required
                if (_leave.attachment_required === true) {
                    if (Number(_leave.attachment_threshold_days) === 0) {
                        attachFileGroup.hidden = false;
                        file_require = true;
                    } else {
                        clearAttachFile();
                    }
                } else {
                    clearAttachFile();
                }
            } else if (type_duration === "Hours") {
                //Check attachment_required
                if (_leave.attachment_required === true) {
                    if (Number(_leave.attachment_threshold_days) === 0) {
                        attachFileGroup.hidden = false;
                        file_require = true;
                    } else {
                        clearAttachFile();
                    }
                } else {
                    clearAttachFile();
                }
            }
        }
        function CheckRequestTiming(request_date) {
            let leave_type_id = $('#select_leave_type').val();
            let leave = leaves.filter(f => f.leave_type_id === leave_type_id).map(m => m)[0];
            let date_now = new Date();
            let date_request = new Date(request_date);

            date_now.setHours(0, 0, 0, 0);
            date_request.setHours(0, 0, 0, 0);
            if (leave.request_timing === "Both") {
                return true;
            } else if (leave.request_timing === "Future") {
                if (date_request >= date_now) {
                    return true;
                } else {
                    return false;
                }

            } else if (leave.request_timing === "Past") {
                if (date_request <= date_now) {
                    return true;
                } else {
                    return false;
                }
            }
        }
        function CheckGenderRestriction(gender) {
            let leave_type_id = $('#select_leave_type').val();
            let leave = leaves.filter(f => f.leave_type_id === leave_type_id).map(m => m)[0];
            if (leave.gender_restriction === "Both") {
                return true;
            } else {
                if (leave.gender_restriction === gender) {
                    return true;
                } else {
                    return false;
                }
            }
        }

        function clearAttachFile() {
            ClearAttachFile(request_id);
            attachFileGroup.hidden = true;
            //loadExistingFiles("","","");
            file_require = false;
            is_attach_file = false;
        };

            function getDaysBetween(startDate, endDate, absolute = true) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffInMs = end - start;
                const diffInDays = diffInMs / (1000 * 60 * 60 * 24);
                const days = Math.floor(diffInDays) + 1;
                return absolute ? Math.abs(days) : days;
            }
            function getBusinessDays(startDate, endDate, holidays = []) {
                const start = new Date(startDate);
                const end = new Date(endDate);

                //if (start > end) [start, end] = [end, start];

                let count = 0;
                const current = new Date(start);

                const holidaySet = new Set(
                    holidays.map(date => {
                        const d = new Date(date);
                        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    })
                );

                while (current <= end) {
                    const dayOfWeek = current.getDay(); // 0 = Sun, 6 = Sat
                    const dateStr = current.toISOString().split('T')[0]; // YYYY-MM-DD
                    if (dayOfWeek !== 0 && dayOfWeek !== 6 && !holidaySet.has(dateStr)) {
                        count++;
                    }
                    current.setDate(current.getDate() + 1);
                }
                return count;
            }
            function calculateTime() {
                let first = timeToMinutes("08:30");
                let last = timeToMinutes("17:30");
                let duration = parseInt(durationSelect.value);
                let start = startHourTimeInput.value + ':' + startMinuteTimeInput.value;
                if (timeToMinutes(start) >= first && timeToMinutes(start) <= last) {
                    let [hours, minutes] = start.split(':').map(Number);
                    let date = new Date(startDateInput.value);
                    date.setHours(hours);
                    date.setMinutes(minutes);
                    date.setSeconds(0);

                    date.setHours(date.getHours() + duration);

                    if (timeToMinutes(date.toTimeString().split(' ')[0]) <= last) {
                        const duration = $('#select_leave_hours_duration').val();
                        
                        if (duration === 6) {
                            if (parseInt(startDateInput.value) <= 12 || (date.getHours() === 12 && date.getMinutes() > 0) || (date.getHours() > 12)) {
                                date.setHours(date.getHours() + 1);
                            }
                        } else {
                            if (parseInt(startDateInput.value) <= 12 || (date.getHours() === 12 && date.getMinutes() > 0)) {
                                date.setHours(date.getHours() + 1);
                            }
                        }

                        if (timeToMinutes(date.toTimeString().split(' ')[0]) <= last) {
                            let stopHours = String(date.getHours()).padStart(2, '0');
                            let stopMinutes = String(date.getMinutes()).padStart(2, '0');
                            let stopTime = `${stopHours}:${stopMinutes}`;
                            stopTimeInput.value = stopTime;
                        } else {
                            alert('ใส่เวลาผิด');
                            startHourTimeInput.value = '08';
                            startMinuteTimeInput.value = '30';
                            date.setHours(8);
                            date.setMinutes(30);
                            date.setHours(date.getHours() + duration);
                            let stopHours = String(date.getHours()).padStart(2, '0');
                            let stopMinutes = String(date.getMinutes()).padStart(2, '0');
                            let stopTime = `${stopHours}:${stopMinutes}`;
                            stopTimeInput.value = stopTime;
                        }
                    } else {
                        alert('ใส่เวลาผิด');
                        startHourTimeInput.value = '08';
                        startMinuteTimeInput.value = '30';
                        date.setHours(8);
                        date.setMinutes(30);
                        date.setHours(date.getHours() + duration);
                        let stopHours = String(date.getHours()).padStart(2, '0');
                        let stopMinutes = String(date.getMinutes()).padStart(2, '0');
                        let stopTime = `${stopHours}:${stopMinutes}`;
                        stopTimeInput.value = stopTime;
                    }
                } else {
                    alert('ใส่เวลาผิด');
                    startHourTimeInput.value = '08';
                    startMinuteTimeInput.value = '30';
                    let stopHours = String('08:30');
                    let stopMinutes = String('17:30');
                    let stopTime = `${stopHours}:${stopMinutes}`;
                    stopTimeInput.value = "";
                }
            }
            leaveFullBtn.click();


        if (!fileInput || !selectFileBtn || !uploadForm || !fileListContainer) {
            console.error('ไม่พบ element');
        }

        // === 1. เลือกไฟล์ ===
        selectFileBtn.addEventListener('click', (e) => {
            e.preventDefault();
            fileInput.click();
        });

        // === 2. Drag & Drop ===
        ['dragenter', 'dragover'].forEach(event => {
            uploadForm.addEventListener(event, (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadForm.classList.add('dragover');
            });
        });
        ['dragleave', 'drop'].forEach(event => {
            uploadForm.addEventListener(event, (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadForm.classList.remove('dragover');
                if (event === 'drop') handleFiles(e.dataTransfer.files);
            });
        });

        // === 3. เมื่อเลือกไฟล์ ===
        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files);
            fileInput.value = '';
        });

        async function handleFiles(files) {
            if (!files || files.length === 0) return;

            for (let file of files) {
                const fileType = file.name.split('.').pop().toLowerCase();
                const allowedTypes = ['pdf', 'jpg', 'jpeg', 'png', 'xls', 'xlsx'];
                const maxSize = 10 * 1024 * 1024; // 10MB

                if (!allowedTypes.includes(fileType)) {
                    showAlert(`ประเภทไฟล์ไม่รองรับ: ${file.name}`);
                    continue;
                }
                if (file.size > maxSize) {
                    showAlert(`ไฟล์ใหญ่เกิน 10MB: ${file.name}`);
                    continue;
                }

                // อัปโหลดทันที
                const tempId = await uploadFileToTemp(file, request_id);
                if (tempId) {
                    tempFileIds.push(file.name);
                    const fileItem = createFileItem(file.name, fileType, tempId.tempId, tempId.previewUrl);
                    fileListContainer.appendChild(fileItem);
                    setTimeout(() => fileItem.classList.add('show'), 10);
                }
            }
        }

        // === 4. อัปโหลดไป backend (temp) ===
        async function uploadFileToTemp(file,request_id) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('request_id', request_id);

            try {
                const response = await fetch('./StatusLeave/UploadTempFile', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    return result; // backend ส่ง tempId กลับ
                } else {
                    const error = await response.text();
                    showAlert(`อัปโหลดล้มเหลว: ${error}`);
                    return null;
                }
            } catch (err) {
                showAlert(`เกิดข้อผิดพลาด: ${err.message}`);
                return null;
            }
        }

        // === 5. สร้าง UI ไฟล์ ===
        function createFileItem(fileName, fileType, request_id, fileUrl) {
            const fileItem = document.createElement('div');
            fileItem.className = 'list-group-item d-flex align-items-center file-item added';
            fileItem.dataset.tempId = request_id;

            const viewLink = document.createElement('a');
            viewLink.href = fileUrl;
            viewLink.target = '_blank';
            viewLink.rel = 'noopener';
            viewLink.className = 'text-decoration-none flex-grow-1 d-flex align-items-center';
            viewLink.style.cursor = 'pointer';

            const iconClass = fileType.includes('pdf')
                ? 'fas fa-file-pdf text-danger'
                : 'fas fa-file-image text-primary';

            viewLink.innerHTML = `
        <i class="${iconClass} mr-2"></i>
        <span class="kanit-regular text-dark">${fileName}</span>
    `;
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'btn btn-outline-danger btn-sm delete-btn ml-2';
            deleteBtn.dataset.tempId = request_id;
            deleteBtn.dataset.filename = fileName;
            deleteBtn.title = 'ลบ';
            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';

            fileItem.appendChild(viewLink);
            fileItem.appendChild(deleteBtn);

            return fileItem;
        }

        // === 6. ลบไฟล์ ===
        fileListContainer.addEventListener('click', async (e) => {
            const btn = e.target.closest('.delete-btn');
            if (!btn) return;

            const fileItem = btn.closest('.file-item');
            const request_id = btn.dataset.tempId;
            const filename = btn.dataset.filename;

            // ลบจาก backend
            try {
                await fetch(`./StatusLeave/DeleteTempFile?request_id=${request_id}&filename=${filename}`, { method: 'DELETE' });
            } catch (err) {
                console.error('ลบไฟล์ล้มเหลว', err);
            }

            // ลบจาก UI

            tempFileIds = tempFileIds.filter(id => id !== filename);
            fileItem.classList.add('removing');
            setTimeout(() => fileItem.remove(), 300);
        });

        // === 7. โหลดไฟล์เก่า (ถ้ามี) ===
        async function loadExistingFiles(leave_type_id, year, request_id) {
            fileListContainer.innerHTML = '';
            tempFileIds = [];

            const response = await fetch(`./StatusLeave/GetTempFileInfo?leave_type_id=${leave_type_id}&year=${year}&request_id=${request_id}`);
            if (response.ok) {
                const info = await response.json();
                info.files.forEach(async (file) => {
                    tempFileIds.push(file.fileName);
                    const fileItem = createFileItem(file.fileName, file.fileType, file.request_id, file.previewUrl);
                    fileListContainer.appendChild(fileItem);
                    fileItem.classList.add('show');
                });
            }
        }

        function ModalCloseClick() {
            clearAttachFile();
        }
        async function ClearAttachFile(request_id) {
            try {
                await fetch(`./StatusLeave/DeleteTemp?request_id=${request_id}`, { method: 'DELETE' });
            } catch (err) {
                console.error('ลบไฟล์ล้มเหลว', err);

            }
            fileListContainer.innerHTML = '';
            tempFileIds = [];
        }
            //Alert
        function showAlert(message) {
            const modalAlert = document.getElementById('modal_alert');
            const alertContent = document.getElementById('alert_content');
            if (modalAlert && alertContent) {
                alertContent.innerHTML = `<p class="kanit-regular">${message}</p>`;
                $(modalAlert).modal('show');
            } else {
                alert(message);
            }
        }


        async function GetLeaveType() {
            let emp_id = $('#emp_id').val();
            let now = new Date();
            let year = now.getFullYear();
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetLeaves", "Leave")',
	            contentType: 'application/x-www-form-urlencoded',
                data: {
                    emp_id,year
                },
                success: function (response) {
                    leaves = response.leaves;
                    GenerateLeaveOption(leaves);
                }
            });
        }
        function GenerateLeaveOption(leaves) {
            $('#select_leave_type').empty();
            $('#select_leave_type').append(`<option value="" selected disabled>Select</option>`);
            for (let i = 0; i < leaves.length; i++) {
                if (leaves[i].is_active) {
                    $('#select_leave_type').append(`<option value="${leaves[i].leave_type_id}">${leaves[i].leave_name_th}</option>`);
                }
            }
        }

        $('#btn_leave_send').on('click', async function () {
            let leave_type = $('#select_leave_type :selected').text();
            let date_start = formatDate(new Date($('#leave_start_date').val()));
            let date_stop = formatDate(new Date($('#leave_stop_date').val()));
            let hour_start = $('#leave_start_hour').val();
            let minute_start = $('#leave_start_minute').val();
            let time_stop = $('#leave_stop_time').val();
            let message = "";
            let year_start = new Date($('#leave_start_date').val()).getFullYear();
            let year_stop = new Date($('#leave_stop_date').val()).getFullYear();
            if (year_start === year_stop) {
                if (is_full_day) {
                    message = `${leave_type}
                        ลาตั้งแต่วันที่ ${date_start} - ${date_stop}`;
                } else {
                    message = `${leave_type}
                        ลาวันที่ ${date_start}
                        เวลา ${hour_start}:${minute_start} - ${time_stop}`;
                }

                $('#confirm_description').text(message);
                const text_btn_send = $('#btn_leave_send').text();
                const is_attach_file = tempFileIds.length > 0;
                if (text_btn_send === "แนบไฟล์ย้อนหลัง" && !is_attach_file) {
                    alert("กรุณาแนบไฟล์");
                } else {
                    $('#modal_confirm').modal();
                }
            } else {
                alert('ไม่สามารถลาข้ามปีได้');
            }
        });

        $('#confirm_ok').on('click', async function () {
            $('#confirm_ok').attr('disabled', true);
            $('#SpinModal').modal();
            let emp_id = $('#emp_id').val();
            let leave_type_id = $('#select_leave_type').val();
            let leave = leaves.filter(f => f.leave_type_id === leave_type_id).map(m => m)[0];
            let leave_type_code = leave.leave_type_code;
            let is_two_step_approve = leave.is_two_step_approve;
            let start_request_date = $('#leave_start_date').val();
            let end_request_date = $('#leave_stop_date').val();
            let description = $('#leave_note').val();
            let amount_leave_day = $('#amount_leave').val();

            let start_request_time = "00:00:00";
            let end_request_time = "00:00:00";
            if (!is_full_day) {
                let hour = $('#leave_start_hour').val();
                let minute = $('#leave_start_minute').val();
                start_request_time = hour + ":" + minute;
                end_request_time = $('#leave_stop_time').val();
            }
            let str = JSON.stringify({
                "emp_id": emp_id,
                "leave_type_id": leave_type_id,
                "leave_type_code": leave_type_code,
                "start_request_date": start_request_date,
                "end_request_date": end_request_date,
                "path_file": "",
                "status_request": "Pending",
                "description": description,
                "start_request_time": start_request_time,
                "end_request_time": end_request_time,
                "amount_leave_day": amount_leave_day,
                "is_two_step_approve": is_two_step_approve,
                "is_full_day": is_full_day,
                "amount_leave_hour": 0,
            });

            const text_btn_send = $('#btn_leave_send').text();

            let is_attach_file = tempFileIds.length > 0;

            await $.ajax({
                type: "POST",
                url: '@Url.Action("EditRequest", "StatusLeave")',
                contentType: 'application/x-www-form-urlencoded',
                data: {
                    request_id, str, is_attach_file, text_btn_send
                },
                success: function (response) {
                    if (response === "Success") {
                        alert("แก้ไขวันลาเรียบร้อย");
                        $('#modal_confirm').modal('hide');
                        $('#modal_leave').modal('hide');
                    } else {
                        alert(response);
                    }
                }
            });
 
            location.reload();
            $('#SpinModal').modal('hide');
            $('#confirm_ok').attr('disabled', false);
        });

        $('#btn_delete').on('click', function () {
            $('#confirmDeleteModal').modal();
        });
        $('#btn_checker_delete').on('click', function () {
            $('#confirmCheckerDeleteModal').modal();
        });

        $('#btn_confirm_delete').on('click', async function () {
            let emp_id = $('#hidden_emp_id').val();
            await $.ajax({
                type: "DELETE",
                url: '@Url.Action("DeleteRequest", "StatusLeave")',
                contentType: 'application/x-www-form-urlencoded',
                data: {
                    request_id, emp_id
                },
                success: function (response) {
                    if (response === "Success") {
                        alert("ลบวันลาเรียบร้อย");
                        location.reload();
                    } else {
                        alert(response);
                    }
                }
            });
        });

        $('#btn_confirm_checker_delete').on('click', async function () {
            let emp_id = $('#hidden_emp_id').val();
            await $.ajax({
                type: "DELETE",
                url: '@Url.Action("CheckerDeleteRequest", "StatusLeave")',
                contentType: 'application/x-www-form-urlencoded',
                data: {
                    request_id, emp_id
                },
                success: function (response) {
                    if (response === "Success") {
                        alert("ลบวันลาเรียบร้อย");
                        location.reload();
                    } else {
                        alert(response);
                    }
                }
            });
        });

        function formatDate(date) {
            const daysThai = ['อา.', 'จ.', 'อ.', 'พ.', 'พฤ.', 'ศ.', 'ส.'];
            const dayOfWeek = daysThai[date.getDay()];
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${dayOfWeek} ${day}/${month}/${year}`;
        }

    </script>

    <script type="text/javascript">
        let table_leave = null;
        let departments = [];
        let employees = [];
        let selectedEmployee = null;
        let requestHistory = [];

        const request_status = [
            { status_en: "Created", status: { status_th: "สร้าง", class: "primary" } },
            { status_en: "Pending", status: { status_th: "อนุมัติ", class: "warning" } },
            { status_en: "Resubmit", status: { status_th: "ส่งใหม่", class: "secondary" } },
            { status_en: "Canceled", status: { status_th: "ยกเลิก", class: "danger" } },
            { status_en: "Approved", status: { status_th: "อนุมัติ", class: "success" } },
            { status_en: "Rejected", status: { status_th: "ไม่อนุมัติ", class: "danger" } },
            { status_en: "Returned", status: { status_th: "ตีกลับ", class: "info" } },
            { status_en: "Completed", status: { status_th: "สำเร็จ", class: "success" } },
        ];

        $(document).ready(async function () {
            const today = new Date();
            let start = new Date(today);
            start.setDate(1);
            start = start.toISOString().split('T')[0];

            today.setMonth(today.getMonth() + 1);
            const to_day = today.toISOString().split('T')[0];

            document.getElementById('date_start').value = start;
            document.getElementById('date_stop').value = to_day;

            employees = await GetEmployee(start, to_day);
            initSearchEvents();
            loadInitialLeaveHistory();

            const emp_id = '@Html.Raw(emp_id)';
            const emp = employees.filter(f => f.emp_id === emp_id).map(m => m)[0];
            selectEmployee(emp);

            let year = new Date(start).getFullYear();
            $('#label_entitlement').text("สิทธิ์การลาที่ใช้ปี " + year + " (วัน)");
        });

        async function GetEmployee(start, stop) {
            let emps = [];
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetEmployee", "StatusLeave")',
                contentType: 'application/x-www-form-urlencoded',
                data: { start, stop },
                success: function (response) {
                    departments = response.departments;
                    emps = response.employees;
                    GenerateDepartmentOption(departments);
                    GenerateUserOption(emps);
                },
                error: function () {
                    console.error('โหลดข้อมูลพนักงานล้มเหลว');
                }
            });
            return emps;
        }

        async function GetDepartmentRequestHistory(department, start, stop) {
            const response = await $.ajax({
                type: "GET",
                url: '@Url.Action("GetDepartmentRequestHistory", "StatusLeave")',
                data: { department, start, stop },
                dataType: 'json'
            });
            return response;
        }

        async function GetRequestHistory(emp_id, start, stop) {
            const response = await $.ajax({
                type: "GET",
                url: '@Url.Action("GetRequestHistory", "StatusLeave")',
                data: { emp_id, start, stop },
                dataType: 'json'
            });
            return response;
        }

        async function GetLeaveUsed(emp_id,year) {
            let useds = [];
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetLeaveUsedByEmpID", "StatusLeave")',
                contentType: 'application/x-www-form-urlencoded',
                data: { emp_id , year},
                success: function (response) {
                    useds = response;
                },
                error: function () {
                    console.error('โหลดสิทธิ์ลาล้มเหลว');
                }
            });
            return useds;
        }

        async function GetRequestLog(request_id,emp_id) {
            let requests = [];
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetRequestLog", "StatusLeave")',
                contentType: 'application/x-www-form-urlencoded',
                data: { request_id, emp_id},
                success: function (response) {
                    requests = response;
                },
                error: function () {
                    console.error('โหลดสิทธิ์ลาล้มเหลว');
                }
            });
            return requests;
        }

        function GenerateDepartmentOption(departments) {
            const $select = $('#departmentSelect');
            $select.empty().append(`<option value="ALL" selected disabled>เลือกแผนก</option>`);
            departments.forEach(dept => {
                $select.append(`<option value="${dept}">${dept}</option>`);
            });
        }

        function GenerateUserOption(employeesList) {
            const $select = $('#employeeSelect');
            $select.empty().append(`<option value="ALL" selected disabled>ทุกคน</option>`);
            employeesList.forEach(emp => {
                $select.append(`<option value="${emp.emp_id}">${emp.emp_id} : ${emp.name_en}</option>`);
            });
        }

        function GenerateUsedLeave(emp_th, useds) {

            const $div = $('#div_leaves_used').empty();
            let str = '';
            useds.forEach(b => {
                str += `
                    <div class="row mb-1">
                        <div class="col-8 kanit-light" style="text-align:start">${b.leave_name_th}</div>
                        <div class="col-4 kanit-light" style="text-align:end">
                            <strong>${b.used}</strong> / <strong>${b.amount_entitlement}</strong>
                        </div>
                    </div>`;
            });
            $div.append(str);
            $('#emp_th_used_leave').text(emp_th);
        }

        $('#date_stop').on('change', async function () {

            $('#emp_th_used_leave').text("");
            $('#div_leaves_used').empty();
            $('#employeeInfo').hide();
            clearLeaveHistory();

            let start = $('#date_start').val();
            let stop = $('#date_stop').val();
            let year = new Date(start).getFullYear();
            employees = await GetEmployee(start, stop);
            const emp_id = '@Html.Raw(emp_id)';
            const emp = employees.filter(f => f.emp_id === emp_id).map(m => m)[0];

            selectEmployee(emp);
            $('#label_entitlement').text("สิทธิ์การลาที่ใช้ปี " + year + " (วัน)");
        });

         $('#date_start').on('change', async function () {
            $('#emp_th_used_leave').text("");
            $('#div_leaves_used').empty();
            $('#employeeInfo').hide();
            clearLeaveHistory();

            let start = $('#date_start').val();
            let stop = $('#date_stop').val();
            let year = new Date(start).getFullYear();
            employees = await GetEmployee(start, stop);
            const emp_id = '@Html.Raw(emp_id)';
            const emp = employees.filter(f => f.emp_id === emp_id).map(m => m)[0];

            selectEmployee(emp);
            $('#label_entitlement').text("สิทธิ์การลาที่ใช้ปี " + year + " (วัน)");
         });

        // ===== AUTO-COMPLETE CUSTOM (หลัก) =====
        function initSearchEvents() {
            const $search = $('#employeeSearch');
            const $results = $('#searchResults');
            const $clearBtn = $('#clearSearch');
            const $select = $('#employeeSelect');
            let timeout = null;
            let currentResults = [];

            // แสดง/ซ่อนปุ่มล้าง
            $search.on('input', function () {
                $clearBtn.toggle($search.val().length > 0);
            });

            // ล้างการค้นหา
            $clearBtn.on('click', function () {
                $search.val('').trigger('input');
                $select.val('ALL').trigger('change');
                $results.hide().empty();
                $('#employeeInfo').hide();
                $('#noEmployee').show();
                selectedEmployee = null;
                clearLeaveHistory(); // ล้างตาราง
            });

            // ค้นหาแบบ debounce (หน่วง 300ms)
            $search.on('input', function () {
                clearTimeout(timeout);
                const query = $search.val().trim().toLowerCase();
                timeout = setTimeout(() => filterEmployees(query, $results), 300);
            });

            // คลิกเลือกจากผลลัพธ์
            $results.on('click', '.search-item', function () {
                const emp_id = $(this).data('emp-id');
                const emp = employees.find(e => e.emp_id === emp_id);
                if (emp) {
                    selectEmployee(emp);
                    $search.val(`${emp.emp_id} - ${emp.name_en}`);
                }
                $results.hide().empty();
            });

            // Keyboard navigation (ลูกศร + Enter)
            $search.on('keydown', function (e) {
                const $active = $results.find('.active');
                if (e.key === 'Enter' && $active.length) {
                    e.preventDefault();
                    $active.click();
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    let $next = $active.removeClass('active').next('.search-item');
                    if (!$next.length) $next = $results.find('.search-item').first();
                    $next.addClass('active');
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    let $prev = $active.removeClass('active').prev('.search-item');
                    if (!$prev.length) $prev = $results.find('.search-item').last();
                    $prev.addClass('active');
                } else if (e.key === 'Escape') {
                    $results.hide().empty();
                }
            });

            // ซ่อนผลลัพธ์เมื่อคลิกนอก
            $(document).on('click', function (e) {
                if (!$search.is(e.target) && !$results.is(e.target) && $results.has(e.target).length === 0) {
                    $results.hide().empty();
                }
            });

            // เริ่มต้นซ่อน
            $clearBtn.hide();
            $results.hide();
            $('#employeeInfo').hide();
            $('#noEmployee').show();
        }

        function filterEmployees(query, $results) {
            if (query.length < 2) {
                $results.hide().empty();
                return;
            }

            const filtered = employees.filter(emp =>
                emp.emp_id.toLowerCase().includes(query) ||
                (emp.name_en && emp.name_en.toLowerCase().includes(query)) ||
                (emp.name_th && emp.name_th.toLowerCase().includes(query))
            ).slice(0, 10);

            $results.empty();
            if (filtered.length === 0) {
                $results.append('<div class="list-group-item text-muted text-center p-3">ไม่พบพนักงาน</div>').show();
                return;
            }

            filtered.forEach((emp, idx) => {
                const item = $(`
                    <div class="list-group-item search-item kanit-light p-3 border-bottom"
                         data-emp-id="${emp.emp_id}"
                         style="cursor: pointer; transition: background 0.2s;">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>${emp.emp_id}</strong>
                            <small class="text-muted">${emp.name_th || emp.name_en}</small>
                        </div>
                        <small class="text-muted d-block">${emp.department || ''}</small>
                    </div>
                `);
                if (idx === 0) item.addClass('active bg-light');
                $results.append(item);
            });
            $results.show();
        }

        async function selectEmployee(emp) {

            if (emp !== undefined) {
                selectedEmployee = emp;
                $('#EmpId').text(emp.emp_id);
                $('#EmpName').text(emp.name_en);
                $('#department').text(emp.department || '-');
                $('#position').text(emp.position || '-');
                $('#phone').text(emp.phone || '-');
                $('#startDate').text(emp.start_date ? new Date(emp.start_date).toLocaleDateString('th-TH') : '-');

                $('#employeeInfo').show();
                $('#noEmployee').hide();
                $('#employeeSelect').val(emp.emp_id);

                setTimeout(() => {
                    loadLeaveUsedAndHistory(emp.emp_id, emp.name_th);
                }, 10);
            }
        }

        async function loadLeaveDepartmentAndHistory(department) {
            let start = $('#date_start').val();
            let stop = $('#date_stop').val();
            try {
                requestHistory = await GetDepartmentRequestHistory(department, start, stop);
                renderLeaveHistory();
            } catch (err) {
                console.error("Error loading leave data:", err);
            }
        }

        async function loadLeaveUsedAndHistory(emp_id, emp_th_name) {
            let start = $('#date_start').val();
            let stop = $('#date_stop').val();
            let year = new Date(start).getFullYear();
            try {
                requestHistory = await GetRequestHistory(emp_id, start, stop);
                const useds = await GetLeaveUsed(emp_id, year);
                GenerateUsedLeave(emp_th_name, useds);
                renderLeaveHistory();
            } catch (err) {
                console.error("Error loading leave data:", err);
            }
        }

        function GetDayOfWeekName(date) {
            const dayName = date.toLocaleDateString('th-TH', { weekday: 'short' });
            return dayName;
        }
        function timeToMinutes(timeStr) {
            const timePart = timeStr.split('.').pop();
            const [h, m] = timePart.split(':').map(Number);
            return h * 60 + m;
        }

        let dataTable;
        function renderLeaveHistory() {
            const data = requestHistory.map((row, index) => {
                let request_date = `${GetDayOfWeekName(new Date(row.request_date))} ${new Date(row.request_date).toLocaleDateString('en-GB')}`;
                let start_request_date = "";
                if (row.is_full_day) {
                    if (row.amount_leave_day > 1) {
                        start_request_date = `${GetDayOfWeekName(new Date(row.start_request_date))} ${new Date(row.start_request_date).toLocaleDateString('en-GB')} - ${GetDayOfWeekName(new Date(row.end_request_date))} ${new Date(row.end_request_date).toLocaleDateString('en-GB')}`;
                    } else {
                        start_request_date = `${GetDayOfWeekName(new Date(row.start_request_date))} ${new Date(row.start_request_date).toLocaleDateString('en-GB')}`;
                    }
                } else {
                    start_request_date = `${GetDayOfWeekName(new Date(row.start_request_date))} ${new Date(row.start_request_date).toLocaleDateString('en-GB')}`;
                }

                let duration = 0;
                let start_request_time = "08:30";
                let end_request_time = "17:30";
                if (row.is_full_day) {
                    duration = row.amount_leave_day;
                } else {
                    let start = timeToMinutes(row.start_request_time);
                    let end = timeToMinutes(row.end_request_time);
                    let diff = end - start;
                    duration = (diff / 480).toFixed(2);
                    if (duration > 0.3 && duration < 0.6) {
                        duration = 0.50;
                    }

                    start_request_time = row.start_request_time.split('.')[1].substring(0, 5);
                    end_request_time = row.end_request_time.split('.')[1].substring(0, 5);
                }
                let status = request_status.filter(f => f.status_en === row.status_request).map(m => m.status)[0];
                return {
                    no: index + 1,
                    emp_id: row.emp_id,
                    name: row.emp_name_th || "", //selectedEmployee ? selectedEmployee.name_th || selectedEmployee.name_en : '-',
                    request_date: request_date,
                    leave_date: start_request_date,
                    time: start_request_time + "-" + end_request_time,
                    duration: duration,
                    type: row.leave_name_th,
                    note: row.description || '-',
                    status: `<span class="badge badge-${status.class} p-2 kanit-light" style="font-size:16px; border-radius:20px;">${status.status_th}</span>`,
                    raw: row
                };
            });

            if (dataTable) {
                dataTable.destroy();
            }

            dataTable = $('#table_leave').DataTable({
                destroy: true,
                data: data,
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/2.1.8/i18n/th.json'
                },
                pageLength: 20,
                scrollX: true,
                fixedHeader: true,
                //fixedColumns: {
                //    left: 3
                //},
                /*order: [[4, 'desc']],*/
                columnDefs: [
                    //{ className: "freeze-left-1", targets: 0 },
                    //{ className: "freeze-left-2", targets: 1 },
                    //{ className: "freeze-left-3", targets: 2 }
                ],
                columns: [
                    { data: 'no' },
                    { data: 'emp_id' },
                    { data: 'name' },
                    { data: 'request_date' },
                    { data: 'leave_date' },
                    { data: 'time' },
                    { data: 'duration' },
                    { data: 'type' },
                    { data: 'note' },
                    { data: 'status'}
                ],
                createdRow: function (row, data, dataIndex) {
                    $(row).addClass('clickable-row kanit-regular')
                        .css({ color: '#555', fontSize: '16px' })
                        .attr({
                            'data-toggle': 'modal',
                            'data-target': '#modal_edit_leave',
                            'data-request_id': data.raw.request_id,
                            'data-leave_type_id': data.raw.leave_type_id,
                            'data-emp-id': data.raw.emp_id,
                            'data-request-date': data.raw.request_date,
                            'data-start_request_date': data.raw.start_request_date,
                            'data-end_request_date': data.raw.end_request_date,
                            'data-time': data.raw.time_range,
                            'data-duration': data.duration,
                            'data-type': data.raw.leave_name_th,
                            'data-note': data.raw.description || '',
                            'data-status': data.raw.status_request
                        })
                        .css('cursor', 'pointer');
                },
                info: false,
                searching: false,
                paging:false
            });
        };

        $(document).on('click', '.clickable-row',async function () {
            const data = $(this).data();

            const requestid = data.request_id;
            request_id = requestid;
            let main_emp_id = $('#hidden_emp_id').val();
            let role = '@Html.Raw(role)';

            const request = requestHistory.filter(f => f.request_id === request_id).map(m => m)[0];
            $('#emp_id').val(data.empId);
            $('#emp_name').val($(this).find('td:eq(2)').text());
            try {
                let emp_id = $('#emp_id').val();
                let year = new Date(request.start_request_date).getFullYear();
                const result = await GetLeaveByID(request.leave_type_id, emp_id, year)
                const leave = result.leave;
                let description = leave.description;
                balance_leave = result.balance_leave;
                $('#leave_balance').text(balance_leave + '/' + leave.amount_entitlement + ' วัน');
                $('#leave_description').text(description);

                $('#select_leave_type').val(data.leave_type_id);
                $('#leave_start_date').val(data.start_request_date.split('T')[0]);
                $('#leave_stop_date').val(data.end_request_date.split('T')[0]);
                $('#leave_note').val(data.note);

                if (request.is_full_day) {
                    // Full day
                    resetButtonStyles();
                    leaveFullBtn.classList.add('active');
                    toggleGroupDisplay(dateGroup, true);
                    toggleGroupDisplay(timeGroup, false);

                    $('#amount_leave').val(data.duration);
                    type_duration = "Day";
                    stopDateInput.disabled = false;
                } else {
                    resetButtonStyles();
                    toggleGroupDisplay(dateGroup, true);
                    toggleGroupDisplay(timeGroup, true);

                    const start_time = request.start_request_time.split('.')[1];
                    const end_time = request.end_request_time.split('.')[1];

                    const diff_time = parseInt(timeToMinutes(end_time)) - parseInt(timeToMinutes(start_time));
                    if (diff_time === 120) {
                        setHourlyOptions();
                        type_duration = "Hours";
                        durationSelect.value = "2";
                        leaveHoursBtn.classList.add('active');

                    } else if (diff_time >= 210 && diff_time < 360) {

                        if ((start_time === "08:30:00" || start_time === "13:00:00") && (end_time === "12:00:00" || end_time === "17:30:00")) {
                            setHalfDayOptions();
                            type_duration = "Half";
                            if (start_time === "08:30:00" && end_time === "12:00:00") {
                                durationSelect.value = "morning";

                            } else if (start_time === "13:00:00" && end_time === "17:30:00") {
                                durationSelect.value = "afternoon";
                            }
                            leaveHalfBtn.classList.add('active');
                        } else {
                            setHourlyOptions();
                            type_duration = "Hours";
                            durationSelect.value = "4";
                            leaveHoursBtn.classList.add('active');
                        }


                    } else if (diff_time === 360) {
                        setHourlyOptions();
                        type_duration = "Hours";
                        durationSelect.value = "6";
                        leaveHoursBtn.classList.add('active');
                    }

                    startHourTimeInput.value = start_time.split(':')[0];
                    startMinuteTimeInput.value = start_time.split(':')[1];
                    stopTimeInput.value = end_time;

                    $('#amount_leave').val(0);
                    is_full_day = false;
                }

                CheckAttachFileRequire(type_duration);
                //Check Edit
                if (main_emp_id === data.empId) {
                    if (data.status === "Created" || data.status === "Returned" || data.status === "Resubmit") {
                        $('#btn_leave_send').attr('disabled', false);
                        $('#btn_delete').attr('hidden', false);

                        $('#select_leave_type').attr('disabled', false);
                        $('#leave_full').attr('disabled', false);
                        $('#leave_half').attr('disabled', false);
                        $('#leave_hours').attr('disabled', false);
                        $('#leave_stop_date').attr('disabled', false);
                        $('#btn_leave_send').text("แก้ไขวันลา");
                        $('#btn_leave_send').attr('hidden', false);
                    } else if (data.status === "Approved") {

                        $('#btn_delete').attr('hidden', true);
                        $('#select_leave_type').attr('disabled', true);
                        $('#leave_full').attr('disabled', true);
                        $('#leave_half').attr('disabled', true);
                        $('#leave_hours').attr('disabled', true);
                        $('#leave_stop_date').attr('disabled', true);

                        if (request.attachment_required) {
                            $('#btn_leave_send').text("แนบไฟล์ย้อนหลัง");
                            $('#btn_leave_send').attr('disabled', false);
                            $('#btn_leave_send').attr('hidden', false);
                        } else {
                            $('#btn_leave_send').attr('hidden', true);
                            $('#btn_leave_send').attr('disabled', true);
                        }
                        $('#btn_leave_send').attr('hidden', false);
                    } else {
                        $('#btn_delete').attr('hidden', true);
                        $('#btn_leave_send').attr('hidden', true);
                    }

                } else {
                    $('#btn_leave_send').attr('hidden', true);
                    $('#btn_leave_send').attr('disabled', true);
                    $('#btn_delete').attr('hidden', true);

                    $('#select_leave_type').attr('disabled', true);
                    $('#leave_full').attr('disabled', true);
                    $('#leave_half').attr('disabled', true);
                    $('#leave_hours').attr('disabled', true);
                    $('#leave_stop_date').attr('disabled', true);
                }

                //Check Admin Leave for Cancle
                if (data.status === "Completed" && role === "Admin_Leave") {
                    $('#btn_checker_delete').attr('hidden', false);
                } else {
                    $('#btn_checker_delete').attr('hidden', true);
                }

                //Get Request Log

                const request_log = await GetRequestLog(request_id);
                GenerateHistoryApproveLog(request_log);

                $('#modal_leave_title').text('แก้ไขการลา');
                $('#modal_leave').modal('show');

                //Check Attach File List

                if (request.attachment_required) {
                    const year = new Date(request.start_request_date).getFullYear();
                    loadExistingFiles(request.leave_type_id, year, request.request_id);
                }
            } catch (error) {
                console.log(error);
            }
        });

        async function handleLeaveTypeChange(leave_type_id) {
            try {
                let leave_type_id = $('#select_leave_type').val();
                let request_date = today.toISOString();
                let start_request_date = $('#leave_start_date').val();
                let leave_ = leaves.filter(f => f.leave_type_id === leave_type_id).map(m => m)[0];
                let description = leave_.description;
                let emp_id = $('#emp_id').val();
                let leave;
                let year = new Date(start_request_date).getFullYear();
                const result = await GetLeaveByID(leave_type_id, emp_id, year)
                let hire_date = new Date();
                $('#leave_stop_date').val(request_date);
                $('#amount_leave').val(1);

                leave = result.leave;
                balance_leave = result.balance_leave;
                gender = result.gender;
                hire_date = result.hire_date;

                //Check Request Timing
                let chk_request_timing = CheckRequestTiming(request_date);

                let amount_diff_day = diffDays(new Date(), hire_date);
                if (amount_diff_day > leave.length_start_date) {
                    if (chk_request_timing) {
                        //Check Gender Restriction
                        let chk_gender_restriction = CheckGenderRestriction(gender);
                        if (chk_gender_restriction) {

                            //After Change Select Type
                            if (tigger_select) {
                                $('#leave_description').text(description);
                                $('#leave_balance').text(balance_leave + '/' + leave.amount_entitlement + ' วัน');
                                $('#div_leave').prop('hidden', false);
                                $('#div_main_leave').css('height', '500px');
                                $('#div_main_leave').css('overflow-y', 'auto');
                                $('#btn_leave_send').prop('disabled', false);

                                //Reset Full day Click
                                resetButtonStyles();
                                leaveFullBtn.classList.add('active');
                                toggleGroupDisplay(dateGroup, true);
                                toggleGroupDisplay(timeGroup, false);
                                //daysInput.disabled = false;
                                daysInput.value = 1;
                                stopDateInput.value = startDateInput.value;
                                stopDateInput.disabled = false;

                                //Check attachment_required
                                type_duration = "Day";
                                CheckAttachFileRequire(type_duration);

                                $('#leave_full').prop('disabled', false);
                                $('#leave_half').prop('disabled', false);
                                $('#leave_hours').prop('disabled', false);
                                $('#leave_stop_date').prop('disabled', false);
                            }

                        } else {
                            alert('ไม่สามารถลาได้เนื่องจากเพศสภาพไม่ตรงกับการลา');
                            $('#btn_leave_send').prop('disabled', true);
                            $('#leave_full').prop('disabled', true);
                            $('#leave_half').prop('disabled', true);
                            $('#leave_hours').prop('disabled', true);
                            $('#leave_stop_date').prop('disabled', true);
                        }
                    } else {
                        alert('ไม่สามารถลาได้เนื่องจากช่วงเวลาการลาไม่ถูกต้อง');
                        $('#btn_leave_send').prop('disabled', true);
                        $('#leave_full').prop('disabled', true);
                        $('#leave_half').prop('disabled', true);
                        $('#leave_hours').prop('disabled', true);
                        $('#leave_stop_date').prop('disabled', true);
                    }
                } else {
                    alert('ไม่สามารถลาได้เนื่องจากวันทำงานยังไม่ครบกำหนด');
                    $('#btn_leave_send').prop('disabled', true);
                    $('#leave_full').prop('disabled', true);
                    $('#leave_half').prop('disabled', true);
                    $('#leave_hours').prop('disabled', true);
                    $('#leave_stop_date').prop('disabled', true);
                }
                is_full_day = true;
                tigger_select = true;

            } catch (error) {
                console.error("Error in handleLeaveTypeChange:", error);
                alert('เกิดข้อผิดพลาดในการโหลดข้อมูลการลา กรุณาลองใหม่');
                disableAllLeaveControls();
            }
        };

        function disableAllLeaveControls() {
            $('#btn_leave_send, #leave_full, #leave_half, #leave_hours, #leave_stop_date')
                .prop('disabled', true);
        }

        $('#select_leave_type').on('change', async function () {
            const leave_type_id = $(this).val();
            for (let i = 0; i < 2; i++) {
                if (leave_type_id) {
                    await handleLeaveTypeChange(leave_type_id);
                } else {
                    $('#div_leave').prop('hidden', true);
                    disableAllLeaveControls();
                }
            }
        });

        function GenerateHistoryApproveLog(requests_log) {
            var html = '';
            let position = "";
            let status = "";
            for (var i = 0; i < requests_log.length; i++) {

                if (requests_log[i].action_by_level === 0) {
                    position = "Operation";
                }
                if (requests_log[i].action_by_level === 1) {
                    position = "Manager";
                }
                if (requests_log[i].action_by_level === 2) {
                    position = "Director";
                }
                if (requests_log[i].action_by_level === 3) {
                    position = "Checker";
                }

                status = request_status.filter(f => f.status_en === requests_log[i].new_status).map(m => m.status)[0];

                if (requests_log[i].new_status !== "Rejected" && requests_log[i].new_status !== "Canceled" && requests_log[i].new_status !== "Returned") {
                    html += `<div class="d-flex align-items-center mb-3 text-success">
                                <i class="fas fa-check-circle fa-lg mr-3"></i>
                                <div class="flex-grow-1">
                                    <span class="kanit-medium" style="color:#555">${requests_log[i].action_by_name}</span>
                                    <span class="text-muted kanit-regular">(${position})</span>
                                    <div>
                                        <span class="text-success kanit-medium">${status.status_th}</span>
                                        <span class="text-muted kanit-medium"> • ${new Date(requests_log[i].log_date).toLocaleDateString('en-GB')} ${requests_log[i].log_date.split('T')[1]}</span>
                                    </div>
                                </div>
                                <hr />
                            </div>`;
                } else {
                    html += `<div class="d-flex align-items-center mb-3 text-danger">
                                <i class="fas fa-minus-circle fa-lg mr-3"></i>
                                <div class="flex-grow-1">
                                    <span class="kanit-medium" style="color:#555">${requests_log[i].action_by_name}</span>
                                    <span class="text-muted kanit-regular">(${position})</span>
                                    <div>
                                        <span class="text-danger kanit-medium">${status.status_th}</span>
                                        <span class="text-muted kanit-medium"> • ${new Date(requests_log[i].log_date).toLocaleDateString('en-GB')} ${requests_log[i].log_date.split('T')[1]}</span>
                                    </div>
                                </div>
                                <hr />
                            </div>`;
                }
            }

            $('#div_history_approved').empty();
            $('#div_history_approved').append(html);
        }

        function clearLeaveHistory() {
            $('#table_leave tbody').empty();
        }

        function loadInitialLeaveHistory() {
            renderLeaveHistory('ALL');
        }

        $('#departmentSelect').on('change', function () {
            const department = $(this).val();
            const filteredEmps = department === "ALL" ? employees : employees.filter(e => e.department === department);
            GenerateUserOption(filteredEmps);
            selectedEmployee = null;
            $('#employeeInfo').hide();
            $('#noEmployee').show();
            clearLeaveHistory();
            loadLeaveDepartmentAndHistory(department);
        });

        $('#employeeSelect').on('change', function () {
            const emp_id = $(this).val();
            if (emp_id === 'ALL') {
                $('#employeeSearch').val('');
                $('#searchResults').hide();
                $('#employeeInfo').hide();
                $('#noEmployee').show();
                selectedEmployee = null;
                clearLeaveHistory();
            } else {
                const emp = employees.find(e => e.emp_id === emp_id);
                if (emp) {
                    const selectedText = `${emp.emp_id} : ${emp.name_en}`;
                    $('#employeeSearch').val(selectedText);
                    $('#searchResults').hide();
                    selectEmployee(emp);
                }
            }
        });

        $('#modal_leave').on('show.bs.modal', function (e) {
            if (selectedEmployee) {
                $('#emp_id').val(selectedEmployee.emp_id);
                $('#emp_name').val(selectedEmployee.name_en);
            }
        });


        $('#yearFilter, #monthFilter').on('change', function () {
            if (selectedEmployee) {
                renderLeaveHistory(selectedEmployee.emp_id);
            }
        });

        $(function () {
            $('#btn_confirm_delete').on('click', function () {
                $('#confirmDeleteModal').modal('hide');

                toastr.error('ลบรายการเรียบร้อยแล้ว');
                setTimeout(() => { $('#yourMainModal').modal('hide'); location.reload(); }, 1000);
            });

            $('#btn_confirm_edit').on('click', function () {
                $('#confirmEditModal').modal('hide');

                toastr.success('ส่งแก้ไขเรียบร้อยแล้ว');
                setTimeout(() => { $('#yourMainModal').modal('hide'); }, 1000);
            });
        });
    </script>

    <script type="text/javascript">

        let create_leaves = [];
        let create_balance_leave = 0;
        let create_type_duration = "Day";
        let create_file_require = false;
        let create_is_full_day = true;
        let create_gender = "";
        let create_tempFileIds = [];

        const create_hourSelect = document.getElementById('create_leave_start_hour');
        const create_leaveFullBtn = document.getElementById('create_leave_full');
        const create_leaveHalfBtn = document.getElementById('create_leave_half');
        const create_leaveHoursBtn = document.getElementById('create_leave_hours');
        const create_dateGroup = document.getElementById('create_leave_date_group');
        const create_attachFileGroup = document.getElementById('create_leave_attach_file_group');
        const create_timeGroup = document.getElementById('create_leave_time_group');
        const create_durationSelect = create_timeGroup.querySelector('select');
        const create_startHourTimeInput = document.getElementById('create_leave_start_hour');
        const create_startMinuteTimeInput = document.getElementById('create_leave_start_minute');
        const create_startDateInput = document.getElementById('create_leave_start_date');
        const create_stopTimeInput = document.getElementById('create_leave_stop_time');
        const create_stopDateInput = document.getElementById('create_leave_stop_date');
    const create_daysInput = create_dateGroup.querySelector('input[type="number"]'); // ช่องลาจำนวน

        const create_fileInput = document.getElementById('create_leave_fileInput');
        const create_selectFileBtn = document.getElementById('create_selectFileBtn');
        const create_uploadForm = document.getElementById('create_uploadForm');
        const create_fileListContainer = document.getElementById('create_leave_fileListContainer');



        // 08-15
        for (let h = 8; h <= 15; h++) {
            const option = document.createElement('option');
            option.value = String(h).padStart(2, '0');
            option.textContent = String(h).padStart(2, '0');
            create_hourSelect.appendChild(option);
        }
        create_hourSelect.value = '08';

        function CreateLeave() {
            $('#CreateModal').modal();
        }

        $('#btn_confirm_date_create').on('click', async function () {
            $('#CreateModal').modal('hide');
            let date_create = $('#date_create_leave').val();
            $('#create_leave_start_date').val(date_create);
            $('#create_leave_start_date').val(date_create);
            $('#create_leave_stop_date').val(date_create);
            $('#create_div_leave').prop('hidden', true);
            $('#create_div_main_leave').css('height', '100px');
            $('#create_div_main_leave').css('overflow-y', 'hidden');
            $('#create_btn_leave_send').prop('disabled', true);
            await CreateGetLeaveType();
            $('#modal_create_leave').modal();
        });

        $('#date_create_leave').on('change', function () {
            const date = new Date($('#date_create_leave').val());

            const isHoliday = holidays.some(holiday =>
                new Date(holiday.date).getFullYear() === date.getFullYear() &&
                new Date(holiday.date).getMonth() === date.getMonth() &&
                new Date(holiday.date).getDate() === date.getDate()
            );
            const dayOfWeek = date.getDay();

            const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
            if (isWeekend || isHoliday) {
                alert('วันหยุด');
                $('#btn_confirm_date_create').attr('disabled', true);
            } else {
                $('#btn_confirm_date_create').attr('disabled', false);
            }
        });

        $('#create_select_leave_type').on('change', async function () {
            let date_create = $('#date_create_leave').val();
            let leave_type_id = $('#create_select_leave_type').val();
            let request_date = date_create;
            let leave_ = create_leaves.filter(f => f.leave_type_id === leave_type_id).map(m => m)[0];
            let description = leave_.description;
            let emp_id = '@Html.Raw(Model.emp_id)';
            let leave;
            let year = new Date(request_date).getFullYear();
            let hire_date = new Date();
            $('#create_leave_stop_date').val(request_date);
            $('#create_amount_leave').val(1);
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetLeaveByID", "Leave")',
                contentType: 'application/x-www-form-urlencoded',
                data: {
                    leave_type_id, emp_id,year
                },
                success: function (response) {
                    leave = response.leave;
                    create_balance_leave = response.balance;
                    create_gender = response.gender;
                    hire_date = response.hire_date;
                }
            });

            //Check Request Timing
            let chk_request_timing = CheckCreateRequestTiming(request_date);
            let amount_diff_day = diffDays(new Date(), hire_date);
            if (amount_diff_day > leave.length_start_date) {
                if (chk_request_timing) {
                    //Check Gender Restriction
                    let chk_gender_restriction = CheckCreateGenderRestriction(create_gender);

                    if (chk_gender_restriction) {

                        $('#create_leave_description').text(description);
                        $('#create_leave_balance').text(create_balance_leave + '/' + leave.amount_entitlement + ' วัน');
                        $('#create_div_leave').prop('hidden', false);
                        $('#create_div_main_leave').css('height', '500px');
                        $('#create_div_main_leave').css('overflow-y', 'auto');
                        $('#create_btn_leave_send').prop('disabled', false);

                        //Reset Full day Click
                        resetCreateButtonStyles();
                        create_leaveFullBtn.classList.add('active');
                        create_toggleGroupDisplay(create_dateGroup, true);
                        create_toggleGroupDisplay(create_timeGroup, false);
                        //daysInput.disabled = false;
                        create_daysInput.value = 1;
                        create_stopDateInput.value = create_startDateInput.value;
                        create_stopDateInput.disabled = false;

                        //Check attachment_required
                        create_type_duration = "Day";
                        CheckCreateAttachFileRequire(create_type_duration);

                        $('#create_leave_full').prop('disabled', false);
                        $('#create_leave_half').prop('disabled', false);
                        $('#create_leave_hours').prop('disabled', false);
                        $('#create_leave_stop_date').prop('disabled', false);
                    } else {
                        alert('ไม่สามารถลาได้เนื่องจากเพศสภาพไม่ตรงกับการลา');
                        $('#create_btn_leave_send').prop('disabled', true);
                        $('#create_leave_full').prop('disabled', true);
                        $('#create_leave_half').prop('disabled', true);
                        $('#create_leave_hours').prop('disabled', true);
                        $('#create_leave_stop_date').prop('disabled', true);
                    }
                } else {
                    alert('ไม่สามารถลาได้เนื่องจากช่วงเวลาการลาไม่ถูกต้อง');
                    $('#create_btn_leave_send').prop('disabled', true);
                    $('#create_leave_full').prop('disabled', true);
                    $('#create_leave_half').prop('disabled', true);
                    $('#create_leave_hours').prop('disabled', true);
                    $('#create_leave_stop_date').prop('disabled', true);
                }
            } else {
                alert('ไม่สามารถลาได้เนื่องจากวันทำงานยังไม่ครบกำหนด');
                $('#create_btn_leave_send').prop('disabled', true);
                $('#create_leave_full').prop('disabled', true);
                $('#create_leave_half').prop('disabled', true);
                $('#create_leave_hours').prop('disabled', true);
                $('#create_leave_stop_date').prop('disabled', true);
            }
            create_is_full_day = true;
        });


        function resetCreateButtonStyles() {
            create_leaveFullBtn.classList.remove('active');
            create_leaveHalfBtn.classList.remove('active');
            create_leaveHoursBtn.classList.remove('active');
        }

            function create_setHalfDayOptions() {
                create_durationSelect.innerHTML = `
                        <option value=""selected disabled>Select</option>
                        <option value="morning">ครึ่งวันเช้า</option>
                        <option value="afternoon">ครึ่งวันบ่าย</option>
                    `;
                create_startHourTimeInput.value = '08';
                create_startMinuteTimeInput.value = '00';
                create_stopTimeInput.value = '';
                create_startHourTimeInput.disabled = false;
                create_startMinuteTimeInput.disabled = false;
                create_daysInput.value = 0;
                create_stopDateInput.value = create_startDateInput.value;
                create_stopDateInput.disabled = true;
                // เพิ่ม event listener สำหรับการเปลี่ยนแปลงใน select
                create_durationSelect.onchange = function () {
                    if (this.value === 'morning') {
                        create_startHourTimeInput.value = '08';
                        create_startMinuteTimeInput.value = '30';
                        create_stopTimeInput.value = '12:00';
                        create_startHourTimeInput.disabled = true;
                        create_startMinuteTimeInput.disabled = true;
                    } else if (this.value === 'afternoon') {
                        create_startHourTimeInput.value = '13';
                        create_startMinuteTimeInput.value = '00';
                        create_stopTimeInput.value = '17:30';
                        create_startHourTimeInput.disabled = true;
                        create_startMinuteTimeInput.disabled = true;
                    } else {
                        create_startHourTimeInput.value = '08';
                        create_startMinuteTimeInput.value = '30';
                        create_stopTimeInput.value = '';
                        create_startHourTimeInput.disabled = false;
                        create_startMinuteTimeInput.disabled = false;
                    }

                    // Check balance
                    if (create_balance_leave < 0.5) {
                        alert('วันลาไม่เพียงพอ');
                        $('#create_btn_leave_send').prop('disabled', true);
                    } else {
                        $('#create_btn_leave_send').prop('disabled', false);
                    }
                };
            }
            // ฟังก์ชันจัดการตัวเลือกใน select สำหรับ leave_hours
        function create_setHourlyOptions() {
            create_durationSelect.innerHTML = `
                        <option value="" selected disabled>Select</option>
                        <option value="2">2 ชั่วโมง</option>
                        <option value="4">4 ชั่วโมง</option>
                        <option value="6">6 ชั่วโมง</option>
                    `;
            create_startHourTimeInput.value = '08';
            create_startMinuteTimeInput.value = '30';
            create_stopTimeInput.value = '';
            create_startHourTimeInput.disabled = false;
            create_startMinuteTimeInput.disabled = false;
            create_daysInput.value = 0;
            create_stopDateInput.value = create_startDateInput.value;
            create_stopDateInput.disabled = true;
            // รีเซ็ตค่าเวลาและ enable start_time เมื่อเปลี่ยนเป็นรายชั่วโมง
            create_durationSelect.onchange = function () {

                calculateCreateTime();
                create_startHourTimeInput.disabled = false;
                create_startMinuteTimeInput.disabled = false;
                // Check Balance
                let duration = parseInt(create_durationSelect.value);
                let hour = (duration / 8);
                if (create_balance_leave < hour) {
                    alert('วันลาไม่เพียงพอ');
                    $('#create_btn_leave_send').prop('disabled', true);
                } else {
                    $('#create_btn_leave_send').prop('disabled', false);
                }
            };

            create_startHourTimeInput.onchange = function () {
                calculateCreateTime();
            };

            create_startMinuteTimeInput.onchange = function () {
                calculateCreateTime();
            };
        }
            // ฟังก์ชันจัดการ animation เมื่อแสดงหรือซ่อน
            function create_toggleGroupDisplay(group, show) {
                if (show) {
                    group.style.display = 'flex';
                    group.style.opacity = '0';
                    group.style.transition = 'opacity 0.3s ease-in-out';
                    setTimeout(() => {
                        group.style.opacity = '1';
                    }, 10);
                } else {
                    group.style.opacity = '0';
                    group.style.transition = 'opacity 0.3s ease-in-out';
                    setTimeout(() => {
                        group.style.display = 'none';
                        // รีเซ็ตค่าใน time_group เมื่อซ่อน
                        if (group === create_timeGroup) {
                            create_startHourTimeInput.value = '';
                            create_startMinuteTimeInput.value = '';
                            create_stopTimeInput.value = '';
                            create_durationSelect.value = '';
                            create_startHourTimeInput.disabled = false; // Enable start_time
                            create_startMinuteTimeInput.disabled = false; // Enable start_time
                        }
                    }, 300);
                }
            }
            // เมื่อกดปุ่ม "ทั้งวัน"
            create_leaveFullBtn.addEventListener('click', function () {
                resetCreateButtonStyles();
                create_leaveFullBtn.classList.add('active');
                create_toggleGroupDisplay(create_dateGroup, true);
                create_toggleGroupDisplay(create_timeGroup, false);
                //daysInput.disabled = false;
                create_daysInput.value = 1;
                create_stopDateInput.value = create_startDateInput.value;
                create_stopDateInput.disabled = false;

                //Check attachment_required
                create_type_duration = "Day";
                CheckCreateAttachFileRequire(create_type_duration);

                create_is_full_day = true;

            });
            // เมื่อกดปุ่ม "ครึ่งวัน"
            create_leaveHalfBtn.addEventListener('click', function () {
                resetCreateButtonStyles();
                create_leaveHalfBtn.classList.add('active');
                create_toggleGroupDisplay(create_dateGroup, true); // แสดง date_group
                create_toggleGroupDisplay(create_timeGroup, true); // แสดง time_group
                create_setHalfDayOptions(); // เปลี่ยนตัวเลือกเป็นครึ่งวันเช้า/บ่าย
                //daysInput.disabled = true; // DISABLE ลาจำนวน

                //Check attachment_required
                create_type_duration = "Half";
                CheckCreateAttachFileRequire(create_type_duration);

                create_is_full_day = false;
            });
            // เมื่อกดปุ่ม "รายชั่วโมง"
            create_leaveHoursBtn.addEventListener('click', function () {
                resetCreateButtonStyles();
                create_leaveHoursBtn.classList.add('active');
                create_toggleGroupDisplay(create_dateGroup, true); // แสดง date_group
                create_toggleGroupDisplay(create_timeGroup, true); // แสดง time_group
                create_setHourlyOptions(); // เปลี่ยนตัวเลือกเป็นรายชั่วโมง
                //daysInput.disabled = true; // DISABLE ลาจำนวน

                //Check attachment_required
                create_type_duration = "Hours";
                CheckCreateAttachFileRequire(create_type_duration);

                create_is_full_day = false;
            });

            //Stop date Change
            create_stopDateInput.addEventListener('change', function () {
                //Check attachment_required
                create_type_duration = "Day";
                CheckCreateAttachFileRequire(create_type_duration);
            });

        function CheckCreateAttachFileRequire(type_duration) {
            $('#create_btn_leave_send').prop('disabled', true);
            let leave_type_id = $('#create_select_leave_type').val();
            let _leave = create_leaves.filter(f => f.leave_type_id === leave_type_id).map(m => m)[0];
        
            if (type_duration == "Day") {
                if (create_startDateInput.value !== "" && create_stopDateInput.value !== "") {
                    let start = new Date(create_startDateInput.value);
                    let stop = new Date(create_stopDateInput.value);
                    let diffInDays = 0;
                    if (stop >= start) {
                        if (_leave.count_holidays_as_leave === true) {
                            diffInDays = getDaysBetween(start, stop, true);
                        } else {
                            diffInDays = getBusinessDays(start, stop, holidays);
                        }
                        if (create_balance_leave >= diffInDays) {
                            if (_leave.is_consecutive === true) {
                                if (_leave.max_consecutive_days >= diffInDays) {
                                    create_daysInput.value = diffInDays;
                                } else {
                                    alert(`ไม่สามารถลาเกิน ${_leave.max_consecutive_days} วัน`);
                                    create_daysInput.value = 1;
                                    create_stopDateInput.value = create_startDateInput.value;
                                }
                            } else {
                                create_daysInput.value = diffInDays;
                            }
                            $('#create_btn_leave_send').prop('disabled', false);
                        } else {
                            alert('วันลาไม่เพียงพอ');
                            create_daysInput.value = 1;
                            create_stopDateInput.value = create_startDateInput.value;
                            $('#create_btn_leave_send').prop('disabled', true);
                        }
                    } else {
                        alert('ใส่วันผิด');
                        create_daysInput.value = 1;
                        create_stopDateInput.value = create_startDateInput.value;
                    }
                    //Check attachment_required
                    if (_leave.attachment_required === true) {
                        if (diffInDays >= Number(_leave.attachment_threshold_days)) {
                            create_attachFileGroup.hidden = false;
                            create_file_require = true;
                        } else {
                            clearCreateAttachFile();
                        }
                    } else {
                        clearCreateAttachFile();
                    }
                }
            } else if (type_duration === "Half") {
                //Check attachment_required
                if (_leave.attachment_required === true) {
                    if (Number(_leave.attachment_threshold_days) === 0) {
                        create_attachFileGroup.hidden = false;
                        create_file_require = true;
                    } else {
                        clearCreateAttachFile();
                    }
                } else {
                    clearCreateAttachFile();
                }
            } else if (type_duration === "Hours") {
                //Check attachment_required
                if (_leave.attachment_required === true) {
                    if (Number(_leave.attachment_threshold_days) === 0) {
                        create_attachFileGroup.hidden = false;
                        create_file_require = true;
                    } else {
                        clearCreateAttachFile();
                    }
                } else {
                    clearCreateAttachFile();
                }
            }
        }
        function CheckCreateRequestTiming(request_date) {
            let leave_type_id = $('#create_select_leave_type').val();
            let leave = create_leaves.filter(f => f.leave_type_id === leave_type_id).map(m => m)[0];
            let date_now = new Date();
            let date_request = new Date(request_date);
            date_now.setHours(0, 0, 0, 0);
            date_request.setHours(0, 0, 0, 0);
            if (leave.request_timing === "Both") {
                return true;
            } else if (leave.request_timing === "Future") {
                if (date_request > date_now) {
                    return true;
                } else {
                    return false;
                }

            } else if (leave.request_timing === "Past") {
                if (date_request <= date_now) {
                    return true;
                } else {
                    return false;
                }
            }
        }
        function CheckCreateGenderRestriction(gender) {
            let leave_type_id = $('#create_select_leave_type').val();
            let leave = create_leaves.filter(f => f.leave_type_id === leave_type_id).map(m => m)[0];
            if (leave.gender_restriction === "Both") {
                return true;
            } else {
                if (leave.gender_restriction === create_gender) {
                    return true;
                } else {
                    return false;
                }
            }
        }

        function clearCreateAttachFile() {
            ClearCreateAttachFile();
            create_attachFileGroup.hidden = true;
            loadCreateExistingFiles([]);
            create_file_require = false;

        };
        async function ClearCreateAttachFile() {
            for (let i = 0; i < create_tempFileIds.length; i++) {
                try {
                    await fetch(`./Leave/DeleteTemp?tempId=${create_tempFileIds[i]}`, { method: 'DELETE' });
                } catch (err) {
                    console.error('ลบไฟล์ล้มเหลว', err);
                }
            }
            create_fileListContainer.innerHTML = '';
            create_tempFileIds = [];
        }

            function getDaysBetween(startDate, endDate, absolute = true) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffInMs = end - start;
                const diffInDays = diffInMs / (1000 * 60 * 60 * 24);
                const days = Math.floor(diffInDays) + 1;
                return absolute ? Math.abs(days) : days;
            }
            function getBusinessDays(startDate, endDate, holidays = []) {
                const start = new Date(startDate);
                const end = new Date(endDate);

                let count = 0;
                const current = new Date(start);

                const holidaySet = new Set(
                    holidays.map(date => {
                        const d = new Date(date);
                        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    })
                );

                while (current <= end) {
                    const dayOfWeek = current.getDay(); // 0 = Sun, 6 = Sat
                    const dateStr = current.toISOString().split('T')[0]; // YYYY-MM-DD
                    if (dayOfWeek !== 0 && dayOfWeek !== 6 && !holidaySet.has(dateStr)) {
                        count++;
                    }
                    current.setDate(current.getDate() + 1);
                }
                return count;
            }
 

            function calculateCreateTime() {
                let first = timeToMinutes("08:30");
                let last = timeToMinutes("17:30");
                let duration = parseInt(create_durationSelect.value);
                let start = create_startHourTimeInput.value + ':' + create_startMinuteTimeInput.value;
                if (timeToMinutes(start) >= first && timeToMinutes(start) <= last) {
                    let [hours, minutes] = start.split(':').map(Number);
                    let date = new Date(create_startDateInput.value);
                    date.setHours(hours);
                    date.setMinutes(minutes);
                    date.setSeconds(0);

                    date.setHours(date.getHours() + duration);

                    if (timeToMinutes(date.toTimeString().split(' ')[0]) <= last) {
                        const duration = $('#create_select_leave_hours_duration').val();

                        if (duration === 6) {
                            if (parseInt(startDateInput.value) <= 12 || (date.getHours() === 12 && date.getMinutes() > 0) || (date.getHours() > 12)) {
                                date.setHours(date.getHours() + 1);
                            }
                        } else {
                            if (parseInt(startDateInput.value) <= 12 || (date.getHours() === 12 && date.getMinutes() > 0)) {
                                date.setHours(date.getHours() + 1);
                            }
                        }

                        if (timeToMinutes(date.toTimeString().split(' ')[0]) <= last) {
                            let stopHours = String(date.getHours()).padStart(2, '0');
                            let stopMinutes = String(date.getMinutes()).padStart(2, '0');
                            let stopTime = `${stopHours}:${stopMinutes}`;
                            create_stopTimeInput.value = stopTime;
                        } else {
                            alert('ใส่เวลาผิด');
                            create_startHourTimeInput.value = '08';
                            create_startMinuteTimeInput.value = '30';
                            date.setHours(8);
                            date.setMinutes(30);
                            date.setHours(date.getHours() + duration);
                            let stopHours = String(date.getHours()).padStart(2, '0');
                            let stopMinutes = String(date.getMinutes()).padStart(2, '0');
                            let stopTime = `${stopHours}:${stopMinutes}`;
                            create_stopTimeInput.value = stopTime;
                        }
                    } else {
                        alert('ใส่เวลาผิด');
                        create_startHourTimeInput.value = '08';
                        create_startMinuteTimeInput.value = '30';
                        date.setHours(8);
                        date.setMinutes(30);
                        date.setHours(date.getHours() + duration);
                        let stopHours = String(date.getHours()).padStart(2, '0');
                        let stopMinutes = String(date.getMinutes()).padStart(2, '0');
                        let stopTime = `${stopHours}:${stopMinutes}`;
                        create_stopTimeInput.value = stopTime;
                    }
                } else {
                    alert('ใส่เวลาผิด');
                    create_startHourTimeInput.value = '08';
                    create_startMinuteTimeInput.value = '30';
                    let stopHours = String('08:30');
                    let stopMinutes = String('17:30');
                    let stopTime = `${stopHours}:${stopMinutes}`;
                    create_stopTimeInput.value = "";
                }
            }
            create_leaveFullBtn.click();


    if (!create_fileInput || !create_selectFileBtn || !create_uploadForm || !create_fileListContainer) {
            console.error('ไม่พบ element');
        }

        // === 1. เลือกไฟล์ ===
        create_selectFileBtn.addEventListener('click', (e) => {
            e.preventDefault();
            create_fileInput.click();
        });

        // === 2. Drag & Drop ===
        ['dragenter', 'dragover'].forEach(event => {
            create_uploadForm.addEventListener(event, (e) => {
                e.preventDefault();
                e.stopPropagation();
                create_uploadForm.classList.add('dragover');
            });
        });
        ['dragleave', 'drop'].forEach(event => {
            create_uploadForm.addEventListener(event, (e) => {
                e.preventDefault();
                e.stopPropagation();
                create_uploadForm.classList.remove('dragover');
                if (event === 'drop') handleCreateFiles(e.dataTransfer.files);
            });
        });

        // === 3. เมื่อเลือกไฟล์ ===
        create_fileInput.addEventListener('change', () => {
            handleCreateFiles(create_fileInput.files);
             create_fileInput.value = '';
        });

        async function handleCreateFiles(files) {
            if (!files || files.length === 0) return;

            for (let file of files) {
                const fileType = file.name.split('.').pop().toLowerCase();
                const allowedTypes = ['pdf', 'jpg', 'jpeg', 'png', 'xls', 'xlsx'];
                const maxSize = 10 * 1024 * 1024; // 10MB

                if (!allowedTypes.includes(fileType)) {
                    showAlert(`ประเภทไฟล์ไม่รองรับ: ${file.name}`);
                    continue;
                }
                if (file.size > maxSize) {
                    showAlert(`ไฟล์ใหญ่เกิน 10MB: ${file.name}`);
                    continue;
                }

                // อัปโหลดทันที
                const tempId = await uploadCreateFileToTemp(file);
                if (tempId) {
                    create_tempFileIds.push(tempId.tempId);
                    const fileItem = createCreateFileItem(file.name, fileType, tempId.tempId, tempId.previewUrl);
                    create_fileListContainer.appendChild(fileItem);
                    setTimeout(() => fileItem.classList.add('show'), 10);
                }
            }
        }

        // === 4. อัปโหลดไป backend (temp) ===
        async function uploadCreateFileToTemp(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('./Leave/UploadTempFile', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    return result; // backend ส่ง tempId กลับ
                } else {
                    const error = await response.text();
                    showAlert(`อัปโหลดล้มเหลว: ${error}`);
                    return null;
                }
            } catch (err) {
                showAlert(`เกิดข้อผิดพลาด: ${err.message}`);
                return null;
            }
        }

        // === 5. สร้าง UI ไฟล์ ===
        function createCreateFileItem(fileName, fileType, tempId, fileUrl) {
            const fileItem = document.createElement('div');
            fileItem.className = 'list-group-item d-flex align-items-center file-item added';
            fileItem.dataset.tempId = tempId;

            const viewLink = document.createElement('a');
            viewLink.href = fileUrl;
            viewLink.target = '_blank';
            viewLink.rel = 'noopener';
            viewLink.className = 'text-decoration-none flex-grow-1 d-flex align-items-center';
            viewLink.style.cursor = 'pointer';

            const iconClass = fileType === 'pdf'
                ? 'fas fa-file-pdf text-danger'
                : 'fas fa-file-image text-primary';

            viewLink.innerHTML = `
        <i class="${iconClass} mr-2"></i>
        <span class="kanit-regular text-dark">${fileName}</span>
    `;
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'btn btn-outline-danger btn-sm delete-btn ml-2';
            deleteBtn.dataset.tempId = tempId;
            deleteBtn.title = 'ลบ';
            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';

            fileItem.appendChild(viewLink);
            fileItem.appendChild(deleteBtn);

            return fileItem;
        }

        // === 6. ลบไฟล์ ===
        create_fileListContainer.addEventListener('click', async (e) => {
            const btn = e.target.closest('.delete-btn');
            if (!btn) return;

            const fileItem = btn.closest('.file-item');
            const tempId = btn.dataset.tempId;

            // ลบจาก backend
            try {
                await fetch(`./Leave/DeleteTemp?tempId=${tempId}`, { method: 'DELETE' });
            } catch (err) {
                console.error('ลบไฟล์ล้มเหลว', err);
            }

            // ลบจาก UI
            create_tempFileIds = create_tempFileIds.filter(id => id !== tempId);
            fileItem.classList.add('removing');
            setTimeout(() => fileItem.remove(), 300);
        });

        // === 7. โหลดไฟล์เก่า (ถ้ามี) ===
        function loadCreateExistingFiles(existingTempIds) {

            create_fileListContainer.innerHTML = '';
            create_tempFileIds = [];

            if (!Array.isArray(existingTempIds)) return;

            existingTempIds.forEach(async (tempId) => {

                const response = await fetch(`./Leave/GetTempFileInfo?tempId=${tempId}`);
                if (response.ok) {
                    const info = await response.json();
                    create_tempFileIds.push(tempId);
                    const fileItem = createCreateFileItem(info.fileName, info.fileType, tempId,"");
                    create_fileListContainer.appendChild(fileItem);
                    fileItem.classList.add('show');
                }
            });
        }

        function ModalCreateCloseClick() {
            clearCreateAttachFile();
        }

            //Alert
        function showAlert(message) {
            const modalAlert = document.getElementById('modal_alert');
            const alertContent = document.getElementById('alert_content');
            if (modalAlert && alertContent) {
                alertContent.innerHTML = `<p class="kanit-regular">${message}</p>`;
                $(modalAlert).modal('show');
            } else {
                alert(message);
            }
        }


        async function CreateGetLeaveType() {
            let emp_id = '@Html.Raw(Model.emp_id)';
            let now = new Date();
            let year = now.getFullYear();
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetLeaves", "Leave")',
	            contentType: 'application/x-www-form-urlencoded',
                data: {
                    emp_id,year
                },
                success: function (response) {
                    create_leaves = response.leaves;
                    CreateGenerateLeaveOption(create_leaves);
                }
            });
        }
        function CreateGenerateLeaveOption(leaves) {
            $('#create_select_leave_type').empty();
            $('#create_select_leave_type').append(`<option value="" selected disabled>Select</option>`);
            for (let i = 0; i < leaves.length; i++) {
                if (leaves[i].is_active) {
                    $('#create_select_leave_type').append(`<option value="${leaves[i].leave_type_id}">${leaves[i].leave_name_th}</option>`);
                }
            }
        }

        $('#create_btn_leave_send').on('click', async function () {
            let leave_type = $('#create_select_leave_type :selected').text();
            let date_start = formatDate(new Date($('#create_leave_start_date').val()));
            let date_stop = formatDate(new Date($('#create_leave_stop_date').val()));
            let hour_start = $('#create_leave_start_hour').val();
            let minute_start = $('#create_leave_start_minute').val();
            let time_stop = $('#create_leave_stop_time').val();
            let message = "";
            let year_start = new Date($('#create_leave_start_date').val()).getFullYear();
            let year_stop = new Date($('#create_leave_stop_date').val()).getFullYear();
            if (year_start === year_stop) {
                if (create_is_full_day) {
                    message = `${leave_type}
                        ลาตั้งแต่วันที่ ${date_start} - ${date_stop}`;
                } else {
                    message = `${leave_type}
                        ลาวันที่ ${date_start}
                        เวลา ${hour_start}:${minute_start} - ${time_stop}`;
                }

                $('#create_confirm_description').text(message);
                $('#modal_create_confirm').modal();
            } else {
                alert('ไม่สามารถลาข้ามปีได้');
            }
        });

        $('#create_confirm_ok').on('click', async function () {
            $('#create_confirm_ok').attr('disabled', true);
            $('#SpinModal').modal();
            let emp_id = '@Html.Raw(Model.emp_id)';
            let leave_type_id = $('#create_select_leave_type').val();
            let leave = create_leaves.filter(f => f.leave_type_id === leave_type_id).map(m => m)[0];
            let leave_type_code = leave.leave_type_code;
            let is_two_step_approve = leave.is_two_step_approve;
            let start_request_date = $('#create_leave_start_date').val();
            let end_request_date = $('#create_leave_stop_date').val();
            let description = $('#create_leave_note').val();
            let amount_leave_day = $('#create_amount_leave').val();

            let start_request_time = "00:00:00";
            let end_request_time = "00:00:00";
            if (!create_is_full_day) {
                let hour = $('#create_leave_start_hour').val();
                let minute = $('#create_leave_start_minute').val();
                start_request_time = hour + ":" + minute;
                end_request_time = $('#create_leave_stop_time').val();
            }

            let str = JSON.stringify({
                "emp_id": emp_id,
                "leave_type_id": leave_type_id,
                "leave_type_code": leave_type_code,
                "start_request_date": start_request_date,
                "end_request_date": end_request_date,
                "path_file": "",
                "status_request": "Pending",
                "description": description,
                "start_request_time": start_request_time,
                "end_request_time": end_request_time,
                "amount_leave_day": amount_leave_day,
                "is_two_step_approve": is_two_step_approve,
                "is_full_day": create_is_full_day,
                "amount_leave_hour": 0,
            });
            await $.ajax({
                type: "POST",
                url: '@Url.Action("CreateRequest", "Leave")',
                contentType: 'application/x-www-form-urlencoded',
                data: {
                    str, create_tempFileIds
                },
                success: function (response) {
                    if (response === "Success") {
                        alert("ส่งวันลาเรียบร้อย");
                        $('#modal_confirm').modal('hide');
                        $('#modal_leave').modal('hide');

                    } else {
                        alert(response);
                    }
                }
            });
            location.reload();
            $('#SpinModal').modal('hide');
            $('#confirm_ok').attr('disabled', false);
        });
        function CreateformatDate(date) {
            const daysThai = ['อา.', 'จ.', 'อ.', 'พ.', 'พฤ.', 'ศ.', 'ส.'];
            const dayOfWeek = daysThai[date.getDay()];
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${dayOfWeek} ${day}/${month}/${year}`;
        }


        function ExportToText() {
            const start = $('#date_start').val();
            const stop = $('#date_stop').val();
            location.href = '@Url.Action("ExportToText", "StatusLeave")?start='+ start + '&stop=' + stop;
        }
    </script>
   
}
